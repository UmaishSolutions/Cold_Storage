{% extends "templates/web.html" %}

{% block page_content %}
<script>
	!function (t, e) { "object" == typeof exports && "undefined" != typeof module ? module.exports = e() : "function" == typeof define && define.amd ? define(e) : (t = "undefined" != typeof globalThis ? globalThis : t || self)["frappe-charts"] = e() }(this, (function () { "use strict"; function t(e) { return (t = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (t) { return typeof t } : function (t) { return t && "function" == typeof Symbol && t.constructor === Symbol && t !== Symbol.prototype ? "symbol" : typeof t })(e) } function e(t, e) { if (!(t instanceof e)) throw new TypeError("Cannot call a class as a function") } function n(t, e) { for (var n = 0; n < e.length; n++) { var i = e[n]; i.enumerable = i.enumerable || !1, i.configurable = !0, "value" in i && (i.writable = !0), Object.defineProperty(t, i.key, i) } } function i(t, e, i) { return e && n(t.prototype, e), i && n(t, i), t } function a(t, e) { if ("function" != typeof e && null !== e) throw new TypeError("Super expression must either be null or a function"); t.prototype = Object.create(e && e.prototype, { constructor: { value: t, writable: !0, configurable: !0 } }), e && r(t, e) } function s(t) { return (s = Object.setPrototypeOf ? Object.getPrototypeOf : function (t) { return t.__proto__ || Object.getPrototypeOf(t) })(t) } function r(t, e) { return (r = Object.setPrototypeOf || function (t, e) { return t.__proto__ = e, t })(t, e) } function o(t, e) { return !e || "object" != typeof e && "function" != typeof e ? function (t) { if (void 0 === t) throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); return t }(t) : e } function l(t) { var e = function () { if ("undefined" == typeof Reflect || !Reflect.construct) return !1; if (Reflect.construct.sham) return !1; if ("function" == typeof Proxy) return !0; try { return Date.prototype.toString.call(Reflect.construct(Date, [], (function () { }))), !0 } catch (t) { return !1 } }(); return function () { var n, i = s(t); if (e) { var a = s(this).constructor; n = Reflect.construct(i, arguments, a) } else n = i.apply(this, arguments); return o(this, n) } } function c(t, e, n) { return (c = "undefined" != typeof Reflect && Reflect.get ? Reflect.get : function (t, e, n) { var i = function (t, e) { for (; !Object.prototype.hasOwnProperty.call(t, e) && null !== (t = s(t));); return t }(t, e); if (i) { var a = Object.getOwnPropertyDescriptor(i, e); return a.get ? a.get.call(n) : a.value } })(t, e, n || t) } function u(t, e) { return function (t) { if (Array.isArray(t)) return t }(t) || function (t, e) { if ("undefined" == typeof Symbol || !(Symbol.iterator in Object(t))) return; var n = [], i = !0, a = !1, s = void 0; try { for (var r, o = t[Symbol.iterator](); !(i = (r = o.next()).done) && (n.push(r.value), !e || n.length !== e); i = !0); } catch (t) { a = !0, s = t } finally { try { i || null == o.return || o.return() } finally { if (a) throw s } } return n }(t, e) || d(t, e) || function () { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.") }() } function h(t) { return function (t) { if (Array.isArray(t)) return f(t) }(t) || function (t) { if ("undefined" != typeof Symbol && Symbol.iterator in Object(t)) return Array.from(t) }(t) || d(t) || function () { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.") }() } function d(t, e) { if (t) { if ("string" == typeof t) return f(t, e); var n = Object.prototype.toString.call(t).slice(8, -1); return "Object" === n && t.constructor && (n = t.constructor.name), "Map" === n || "Set" === n ? Array.from(t) : "Arguments" === n || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n) ? f(t, e) : void 0 } } function f(t, e) { (null == e || e > t.length) && (e = t.length); for (var n = 0, i = new Array(e); n < e; n++)i[n] = t[n]; return i } function p(t, e) { return "string" == typeof t ? (e || document).querySelector(t) : t || null } function v(t) { var e = t.getBoundingClientRect(); return { top: e.top + (document.documentElement.scrollTop || document.body.scrollTop), left: e.left + (document.documentElement.scrollLeft || document.body.scrollLeft) } } function g(t) { return null === t.offsetParent } function m(t) { var e = t.getBoundingClientRect(); return e.top >= 0 && e.left >= 0 && e.bottom <= (window.innerHeight || document.documentElement.clientHeight) && e.right <= (window.innerWidth || document.documentElement.clientWidth) } p.create = function (e, n) { var i = document.createElement(e); for (var a in n) { var s = n[a]; if ("inside" === a) p(s).appendChild(i); else if ("around" === a) { var r = p(s); r.parentNode.insertBefore(i, r), i.appendChild(r) } else "styles" === a ? "object" === t(s) && Object.keys(s).map((function (t) { i.style[t] = s[t] })) : a in i ? i[a] = s : i.setAttribute(a, s) } return i }; var y = { margins: { top: 10, bottom: 10, left: 20, right: 20 }, paddings: { top: 20, bottom: 40, left: 30, right: 10 }, baseHeight: 240, titleHeight: 20, legendHeight: 30, titleFontSize: 12 }; function b(t) { return t.titleHeight + t.margins.top + t.paddings.top } function x(t) { return t.margins.left + t.paddings.left } function k(t) { return t.margins.top + t.margins.bottom + t.paddings.top + t.paddings.bottom + t.titleHeight + t.legendHeight } function w(t) { return t.margins.left + t.margins.right + t.paddings.left + t.paddings.right } var A = ["pink", "blue", "green", "grey", "red", "yellow", "purple", "teal", "cyan", "orange"], D = { bar: A, line: A, pie: A, percentage: A, heatmap: ["#ebedf0", "#c6e48b", "#7bc96f", "#239a3b", "#196127"], donut: A }, L = Math.PI / 180, P = function () { function t(n) { var i = n.parent, a = void 0 === i ? null : i, s = n.colors, r = void 0 === s ? [] : s; e(this, t), this.parent = a, this.colors = r, this.titleName = "", this.titleValue = "", this.listValues = [], this.titleValueFirst = 0, this.x = 0, this.y = 0, this.top = 0, this.left = 0, this.setup() } return i(t, [{ key: "setup", value: function () { this.makeTooltip() } }, { key: "refresh", value: function () { this.fill(), this.calcPosition() } }, { key: "makeTooltip", value: function () { var t = this; this.container = p.create("div", { inside: this.parent, className: "graph-svg-tip comparison", innerHTML: '<span class="title"></span>\n\t\t\t\t<ul class="data-point-list"></ul>\n\t\t\t\t<div class="svg-pointer"></div>' }), this.hideTip(), this.title = this.container.querySelector(".title"), this.list = this.container.querySelector(".data-point-list"), this.dataPointList = this.container.querySelector(".data-point-list"), this.parent.addEventListener("mouseleave", (function () { t.hideTip() })) } }, { key: "fill", value: function () { var t, e = this; this.index && this.container.setAttribute("data-point-index", this.index), t = this.titleValueFirst ? "<strong>".concat(this.titleValue, "</strong>").concat(this.titleName) : "".concat(this.titleName, "<strong>").concat(this.titleValue, "</strong>"), this.listValues.length > 4 ? this.list.classList.add("tooltip-grid") : this.list.classList.remove("tooltip-grid"), this.title.innerHTML = t, this.dataPointList.innerHTML = "", this.listValues.map((function (t, n) { var i = e.colors[n] || "black", a = 0 === t.formatted || t.formatted ? t.formatted : t.value, s = p.create("li", { innerHTML: '<div class="tooltip-legend" style="background: '.concat(i, ';"></div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class="tooltip-value">').concat(0 === a || a ? a : "", '</div>\n\t\t\t\t\t\t<div class="tooltip-label">').concat(t.title ? t.title : "", "</div>\n\t\t\t\t\t</div>") }); e.dataPointList.appendChild(s) })) } }, { key: "calcPosition", value: function () { var t = this.container.offsetWidth; this.top = this.y - this.container.offsetHeight - 7.48, this.left = this.x - t / 2; var e = this.parent.offsetWidth - t, n = this.container.querySelector(".svg-pointer"); if (this.left < 0) n.style.left = "calc(50% - ".concat(-1 * this.left, "px)"), this.left = 0; else if (this.left > e) { var i = this.left - e, a = "calc(50% + ".concat(i, "px)"); n.style.left = a, this.left = e } else n.style.left = "50%" } }, { key: "setValues", value: function (t, e) { var n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : {}, i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : [], a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : -1; this.titleName = n.name, this.titleValue = n.value, this.listValues = i, this.x = t, this.y = e, this.titleValueFirst = n.valueFirst || 0, this.index = a, this.refresh() } }, { key: "hideTip", value: function () { this.container.style.top = "0px", this.container.style.left = "0px", this.container.style.opacity = "0" } }, { key: "showTip", value: function () { this.container.style.top = this.top + "px", this.container.style.left = this.left + "px", this.container.style.opacity = "1" } }]), t }(); function M(t) { return parseFloat(t.toFixed(2)) } function T(t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] && arguments[3]; n || (n = i ? t[0] : t[t.length - 1]); var a = new Array(Math.abs(e)).fill(n); return t = i ? a.concat(t) : t.concat(a) } function C(t, e) { return (t + "").length * e } function N(t, e) { return { x: Math.sin(t * L) * e, y: Math.cos(t * L) * e } } function O(t) { var e = arguments.length > 1 && void 0 !== arguments[1] && arguments[1]; return !Number.isNaN(t) && (void 0 !== t && (!!Number.isFinite(t) && !(e && t < 0))) } function E(t) { return Number(Math.round(t + "e4") + "e-4") } function S(e) { var n, i, a; if (e instanceof Date) return new Date(e.getTime()); if ("object" !== t(e) || null === e) return e; for (a in n = Array.isArray(e) ? [] : {}, e) i = e[a], n[a] = S(i); return n } function F(t, e) { var n, i; return t <= e ? (n = e - t, i = t) : (n = t - e, i = e), [n, i] } function z(t, e) { var n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : e.length - t.length; return n > 0 ? t = T(t, n) : e = T(e, n), [t, e] } function R(t, e) { if (t) return t.length > e ? t.slice(0, e - 3) + "..." : t } function H(t) { var e; if ("number" == typeof t) e = t; else if ("string" == typeof t && (e = Number(t), Number.isNaN(e))) return t; var n = Math.floor(Math.log10(Math.abs(e))); if (n <= 2) return e; var i = Math.floor(n / 3), a = Math.pow(10, n - 3 * i) * +(e / Math.pow(10, n)).toFixed(1); return Math.round(100 * a) / 100 + ["", "K", "M", "B", "T"][i] } function W(t, e) { for (var n = [], i = (Math.min(t.length, e.length), 0); i < t.length; i++)n.push([t[i], e[i]]); var a = function (t, e, n, i) { var a, s, r, o, l = (a = e || t, r = (s = n || t)[0] - a[0], o = s[1] - a[1], { length: Math.sqrt(Math.pow(r, 2) + Math.pow(o, 2)), angle: Math.atan2(o, r) }), c = l.angle + (i ? Math.PI : 0), u = .2 * l.length; return [t[0] + Math.cos(c) * u, t[1] + Math.sin(c) * u] }; return function (t, e) { return t.reduce((function (t, n, i, a) { return 0 === i ? "".concat(n[0], ",").concat(n[1]) : "".concat(t, " ").concat(e(n, i, a)) }), "") }(n, (function (t, e, n) { var i = a(n[e - 1], n[e - 2], t), s = a(t, n[e - 1], n[e + 1], !0); return "C ".concat(i[0], ",").concat(i[1], " ").concat(s[0], ",").concat(s[1], " ").concat(t[0], ",").concat(t[1]) })) } function j(t, e) { return "string" == typeof t ? (e || document).querySelector(t) : t || null } function B(e, n) { var i = document.createElementNS("http://www.w3.org/2000/svg", e); for (var a in n) { var s = n[a]; if ("inside" === a) j(s).appendChild(i); else if ("around" === a) { var r = j(s); r.parentNode.insertBefore(i, r), i.appendChild(r) } else "styles" === a ? "object" === t(s) && Object.keys(s).map((function (t) { i.style[t] = s[t] })) : ("className" === a && (a = "class"), "innerHTML" === a ? i.textContent = s : i.setAttribute(a, s)) } return i } function I(t, e) { return B("linearGradient", { inside: t, id: e, x1: 0, x2: 0, y1: 0, y2: 1 }) } function Y(t, e, n, i) { return B("stop", { inside: t, style: "stop-color: ".concat(n), offset: e, "stop-opacity": i }) } function V(t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : "", n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : void 0, i = { className: t, transform: e }; return n && (i.inside = n), B("g", i) } function U(t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : "", n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : "none", i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : "none", a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 2; return B("path", { className: e, d: t, styles: { stroke: n, fill: i, "stroke-width": a } }) } function _(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 1, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = n.x + t.x, o = n.y + t.y, l = n.x + e.x, c = n.y + e.y; return "M".concat(n.x, " ").concat(n.y, "\n\t\tL").concat(r, " ").concat(o, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(c, " z") } function q(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 1, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = n.x + t.x, o = n.y + t.y, l = n.x + e.x, c = 2 * n.y, u = n.y + e.y; return "M".concat(n.x, " ").concat(n.y, "\n\t\tL").concat(r, " ").concat(o, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(c, " z\n\t\tL").concat(r, " ").concat(c, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(u, " z") } function G(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 1, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = n.x + t.x, o = n.y + t.y, l = n.x + e.x, c = n.y + e.y; return "M".concat(r, " ").concat(o, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(c) } function X(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 1, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = n.x + t.x, o = n.y + t.y, l = n.x + e.x, c = 2 * i + o, u = n.y + t.y; return "M".concat(r, " ").concat(o, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(c, "\n\t\tM").concat(r, " ").concat(c, "\n\t\tA ").concat(i, " ").concat(i, " 0 ").concat(s, " ").concat(a ? 1 : 0, "\n\t\t").concat(l, " ").concat(u) } function J(t, e) { var n = arguments.length > 2 && void 0 !== arguments[2] && arguments[2], i = "path-fill-gradient-" + e + "-" + (n ? "lighter" : "default"), a = I(t, i), s = [1, .6, .2]; return n && (s = [.15, .05, 0]), Y(a, "0%", e, s[0]), Y(a, "50%", e, s[1]), Y(a, "100%", e, s[2]), i } function K(t, e, n) { var i = n / 2, a = e - i; return "M".concat(t, ",0 h").concat(a, " q").concat(i, ",0 ").concat(i, ",").concat(i, " q0,").concat(i, " -").concat(i, ",").concat(i, " h-").concat(a, " v").concat(n, "z") } function $(t, e, n) { var i = n / 2, a = e - i; return "M".concat(t + i, ",0 h").concat(a, " v").concat(n, " h-").concat(a, " q-").concat(i, ", 0 -").concat(i, ",-").concat(i, " q0,-").concat(i, " ").concat(i, ",-").concat(i, "z") } function Q(t, e, n, i, a) { var s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : "none", r = arguments.length > 6 && void 0 !== arguments[6] ? arguments[6] : {}, o = { className: t, x: e, y: n, width: i, height: i, rx: a, fill: s }; return Object.keys(r).map((function (t) { o[t] = r[t] })), B("rect", o) } function Z(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : "none", s = arguments.length > 5 ? arguments[5] : void 0, r = arguments.length > 6 ? arguments[6] : void 0, o = arguments.length > 7 && void 0 !== arguments[7] ? arguments[7] : null, l = arguments.length > 8 && void 0 !== arguments[8] && arguments[8]; o || (o = 10); var c = { className: "legend-dot", x: 0, y: 4 - n, height: n, width: n, rx: i, fill: a }, u = B("text", { className: "legend-dataset-label", x: n, y: 0, dx: o + "px", dy: o / 3 + "px", "font-size": 1.6 * o + "px", "text-anchor": "start", innerHTML: s = l ? R(s, 18) : s }), h = null; r && (h = B("text", { className: "legend-dataset-value", x: n, y: 20, dx: "10px", dy: 10 / 3 + "px", "font-size": "12px", "text-anchor": "start", innerHTML: r })); var d = B("g", { transform: "translate(".concat(t, ", ").concat(e, ")") }); return d.appendChild(B("rect", c)), d.appendChild(u), r && h && d.appendChild(h), d } function tt(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : {}, s = a.fontSize || 10, r = void 0 !== a.dy ? a.dy : s / 2, o = a.fill || "var(--charts-label-color)", l = a.textAnchor || "start"; return B("text", { className: t, x: e, y: n, dy: r + "px", "font-size": s + "px", fill: o, "text-anchor": l, innerHTML: i }) } function et(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : {}, s = B("line", { className: "line-vertical " + a.className, x1: 0, x2: 0, y1: n, y2: i, styles: { stroke: a.stroke } }), r = B("text", { x: 0, y: n > i ? n + 4 : n - 4 - 10, dy: "10px", "font-size": "10px", "text-anchor": "middle", innerHTML: e + "" }), o = B("g", { transform: "translate(".concat(t, ", 0)") }); return o.appendChild(s), o.appendChild(r), o } function nt(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : {}; a.lineType || (a.lineType = ""), a.shortenNumbers && (e = a.numberFormatter ? a.numberFormatter(e) : H(e)); var s = "line-horizontal " + a.className + ("dashed" === a.lineType ? "dashed" : ""), r = B("line", { className: s, x1: n, x2: i, y1: 0, y2: 0, styles: { stroke: a.stroke } }), o = B("text", { x: n < i ? n - 4 : n + 4, y: 0, dy: "3px", "font-size": "10px", "text-anchor": n < i ? "end" : "start", innerHTML: e + "" }), l = B("g", { transform: "translate(0, ".concat(t, ")"), "stroke-opacity": 1 }); return 0 !== o && "0" !== o || (l.style.stroke = "rgba(27, 31, 35, 0.6)"), l.appendChild(r), l.appendChild(o), l } function it(t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : "", s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = arguments.length > 6 && void 0 !== arguments[6] && arguments[6], o = B("circle", { style: "fill: ".concat(i, "; ").concat(r ? "stroke: ".concat(i) : ""), "data-point-index": s, cx: t, cy: e, r: n }); if ((a += "") || a.length) { o.setAttribute("cy", 0), o.setAttribute("cx", 0); var l = B("text", { className: "data-point-value", x: 0, y: 0, dy: -5 - n + "px", "font-size": "10px", "text-anchor": "middle", innerHTML: a }), c = B("g", { "data-point-index": s, transform: "translate(".concat(t, ", ").concat(e, ")") }); return c.appendChild(o), c.appendChild(l), c } return o } var at = { bar: function (t) { var e; "rect" !== t.nodeName && (e = t.getAttribute("transform"), t = t.childNodes[0]); var n = t.cloneNode(); return n.style.fill = "#000000", n.style.opacity = "0.4", e && n.setAttribute("transform", e), n }, dot: function (t) { var e; "circle" !== t.nodeName && (e = t.getAttribute("transform"), t = t.childNodes[0]); var n = t.cloneNode(), i = t.getAttribute("r"), a = t.getAttribute("fill"); return n.setAttribute("r", parseInt(i) + 4), n.setAttribute("fill", a), n.style.opacity = "0.6", e && n.setAttribute("transform", e), n }, heat_square: function (t) { var e; "circle" !== t.nodeName && (e = t.getAttribute("transform"), t = t.childNodes[0]); var n = t.cloneNode(), i = t.getAttribute("r"), a = t.getAttribute("fill"); return n.setAttribute("r", parseInt(i) + 4), n.setAttribute("fill", a), n.style.opacity = "0.6", e && n.setAttribute("transform", e), n } }, st = { bar: function (t, e) { var n; "rect" !== t.nodeName && (n = t.getAttribute("transform"), t = t.childNodes[0]); var i = ["x", "y", "width", "height"]; Object.values(t.attributes).filter((function (t) { return i.includes(t.name) && t.specified })).map((function (t) { e.setAttribute(t.name, t.nodeValue) })), n && e.setAttribute("transform", n) }, dot: function (t, e) { var n; "circle" !== t.nodeName && (n = t.getAttribute("transform"), t = t.childNodes[0]); var i = ["cx", "cy"]; Object.values(t.attributes).filter((function (t) { return i.includes(t.name) && t.specified })).map((function (t) { e.setAttribute(t.name, t.nodeValue) })), n && e.setAttribute("transform", n) }, heat_square: function (t, e) { var n; "circle" !== t.nodeName && (n = t.getAttribute("transform"), t = t.childNodes[0]); var i = ["cx", "cy"]; Object.values(t.attributes).filter((function (t) { return i.includes(t.name) && t.specified })).map((function (t) { e.setAttribute(t.name, t.nodeValue) })), n && e.setAttribute("transform", n) } }, rt = { pink: "#F683AE", blue: "#318AD8", green: "#48BB74", grey: "#A6B1B9", red: "#F56B6B", yellow: "#FACF7A", purple: "#44427B", teal: "#5FD8C4", cyan: "#15CCEF", orange: "#F8814F", "light-pink": "#FED7E5", "light-blue": "#BFDDF7", "light-green": "#48BB74", "light-grey": "#F4F5F6", "light-red": "#F6DFDF", "light-yellow": "#FEE9BF", "light-purple": "#E8E8F7", "light-teal": "#D3FDF6", "light-cyan": "#DDF8FD", "light-orange": "#FECDB8" }; function ot(t, e, n, i) { var a = "string" == typeof e ? e : e.join(", "); return [t, { transform: n.join(", ") }, i, "easein", "translate", { transform: a }] } function lt(t, e, n) { return ot(t, [0, n], [0, e], 350) } function ct(t, e) { return [t, { d: e }, 350, "easein"] } var ut = { ease: "0.25 0.1 0.25 1", linear: "0 0 1 1", easein: "0.1 0.8 0.2 1", easeout: "0 0 0.58 1", easeinout: "0.42 0 0.58 1" }; function ht(t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : "linear", a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : void 0, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : {}, r = t.cloneNode(!0), o = t.cloneNode(!0); for (var l in e) { var c = void 0; c = "transform" === l ? document.createElementNS("http://www.w3.org/2000/svg", "animateTransform") : document.createElementNS("http://www.w3.org/2000/svg", "animate"); var u = s[l] || t.getAttribute(l), h = e[l], d = { attributeName: l, from: u, to: h, begin: "0s", dur: n / 1e3 + "s", values: u + ";" + h, keySplines: ut[i], keyTimes: "0;1", calcMode: "spline", fill: "freeze" }; for (var f in a && (d.type = a), d) c.setAttribute(f, d[f]); r.appendChild(c), a ? o.setAttribute(l, "translate(".concat(h, ")")) : o.setAttribute(l, h) } return [r, o] } function dt(t, e) { t.style.transform = e, t.style.webkitTransform = e, t.style.msTransform = e, t.style.mozTransform = e, t.style.oTransform = e } function ft(t, e) { var n = [], i = []; e.map((function (t) { var e, a, s = t[0], r = s.parentNode; t[0] = s; var o = u(ht.apply(void 0, h(t)), 2); e = o[0], a = o[1], n.push(a), i.push([e, r]), r.replaceChild(e, s) })); var a = t.cloneNode(!0); return i.map((function (t, i) { t[1].replaceChild(n[i], t[0]), e[i][0] = n[i] })), a } function pt(t, e, n) { if (0 !== n.length) { var i = ft(e, n); e.parentNode == t && (t.removeChild(e), t.appendChild(i)), setTimeout((function () { i.parentNode == t && (t.removeChild(i), t.appendChild(e)) }), 250) } } var vt = function () { function t(n, i) { if (e(this, t), i = S(i), this.parent = "string" == typeof n ? document.querySelector(n) : n, !(this.parent instanceof HTMLElement)) throw new Error("No `parent` element to render on was provided."); this.rawChartArgs = i, this.title = i.title || "", this.type = i.type || "", this.realData = this.prepareData(i.data), this.data = this.prepareFirstData(this.realData), this.colors = this.validateColors(i.colors, this.type), this.config = { showTooltip: 1, showLegend: void 0 !== i.showLegend ? i.showLegend : 1, isNavigable: i.isNavigable || 0, animate: void 0 !== i.animate ? i.animate : 1, disableEntryAnimation: i.disableEntryAnimation || 0, truncateLegends: void 0 !== i.truncateLegends ? i.truncateLegends : 1 }, this.measures = JSON.parse(JSON.stringify(y)); var a = this.measures; this.setMeasures(i), this.title.length || (a.titleHeight = 0), this.config.showLegend || (a.legendHeight = 0), this.argHeight = i.height || a.baseHeight, this.state = {}, this.options = {}, this.initTimeout = 700, this.config.isNavigable && (this.overlays = []), this.configure(i) } return i(t, [{ key: "prepareData", value: function (t) { return t } }, { key: "prepareFirstData", value: function (t) { return t } }, { key: "validateColors", value: function (t, e) { var n = []; return (t = (t || []).concat(D[e])).forEach((function (t) { var e = function (t) { return /rgb[a]{0,1}\([\d, ]+\)/gim.test(t) ? /\D+(\d*)\D+(\d*)\D+(\d*)/gim.exec(t).map((function (t, e) { return 0 !== e ? Number(t).toString(16) : "#" })).reduce((function (t, e) { return "".concat(t).concat(e) })) : rt[t] || t }(t); !function (t) { return /(^\s*)(#)((?:[A-Fa-f0-9]{3}){1,2})$/i.test(t) || /(^\s*)(rgb|hsl)(a?)[(]\s*([\d.]+\s*%?)\s*,\s*([\d.]+\s*%?)\s*,\s*([\d.]+\s*%?)\s*(?:,\s*([\d.]+)\s*)?[)]$/i.test(t) }(e) ? console.warn('"' + t + '" is not a valid color.') : n.push(e) })), n } }, { key: "setMeasures", value: function () { } }, { key: "configure", value: function () { var t = this, e = this.argHeight; this.baseHeight = e, this.height = e - k(this.measures), this.boundDrawFn = function () { return t.draw(!0) }, ResizeObserver && (this.resizeObserver = new ResizeObserver(this.boundDrawFn), this.resizeObserver.observe(this.parent)), window.addEventListener("resize", this.boundDrawFn), window.addEventListener("orientationchange", this.boundDrawFn) } }, { key: "destroy", value: function () { this.resizeObserver && this.resizeObserver.disconnect(), window.removeEventListener("resize", this.boundDrawFn), window.removeEventListener("orientationchange", this.boundDrawFn) } }, { key: "setup", value: function () { this.makeContainer(), this.updateWidth(), this.makeTooltip(), this.draw(!1, !0) } }, { key: "makeContainer", value: function () { this.parent.innerHTML = ""; var t = { inside: this.parent, className: "chart-container" }; this.independentWidth && (t.styles = { width: this.independentWidth + "px" }), this.container = p.create("div", t) } }, { key: "makeTooltip", value: function () { this.tip = new P({ parent: this.container, colors: this.colors }), this.bindTooltip() } }, { key: "bindTooltip", value: function () { } }, { key: "draw", value: function () { var t = this, e = arguments.length > 0 && void 0 !== arguments[0] && arguments[0], n = arguments.length > 1 && void 0 !== arguments[1] && arguments[1]; e && g(this.parent) || (this.updateWidth(), this.calc(e), this.makeChartArea(), this.setupComponents(), this.components.forEach((function (e) { return e.setup(t.drawArea) })), this.render(this.components, !1), n && (this.data = this.realData, setTimeout((function () { t.update(t.data, !0) }), this.initTimeout)), this.config.showLegend && this.renderLegend(), this.setupNavigation(n)) } }, { key: "calc", value: function () { } }, { key: "updateWidth", value: function () { var t, e, n; this.baseWidth = (t = this.parent, e = window.getComputedStyle(t), n = parseFloat(e.paddingLeft) + parseFloat(e.paddingRight), t.clientWidth - n), this.width = this.baseWidth - w(this.measures) } }, { key: "makeChartArea", value: function () { this.svg && this.container.removeChild(this.svg); var t, e, n, i, a = this.measures; this.svg = (t = this.container, e = "frappe-chart chart", n = this.baseWidth, i = this.baseHeight, B("svg", { className: e, inside: t, width: n, height: i })), this.svgDefs = B("defs", { inside: this.svg }), this.title.length && (this.titleEL = tt("title", a.margins.left, a.margins.top, this.title, { fontSize: a.titleFontSize, fill: "#666666", dy: a.titleFontSize })); var s = b(a); this.drawArea = V(this.type + "-chart chart-draw-area", "translate(".concat(x(a), ", ").concat(s, ")")), this.config.showLegend && (s += this.height + a.paddings.bottom, this.legendArea = V("chart-legend", "translate(".concat(x(a), ", ").concat(s, ")"))), this.title.length && this.svg.appendChild(this.titleEL), this.svg.appendChild(this.drawArea), this.config.showLegend && this.svg.appendChild(this.legendArea), this.updateTipOffset(x(a), b(a)) } }, { key: "updateTipOffset", value: function (t, e) { this.tip.offset = { x: t, y: e } } }, { key: "setupComponents", value: function () { this.components = new Map } }, { key: "update", value: function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] && arguments[1]; t || console.error("No data to update."), e || (t = S(t)); var n = e ? !this.config.disableEntryAnimation : this.config.animate; this.data = this.prepareData(t), this.calc(), this.render(this.components, n) } }, { key: "render", value: function () { var t = this, e = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.components, n = !(arguments.length > 1 && void 0 !== arguments[1]) || arguments[1]; this.config.isNavigable && this.overlays.map((function (t) { return t.parentNode.removeChild(t) })); var i = []; e.forEach((function (t) { i = i.concat(t.update(n)) })), i.length > 0 ? (pt(this.container, this.svg, i), setTimeout((function () { e.forEach((function (t) { return t.make() })), t.updateNav() }), 400)) : (e.forEach((function (t) { return t.make() })), this.updateNav()) } }, { key: "updateNav", value: function () { this.config.isNavigable && (this.makeOverlay(), this.bindUnits()) } }, { key: "renderLegend", value: function (t) { var e = this; this.legendArea.textContent = ""; var n = 0, i = 0; t.map((function (t, a) { var s = Math.floor(e.width / 150); n > s && (n = 0, i += e.config.legendRowHeight); var r = 150 * n, o = e.makeLegend(t, a, r, i); e.legendArea.appendChild(o), n++ })) } }, { key: "makeLegend", value: function () { } }, { key: "setupNavigation", value: function () { var t = this, e = arguments.length > 0 && void 0 !== arguments[0] && arguments[0]; this.config.isNavigable && e && (this.bindOverlay(), this.keyActions = { 13: this.onEnterKey.bind(this), 37: this.onLeftArrow.bind(this), 38: this.onUpArrow.bind(this), 39: this.onRightArrow.bind(this), 40: this.onDownArrow.bind(this) }, document.addEventListener("keydown", (function (e) { m(t.container) && (e = e || window.event, t.keyActions[e.keyCode] && t.keyActions[e.keyCode]()) }))) } }, { key: "makeOverlay", value: function () { } }, { key: "updateOverlay", value: function () { } }, { key: "bindOverlay", value: function () { } }, { key: "bindUnits", value: function () { } }, { key: "onLeftArrow", value: function () { } }, { key: "onRightArrow", value: function () { } }, { key: "onUpArrow", value: function () { } }, { key: "onDownArrow", value: function () { } }, { key: "onEnterKey", value: function () { } }, { key: "addDataPoint", value: function () { } }, { key: "removeDataPoint", value: function () { } }, { key: "getDataPoint", value: function () { } }, { key: "setCurrentDataPoint", value: function () { } }, { key: "updateDataset", value: function () { } }, { key: "export", value: function () { var t = function (t) { var e = t.cloneNode(!0); e.classList.add("chart-container"), e.setAttribute("xmlns", "http://www.w3.org/2000/svg"), e.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink"); var n = p.create("style", { innerHTML: ".chart-container{position:relative;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif}.chart-container .axis,.chart-container .chart-label{fill:#555b51}.chart-container .axis line,.chart-container .chart-label line{stroke:#dadada}.chart-container .dataset-units circle{stroke:#fff;stroke-width:2}.chart-container .dataset-units path{fill:none;stroke-opacity:1;stroke-width:2px}.chart-container .dataset-path{stroke-width:2px}.chart-container .path-group path{fill:none;stroke-opacity:1;stroke-width:2px}.chart-container line.dashed{stroke-dasharray:5,3}.chart-container .axis-line .specific-value{text-anchor:start}.chart-container .axis-line .y-line{text-anchor:end}.chart-container .axis-line .x-line{text-anchor:middle}.chart-container .legend-dataset-text{fill:#6c7680;font-weight:600}.graph-svg-tip{position:absolute;z-index:99999;padding:10px;font-size:12px;color:#959da5;text-align:center;background:rgba(0,0,0,.8);border-radius:3px}.graph-svg-tip ul{padding-left:0;display:flex}.graph-svg-tip ol{padding-left:0;display:flex}.graph-svg-tip ul.data-point-list li{min-width:90px;flex:1;font-weight:600}.graph-svg-tip strong{color:#dfe2e5;font-weight:600}.graph-svg-tip .svg-pointer{position:absolute;height:5px;margin:0 0 0 -5px;content:' ';border:5px solid transparent;}.graph-svg-tip.comparison{padding:0;text-align:left;pointer-events:none}.graph-svg-tip.comparison .title{display:block;padding:10px;margin:0;font-weight:600;line-height:1;pointer-events:none}.graph-svg-tip.comparison ul{margin:0;white-space:nowrap;list-style:none}.graph-svg-tip.comparison li{display:inline-block;padding:5px 10px}" }); e.insertBefore(n, e.firstChild); var i = p.create("div"); return i.appendChild(e), i.innerHTML }(this.svg); !function (t, e) { var n = document.createElement("a"); n.style = "display: none"; var i = new Blob(e, { type: "image/svg+xml; charset=utf-8" }), a = window.URL.createObjectURL(i); n.href = a, n.download = t, document.body.appendChild(n), n.click(), setTimeout((function () { document.body.removeChild(n), window.URL.revokeObjectURL(a) }), 300) }(this.title || "Chart", [t]) } }]), t }(), gt = function (t) { a(r, t); var n = l(r); function r(t, i) { return e(this, r), n.call(this, t, i) } return i(r, [{ key: "configure", value: function (t) { c(s(r.prototype), "configure", this).call(this, t), this.config.formatTooltipY = (t.tooltipOptions || {}).formatTooltipY, this.config.maxSlices = t.maxSlices || 20, this.config.maxLegendPoints = t.maxLegendPoints || 20, this.config.legendRowHeight = 60 } }, { key: "calc", value: function () { var t = this, e = this.state, n = this.config.maxSlices; e.sliceTotals = []; var i = this.data.labels.map((function (e, n) { var i = 0; return t.data.datasets.map((function (t) { i += t.values[n] })), [i, e] })).filter((function (t) { return t[0] >= 0 })), a = i; if (i.length > n) { i.sort((function (t, e) { return e[0] - t[0] })), a = i.slice(0, n - 1); var s = i.slice(n - 1), r = 0; s.map((function (t) { r += t[0] })), a.push([r, "Rest"]), this.colors[n - 1] = "grey" } e.labels = [], a.map((function (t) { e.sliceTotals.push(E(t[0])), e.labels.push(t[1]) })), e.grandTotal = e.sliceTotals.reduce((function (t, e) { return t + e }), 0), this.center = { x: this.width / 2, y: this.height / 2 } } }, { key: "renderLegend", value: function () { var t = this.state; this.legendArea.textContent = "", this.legendTotals = t.sliceTotals.slice(0, this.config.maxLegendPoints), c(s(r.prototype), "renderLegend", this).call(this, this.legendTotals) } }, { key: "makeLegend", value: function (t, e, n, i) { var a = this.config.formatTooltipY ? this.config.formatTooltipY(t) : t; return Z(n, i, 12, 3, this.colors[e], this.state.labels[e], a, null, this.config.truncateLegends) } }]), r }(vt), mt = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"], yt = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]; function bt(t) { var e = new Date(t); return e.setMinutes(e.getMinutes() - e.getTimezoneOffset()), e } function xt(t) { var e = t.getDate(), n = t.getMonth() + 1; return [t.getFullYear(), (n > 9 ? "" : "0") + n, (e > 9 ? "" : "0") + e].join("-") } function kt(t) { return new Date(t.getTime()) } function wt(t, e) { var n = Pt(t); return Math.ceil(function (t, e) { return (bt(e) - bt(t)) / 864e5 }(n, e) / 7) } function At(t, e) { return t.getMonth() === e.getMonth() && t.getFullYear() === e.getFullYear() } function Dt(t) { var e = arguments.length > 1 && void 0 !== arguments[1] && arguments[1], n = mt[t]; return e ? n.slice(0, 3) : n } function Lt(t, e) { return new Date(e, t + 1, 0) } function Pt(t) { var e = kt(t), n = e.getDay(); return 0 !== n && Mt(e, -1 * n), e } function Mt(t, e) { t.setDate(t.getDate() + e) } var Tt = function () { function t(n) { var i = n.layerClass, a = void 0 === i ? "" : i, s = n.layerTransform, r = void 0 === s ? "" : s, o = n.constants, l = n.getData, c = n.makeElements, u = n.animateElements; e(this, t), this.layerTransform = r, this.constants = o, this.makeElements = c, this.getData = l, this.animateElements = u, this.store = [], this.labels = [], this.layerClass = a, this.layerClass = "function" == typeof this.layerClass ? this.layerClass() : this.layerClass, this.refresh() } return i(t, [{ key: "refresh", value: function (t) { this.data = t || this.getData() } }, { key: "setup", value: function (t) { this.layer = V(this.layerClass, this.layerTransform, t) } }, { key: "make", value: function () { this.render(this.data), this.oldData = this.data } }, { key: "render", value: function (t) { var e = this; this.store = this.makeElements(t), this.layer.textContent = "", this.store.forEach((function (t) { e.layer.appendChild(t) })), this.labels.forEach((function (t) { e.layer.appendChild(t) })) } }, { key: "update", value: function () { var t = !(arguments.length > 0 && void 0 !== arguments[0]) || arguments[0]; this.refresh(); var e = []; return t && (e = this.animateElements(this.data) || []), e } }]), t }(), Ct = { donutSlices: { layerClass: "donut-slices", makeElements: function (t) { return t.sliceStrings.map((function (e, n) { var i = U(e, "donut-path", t.colors[n], "none", t.strokeWidth); return i.style.transition = "transform .3s;", i })) }, animateElements: function (t) { return this.store.map((function (e, n) { return ct(e, t.sliceStrings[n]) })) } }, pieSlices: { layerClass: "pie-slices", makeElements: function (t) { return t.sliceStrings.map((function (e, n) { var i = U(e, "pie-path", "none", t.colors[n]); return i.style.transition = "transform .3s;", i })) }, animateElements: function (t) { return this.store.map((function (e, n) { return ct(e, t.sliceStrings[n]) })) } }, percentageBars: { layerClass: "percentage-bars", makeElements: function (t) { var e = this, n = t.xPositions.length; return t.xPositions.map((function (i, a) { var s = a == n - 1, r = 0 == a; return function (t, e, n, i, a, s) { var r = arguments.length > 6 && void 0 !== arguments[6] ? arguments[6] : "none"; if (s) { var o = K(t, n, i); return U(o, "percentage-bar", null, r) } if (a) { var l = $(t, n, i); return U(l, "percentage-bar", null, r) } var c = { className: "percentage-bar", x: t, y: e, width: n, height: i, fill: r }; return B("rect", c) }(i, 0, t.widths[a], e.constants.barHeight, r, s, t.colors[a]) })) }, animateElements: function (t) { if (t) return [] } }, yAxis: { layerClass: "y axis", makeElements: function (t) { var e = this; return t.positions.map((function (n, i) { return function (t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : {}; O(t) || (t = 0), i.pos || (i.pos = "left"), i.offset || (i.offset = 0), i.mode || (i.mode = "span"), i.stroke || (i.stroke = "#E2E6E9"), i.className || (i.className = ""); var a = -6, s = "span" === i.mode ? n + 6 : 0; return "tick" === i.mode && "right" === i.pos && (a = n + 6, s = n), a += i.offset, s += i.offset, "number" == typeof e && (e = E(e)), nt(t, e, a, s, { className: i.className, lineType: i.lineType, shortenNumbers: i.shortenNumbers, numberFormatter: i.numberFormatter }) }(n, t.labels[i], e.constants.width, { mode: e.constants.mode, pos: e.constants.pos, shortenNumbers: e.constants.shortenNumbers, numberFormatter: e.constants.numberFormatter }) })) }, animateElements: function (t) { var e = t.positions, n = t.labels, i = this.oldData.positions, a = this.oldData.labels, s = u(z(i, e), 2); i = s[0], e = s[1]; var r = u(z(a, n), 2); return a = r[0], n = r[1], this.render({ positions: i, labels: n }), this.store.map((function (t, n) { return lt(t, e[n], i[n]) })) } }, xAxis: { layerClass: "x axis", makeElements: function (t) { var e = this; return t.positions.map((function (n, i) { return function (t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : {}; O(t) || (t = 0), i.pos || (i.pos = "bottom"), i.offset || (i.offset = 0), i.mode || (i.mode = "span"), i.className || (i.className = ""); var a = n + 6, s = "span" === i.mode ? -6 : n; return "tick" === i.mode && "top" === i.pos && (a = -6, s = 0), et(t, e, a, s, { className: i.className, lineType: i.lineType }) }(n, t.calcLabels[i], e.constants.height, { mode: e.constants.mode, pos: e.constants.pos }) })) }, animateElements: function (t) { var e = t.positions, n = t.calcLabels, i = this.oldData.positions, a = this.oldData.calcLabels, s = u(z(i, e), 2); i = s[0], e = s[1]; var r = u(z(a, n), 2); return a = r[0], n = r[1], this.render({ positions: i, calcLabels: n }), this.store.map((function (t, n) { return function (t, e, n) { return ot(t, [n, 0], [e, 0], 350) }(t, e[n], i[n]) })) } }, yMarkers: { layerClass: "y-markers", makeElements: function (t) { var e = this; return t.map((function (t) { return function (t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : {}; O(t) || (t = 0), i.labelPos || (i.labelPos = "right"), i.lineType || (i.lineType = "dashed"); var a = "left" === i.labelPos ? 4 : n - C(e, 5) - 4, s = B("text", { className: "chart-label", x: a, y: 0, dy: "-5px", "font-size": "10px", "text-anchor": "start", innerHTML: e + "" }), r = nt(t, "", 0, n, { stroke: i.stroke || "#E2E6E9", className: i.className || "", lineType: i.lineType }); return r.appendChild(s), r }(t.position, t.label, e.constants.width, { labelPos: t.options.labelPos, stroke: t.options.stroke, mode: "span", lineType: t.options.lineType }) })) }, animateElements: function (t) { var e = u(z(this.oldData, t), 2); this.oldData = e[0]; var n = (t = e[1]).map((function (t) { return t.position })), i = t.map((function (t) { return t.label })), a = t.map((function (t) { return t.options })), s = this.oldData.map((function (t) { return t.position })); return this.render(s.map((function (t, e) { return { position: s[e], label: i[e], options: a[e] } }))), this.store.map((function (t, e) { return lt(t, n[e], s[e]) })) } }, yRegions: { layerClass: "y-regions", makeElements: function (t) { var e = this; return t.map((function (t) { return function (t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : {}, s = t - e, r = B("rect", { className: "bar mini", styles: { fill: a.fill || "rgba(228, 234, 239, 0.49)", stroke: a.stroke || "#E2E6E9", "stroke-dasharray": "".concat(n, ", ").concat(s) }, x: 0, y: 0, width: n, height: s }); a.labelPos || (a.labelPos = "right"); var o = "left" === a.labelPos ? 4 : n - C(i + "", 4.5) - 4, l = B("text", { className: "chart-label", x: o, y: 0, dy: "-5px", "font-size": "10px", "text-anchor": "start", innerHTML: i + "" }), c = B("g", { transform: "translate(0, ".concat(e, ")") }); return c.appendChild(r), c.appendChild(l), c }(t.startPos, t.endPos, e.constants.width, t.label, { labelPos: t.options.labelPos, stroke: t.options.stroke, fill: t.options.fill }) })) }, animateElements: function (t) { var e = u(z(this.oldData, t), 2); this.oldData = e[0]; var n = (t = e[1]).map((function (t) { return t.endPos })), i = t.map((function (t) { return t.label })), a = t.map((function (t) { return t.startPos })), s = t.map((function (t) { return t.options })), r = this.oldData.map((function (t) { return t.endPos })), o = this.oldData.map((function (t) { return t.startPos })); this.render(r.map((function (t, e) { return { startPos: o[e], endPos: r[e], label: i[e], options: s[e] } }))); var l = []; return this.store.map((function (t, e) { l = l.concat(function (t, e, n, i) { var a = e - n, s = t.childNodes[0], r = s.getAttribute("width"); return [[s, { height: a, "stroke-dasharray": "".concat(r, ", ").concat(a) }, 350, "easein"], ot(t, [0, i], [0, n], 350)] }(t, a[e], n[e], r[e])) })), l } }, heatDomain: { layerClass: function () { return "heat-domain domain-" + this.constants.index }, makeElements: function (t) { var e = this, n = this.constants, i = n.index, a = n.colWidth, s = n.rowHeight, r = n.squareSize, o = n.radius, l = n.xTranslate, c = l, u = 0; return this.serializedSubDomains = [], t.cols.map((function (t, n) { 1 === n && e.labels.push(tt("domain-name", c, -12, Dt(i, !0).toUpperCase(), { fontSize: 9 })), t.map((function (t, n) { if (t.fill) { var i = { "data-date": t.yyyyMmDd, "data-value": t.dataValue, "data-day": n }, a = Q("day", c, u, r, o, t.fill, i); e.serializedSubDomains.push(a) } u += s })), u = 0, c += a })), this.serializedSubDomains }, animateElements: function (t) { if (t) return [] } }, barGraph: { layerClass: function () { return "dataset-units dataset-bars dataset-" + this.constants.index }, makeElements: function (t) { var e = this.constants; return this.unitType = "bar", this.units = t.yPositions.map((function (n, i) { return function (t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : "", s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, r = arguments.length > 6 && void 0 !== arguments[6] ? arguments[6] : 0, o = arguments.length > 7 && void 0 !== arguments[7] ? arguments[7] : {}, l = F(e, o.zeroLine), c = u(l, 2), h = c[0], d = c[1]; d -= r, 0 === h && (h = o.minHeight, d -= o.minHeight), O(t) || (t = 0), O(d) || (d = 0), O(h, !0) || (h = 0), O(n, !0) || (n = 0); var f = B("rect", { className: "bar mini", style: "fill: ".concat(i), "data-point-index": s, x: t, y: d, width: n, height: h }); if ((a += "") || a.length) { f.setAttribute("y", 0), f.setAttribute("x", 0); var p = B("text", { className: "data-point-value", x: n / 2, y: 0, dy: "-5px", "font-size": "10px", "text-anchor": "middle", innerHTML: a }), v = B("g", { "data-point-index": s, transform: "translate(".concat(t, ", ").concat(d, ")") }); return v.appendChild(f), v.appendChild(p), v } return f }(t.xPositions[i], n, t.barWidth, e.color, t.labels[i], i, t.offsets[i], { zeroLine: t.zeroLine, barsWidth: t.barsWidth, minHeight: e.minHeight }) })), this.units }, animateElements: function (t) { var e = t.xPositions, n = t.yPositions, i = t.offsets, a = t.labels, s = this.oldData.xPositions, r = this.oldData.yPositions, o = this.oldData.offsets, l = this.oldData.labels, c = u(z(s, e), 2); s = c[0], e = c[1]; var h = u(z(r, n), 2); r = h[0], n = h[1]; var d = u(z(o, i), 2); o = d[0], i = d[1]; var f = u(z(l, a), 2); l = f[0], a = f[1], this.render({ xPositions: s, yPositions: r, offsets: o, labels: a, zeroLine: this.oldData.zeroLine, barsWidth: this.oldData.barsWidth, barWidth: this.oldData.barWidth }); var p = []; return this.store.map((function (a, s) { p = p.concat(function (t, e, n, i) { var a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : 0, s = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : {}, r = F(n, s.zeroLine), o = u(r, 2), l = o[0], c = o[1]; if (c -= a, "rect" !== t.nodeName) { var h = t.childNodes[0], d = [h, { width: i, height: l }, 350, "easein"], f = t.getAttribute("transform").split("(")[1].slice(0, -1), p = ot(t, f, [e, c], 350); return [d, p] } return [[t, { width: i, height: l, x: e, y: c }, 350, "easein"]] }(a, e[s], n[s], t.barWidth, i[s], { zeroLine: t.zeroLine })) })), p } }, lineGraph: { layerClass: function () { return "dataset-units dataset-line dataset-" + this.constants.index }, makeElements: function (t) { var e = this.constants; if (this.unitType = "dot", this.paths = {}, e.hideLine || (this.paths = function (t, e, n) { var i = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : {}, a = arguments.length > 4 && void 0 !== arguments[4] ? arguments[4] : {}, s = e.map((function (e, n) { return t[n] + "," + e })), r = s.join("L"); i.spline && (r = W(t, e)); var o = U("M" + r, "line-graph-path", n); if (i.heatline) { var l = J(a.svgDefs, n); o.style.stroke = "url(#".concat(l, ")") } var c = { path: o }; if (i.regionFill) { var u = J(a.svgDefs, n, !0), h = "M" + "".concat(t[0], ",").concat(a.zeroLine, "L") + r + "L".concat(t.slice(-1)[0], ",").concat(a.zeroLine); c.region = U(h, "region-fill", "none", "url(#".concat(u, ")")) } return c }(t.xPositions, t.yPositions, e.color, { heatline: e.heatline, regionFill: e.regionFill, spline: e.spline }, { svgDefs: e.svgDefs, zeroLine: t.zeroLine })), this.units = [], e.showDots && (this.units = t.yPositions.map((function (n, i) { return it(t.xPositions[i], n, t.radius, e.color, e.valuesOverPoints ? t.values[i] : "", i, e.hideDotBorder) }))), e.trailingDot && !e.showDots) { var n = t.yPositions.length - 1, i = it(t.xPositions[n], t.yPositions[n], t.radius, e.color, e.valuesOverPoints ? t.values[n] : "", n, e.hideDotBorder); this.units.push(i) } return Object.values(this.paths).concat(this.units) }, animateElements: function (t) { var e = t.xPositions, n = t.yPositions, i = t.values, a = this.oldData.xPositions, s = this.oldData.yPositions, r = this.oldData.values, o = u(z(a, e), 2); a = o[0], e = o[1]; var l = u(z(s, n), 2); s = l[0], n = l[1]; var c = u(z(r, i), 2); r = c[0], i = c[1], this.render({ xPositions: a, yPositions: s, values: i, zeroLine: this.oldData.zeroLine, radius: this.oldData.radius }); var h = []; return Object.keys(this.paths).length && (h = h.concat(function (t, e, n, i, a) { var s = [], r = n.map((function (t, n) { return e[n] + "," + t })).join("L"); a && (r = W(e, n)); var o = [t.path, { d: "M" + r }, 350, "easein"]; if (s.push(o), t.region) { var l = "".concat(e[0], ",").concat(i, "L"), c = "L".concat(e.slice(-1)[0], ", ").concat(i), u = [t.region, { d: "M" + l + r + c }, 350, "easein"]; s.push(u) } return s }(this.paths, e, n, t.zeroLine, this.constants.spline))), this.units.length && this.units.map((function (t, i) { h = h.concat(function (t, e, n) { if ("circle" !== t.nodeName) { var i = t.getAttribute("transform").split("(")[1].slice(0, -1); return [ot(t, i, [e, n], 350)] } return [[t, { cx: e, cy: n }, 350, "easein"]] }(t, e[i], n[i])) })), h } } }; function Nt(t, e, n) { var i = Object.keys(Ct).filter((function (e) { return t.includes(e) })), a = Ct[i[0]]; return Object.assign(a, { constants: e, getData: n }), new Tt(a) } var Ot = function (t) { a(r, t); var n = l(r); function r(t, i) { var a; return e(this, r), (a = n.call(this, t, i)).type = "percentage", a.setup(), a } return i(r, [{ key: "setMeasures", value: function (t) { var e = this.measures; this.barOptions = t.barOptions || {}; var n = this.barOptions; n.height = n.height || 16, e.paddings.right = 30, e.paddings.top = 60, e.paddings.bottom = 0, e.legendHeight = 80, e.baseHeight = 8 * n.height + k(e) } }, { key: "setupComponents", value: function () { var t = this.state, e = [["percentageBars", { barHeight: this.barOptions.height }, function () { return { xPositions: t.xPositions, widths: t.widths, colors: this.colors } }.bind(this)]]; this.components = new Map(e.map((function (t) { var e = Nt.apply(void 0, h(t)); return [t[0], e] }))) } }, { key: "calc", value: function () { var t = this; c(s(r.prototype), "calc", this).call(this); var e = this.state; e.xPositions = [], e.widths = []; var n = 0; e.sliceTotals.map((function (i) { var a = t.width * i / e.grandTotal; e.widths.push(a), e.xPositions.push(n), n += a })) } }, { key: "makeDataByIndex", value: function () { } }, { key: "bindTooltip", value: function () { var t = this, e = this.state; this.container.addEventListener("mousemove", (function (n) { var i = t.components.get("percentageBars").store, a = n.target; if (i.includes(a)) { var s = i.indexOf(a), r = v(t.container), o = v(a), l = a.getAttribute("width") || a.getBoundingClientRect().width, c = o.left - r.left + parseInt(l) / 2, u = o.top - r.top, h = (t.formattedLabels && t.formattedLabels.length > 0 ? t.formattedLabels[s] : t.state.labels[s]) + ": ", d = e.sliceTotals[s] / e.grandTotal; t.tip.setValues(c, u, { name: h, value: (100 * d).toFixed(1) + "%" }), t.tip.showTip() } })) } }]), r }(gt), Et = function (t) { a(r, t); var n = l(r); function r(t, i) { var a; return e(this, r), (a = n.call(this, t, i)).initTimeout = 0, a.init = 1, a.setup(), a } return i(r, [{ key: "configure", value: function (t) { c(s(r.prototype), "configure", this).call(this, t), this.mouseMove = this.mouseMove.bind(this), this.mouseLeave = this.mouseLeave.bind(this), this.hoverRadio = t.hoverRadio || .1, this.config.startAngle = t.startAngle || 0, this.type = "pie", this.sliceName = "pieSlices", this.arcFunc = _, this.shapeFunc = q, this.clockWise = t.clockWise || !1 } }, { key: "getRadius", value: function () { return this.height > this.width ? this.center.x : this.center.y } }, { key: "calc", value: function () { var t = this; c(s(r.prototype), "calc", this).call(this); var e = this.state; this.radius = this.getRadius(); var n = this.radius, i = this.clockWise, a = e.slicesProperties || []; e.sliceStrings = [], e.slicesProperties = []; var o = 180 - this.config.startAngle; e.sliceTotals.map((function (s, r) { var l, c, u = o, h = s / e.grandTotal * 360, d = h > 180 ? 1 : 0, f = i ? -h : h, p = o += f, v = N(u, n), g = N(p, n), m = t.init && a[r]; t.init ? (l = m ? m.startPosition : v, c = m ? m.endPosition : v) : (l = v, c = g); var y = 360 === h ? t.shapeFunc(l, c, t.center, t.radius, i, d) : t.arcFunc(l, c, t.center, t.radius, i, d); e.sliceStrings.push(y), e.slicesProperties.push({ startPosition: v, endPosition: g, value: s, total: e.grandTotal, startAngle: u, endAngle: p, angle: f }) })), this.init = 0 } }, { key: "setupComponents", value: function () { var t = this.state, e = [["pieSlices", {}, function () { return { sliceStrings: t.sliceStrings, colors: this.colors } }.bind(this)]]; this.components = new Map(e.map((function (t) { var e = Nt.apply(void 0, h(t)); return [t[0], e] }))) } }, { key: "calTranslateByAngle", value: function (t) { var e = this.radius, n = this.hoverRadio, i = N(t.startAngle + t.angle / 2, e); return "translate3d(".concat(i.x * n, "px,").concat(i.y * n, "px,0)") } }, { key: "hoverSlice", value: function (t, e, n, i) { if (t) { var a = this.colors[e]; if (n) { dt(t, this.calTranslateByAngle(this.state.slicesProperties[e])); var s = v(this.svg), r = i.pageX - s.left + 10, o = i.pageY - s.top - 10, l = (this.formatted_labels && this.formatted_labels.length > 0 ? this.formatted_labels[e] : this.state.labels[e]) + ": ", c = (100 * this.state.sliceTotals[e] / this.state.grandTotal).toFixed(1); this.tip.setValues(r, o, { name: l, value: c + "%" }), this.tip.showTip() } else this.resetHover(t, a) } } }, { key: "resetHover", value: function (t, e) { dt(t, "translate3d(0,0,0)"), this.tip.hideTip(), t.style.fill = e } }, { key: "bindTooltip", value: function () { this.container.addEventListener("mousemove", this.mouseMove), this.container.addEventListener("mouseleave", this.mouseLeave) } }, { key: "mouseMove", value: function (t) { var e = t.target, n = this.components.get(this.sliceName).store, i = this.curActiveSliceIndex, a = this.curActiveSlice; if (n.includes(e)) { var s = n.indexOf(e); this.hoverSlice(a, i, !1), this.curActiveSlice = e, this.curActiveSliceIndex = s, this.hoverSlice(e, s, !0, t) } else this.mouseLeave() } }, { key: "mouseLeave", value: function () { this.hoverSlice(this.curActiveSlice, this.curActiveSliceIndex, !1) } }]), r }(gt); function St(t) { if (0 === t) return [0, 0]; if (isNaN(t)) return { mantissa: -6755399441055744, exponent: 972 }; var e = t > 0 ? 1 : -1; if (!isFinite(t)) return { mantissa: 4503599627370496 * e, exponent: 972 }; t = Math.abs(t); var n = Math.floor(Math.log10(t)); return [e * (t / Math.pow(10, n)), n] } function Ft(t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 0, n = Math.ceil(t), i = Math.floor(e), a = n - i, s = a, r = 1; a > 5 && (a % 2 != 0 && (a = ++n - i), s = a / 2, r = 2), a <= 2 && (r = a / (s = 4)), 0 === a && (s = 5, r = 1); for (var o = [], l = 0; l <= s; l++)o.push(i + r * l); return o } function zt(t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 0, n = St(t), i = u(n, 2), a = i[0], s = i[1], r = e ? e / Math.pow(10, s) : 0, o = Ft(a = a.toFixed(6), r); return o = o.map((function (t) { return t * Math.pow(10, s) })) } function Rt(t) { var e = arguments.length > 1 && void 0 !== arguments[1] && arguments[1], n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : {}, i = Math.max.apply(Math, h(t)), a = Math.min.apply(Math, h(t)); void 0 !== n.max && (i = i > n.max ? i : n.max), void 0 !== n.min && (a = a < n.min ? a : n.min); var s = []; function r(t, e) { for (var n = zt(t), i = n[1] - n[0], a = 0, s = 1; a < e; s++)a += i, n.unshift(-1 * a); return n } if (i >= 0 && a >= 0) St(i)[1], s = e ? zt(i, a) : zt(i); else if (i > 0 && a < 0) { var o = Math.abs(a); if (i >= o) St(i)[1], s = r(i, o); else { St(o)[1]; var l = r(o, i); s = l.reverse().map((function (t) { return -1 * t })) } } else if (i <= 0 && a <= 0) { var c = Math.abs(a), u = Math.abs(i); St(c)[1], s = (s = e ? zt(c, u) : zt(c)).reverse().map((function (t) { return -1 * t })) } return s } function Ht(t) { var e, n = Wt(t); if (t.indexOf(0) >= 0) e = t.indexOf(0); else if (t[0] > 0) { e = -1 * t[0] / n } else { e = -1 * t[t.length - 1] / n + (t.length - 1) } return e } function Wt(t) { return t[1] - t[0] } function jt(t) { return t[t.length - 1] - t[0] } function Bt(t, e) { return M(e.zeroLine - t * e.scaleMultiplier) } function It(t, e) { var n = arguments.length > 2 && void 0 !== arguments[2] && arguments[2], i = e.reduce((function (e, n) { return Math.abs(n - t) < Math.abs(e - t) ? n : e }), []); return n ? e.indexOf(i) : i } var Yt = function (t) { a(s, t); var n = l(s); function s(t, i) { var a; e(this, s), (a = n.call(this, t, i)).type = "heatmap", a.countLabel = i.countLabel || ""; var r = ["Sunday", "Monday"], o = r.includes(i.startSubDomain) ? i.startSubDomain : "Sunday"; return a.startSubDomainIndex = r.indexOf(o), a.setup(), a } return i(s, [{ key: "setMeasures", value: function (t) { var e = this.measures; this.discreteDomains = 0 === t.discreteDomains ? 0 : 1, e.paddings.top = 36, e.paddings.bottom = 0, e.legendHeight = 24, e.baseHeight = 84 + k(e); var n = this.data, i = this.discreteDomains ? 12 : 0; this.independentWidth = 12 * (wt(n.start, n.end) + i) + w(e) } }, { key: "updateWidth", value: function () { var t = this.discreteDomains ? 12 : 0, e = this.state.noOfWeeks ? this.state.noOfWeeks : 52; this.baseWidth = 12 * (e + t) + w(this.measures) } }, { key: "prepareData", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.data; if (t.start && t.end && t.start > t.end) throw new Error("Start date cannot be greater than end date."); if (t.start || (t.start = new Date, t.start.setFullYear(t.start.getFullYear() - 1)), t.end || (t.end = new Date), t.dataPoints = t.dataPoints || {}, parseInt(Object.keys(t.dataPoints)[0]) > 1e5) { var e = {}; Object.keys(t.dataPoints).forEach((function (n) { var i = new Date(1e3 * n); e[xt(i)] = t.dataPoints[n] })), t.dataPoints = e } return t } }, { key: "calc", value: function () { var t = this.state; t.start = kt(this.data.start), t.end = kt(this.data.end), t.firstWeekStart = kt(t.start), t.noOfWeeks = wt(t.start, t.end), t.distribution = function (t, e) { for (var n = Math.max.apply(Math, h(t)), i = 1 / (e - 1), a = [], s = 0; s < e; s++) { var r = n * (i * s); a.push(r) } return a }(Object.values(this.data.dataPoints), 5), t.domainConfigs = this.getDomains() } }, { key: "setupComponents", value: function () { var t = this, e = this.state, n = this.discreteDomains ? 0 : 1, i = e.domainConfigs.map((function (i, a) { return ["heatDomain", { index: i.index, colWidth: 12, rowHeight: 12, squareSize: 10, radius: t.rawChartArgs.radius || 0, xTranslate: 12 * e.domainConfigs.filter((function (t, e) { return e < a })).map((function (t) { return t.cols.length - n })).reduce((function (t, e) { return t + e }), 0) }, function () { return e.domainConfigs[a] }.bind(t)] })); this.components = new Map(i.map((function (t, e) { var n = Nt.apply(void 0, h(t)); return [t[0] + "-" + e, n] }))); var a = 0; yt.forEach((function (e, n) { if ([1, 3, 5].includes(n)) { var i = tt("subdomain-name", -6, a, e, { fontSize: 10, dy: 8, textAnchor: "end" }); t.drawArea.appendChild(i) } a += 12 })) } }, { key: "update", value: function (t) { t || console.error("No data to update."), this.data = this.prepareData(t), this.draw(), this.bindTooltip() } }, { key: "bindTooltip", value: function () { var t = this; this.container.addEventListener("mousemove", (function (e) { t.components.forEach((function (n) { var i = n.store, a = e.target; if (i.includes(a)) { var s = a.getAttribute("data-value"), r = a.getAttribute("data-date").split("-"), o = Dt(parseInt(r[1]) - 1, !0), l = t.container.getBoundingClientRect(), c = a.getBoundingClientRect(), u = parseInt(e.target.getAttribute("width")), h = c.left - l.left + u / 2, d = c.top - l.top, f = s + " " + t.countLabel, p = " on " + o + " " + r[0] + ", " + r[2]; t.tip.setValues(h, d, { name: p, value: f, valueFirst: 1 }, []), t.tip.showTip() } })) })) } }, { key: "renderLegend", value: function () { var t = this; this.legendArea.textContent = ""; var e = 0, n = this.rawChartArgs.radius || 0, i = tt("subdomain-name", e, 12, "Less", { fontSize: 11, dy: 9 }); e = 30, this.legendArea.appendChild(i), this.colors.slice(0, 5).map((function (i, a) { var s = Q("heatmap-legend-unit", e + 15 * a, 12, 10, n, i); t.legendArea.appendChild(s) })); var a = tt("subdomain-name", e + 75 + 3, 12, "More", { fontSize: 11, dy: 9 }); this.legendArea.appendChild(a) } }, { key: "getDomains", value: function () { for (var t = this.state, e = [t.start.getMonth(), t.start.getFullYear()], n = e[0], i = e[1], a = [t.end.getMonth(), t.end.getFullYear()], s = a[0] - n + 1 + 12 * (a[1] - i), r = [], o = kt(t.start), l = 0; l < s; l++) { var c = t.end; if (!At(o, t.end)) { var u = [o.getMonth(), o.getFullYear()]; c = Lt(u[0], u[1]) } r.push(this.getDomainConfig(o, c)), Mt(c, 1), o = c } return r } }, { key: "getDomainConfig", value: function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : "", n = [t.getMonth(), t.getFullYear()], i = n[0], a = n[1], s = Pt(t), r = { index: i, cols: [] }; Mt(e = kt(e) || Lt(i, a), 1); for (var o, l = wt(s, e), c = [], u = 0; u < l; u++)o = this.getCol(s, i), c.push(o), Mt(s = new Date(o[6].yyyyMmDd), 1); return void 0 !== o[6].dataValue && (Mt(s, 1), c.push(this.getCol(s, i, !0))), r.cols = c, r } }, { key: "getCol", value: function (t, e) { for (var n = arguments.length > 2 && void 0 !== arguments[2] && arguments[2], i = this.state, a = kt(t), s = [], r = 0; r < 7; r++, Mt(a, 1)) { var o = {}, l = a >= i.start && a <= i.end; n || a.getMonth() !== e || !l ? o.yyyyMmDd = xt(a) : o = this.getSubDomainConfig(a), s.push(o) } return s } }, { key: "getSubDomainConfig", value: function (t) { var e, n, i = xt(t), a = this.data.dataPoints[i]; return { yyyyMmDd: i, dataValue: a || 0, fill: this.colors[(e = a, n = this.state.distribution, n.filter((function (t) { return t < e })).length)] } } }]), s }(vt); function Vt(t, e) { t.labels = t.labels || []; var n = t.labels.length, i = t.datasets, a = new Array(n).fill(0); return i || (i = [{ values: a }]), i.map((function (t) { if (t.values) { var i = t.values; i = (i = i.map((function (t) { return isNaN(t) ? 0 : t }))).length > n ? i.slice(0, n) : T(i, n - i.length, 0), t.values = i } else t.values = a; t.chartType || (t.chartType = e) })), t.yRegions && t.yRegions.map((function (t) { if (t.end < t.start) { var e = [t.end, t.start]; t.start = e[0], t.end = e[1] } })), t } function Ut(t) { var e = t.labels.length, n = new Array(e).fill(0), i = { labels: t.labels.slice(0, -1), datasets: t.datasets.map((function (t) { return { name: "", values: n.slice(0, -1), chartType: t.chartType } })) }; return t.yMarkers && (i.yMarkers = [{ value: 0, label: "" }]), t.yRegions && (i.yRegions = [{ start: 0, end: 0, label: "" }]), i } var _t = function (t) { a(r, t); var n = l(r); function r(t, i) { var a; return e(this, r), (a = n.call(this, t, i)).barOptions = i.barOptions || {}, a.lineOptions = i.lineOptions || {}, a.type = i.type || "line", a.init = 1, a.setup(), a } return i(r, [{ key: "setMeasures", value: function () { this.data.datasets.length <= 1 && (this.config.showLegend = 0, this.measures.paddings.bottom = 30) } }, { key: "configure", value: function (t) { c(s(r.prototype), "configure", this).call(this, t), t.axisOptions = t.axisOptions || {}, t.tooltipOptions = t.tooltipOptions || {}, this.config.xAxisMode = t.axisOptions.xAxisMode || "span", this.config.yAxisMode = t.axisOptions.yAxisMode || "span", this.config.xIsSeries = t.axisOptions.xIsSeries || 0, this.config.shortenYAxisNumbers = t.axisOptions.shortenYAxisNumbers || 0, this.config.numberFormatter = t.axisOptions.numberFormatter, this.config.seriesLabelSpaceRatio = t.axisOptions.seriesLabelSpaceRatio, this.config.yAxisRange = t.axisOptions.yAxisRange || {}, this.config.formatTooltipX = t.tooltipOptions.formatTooltipX, this.config.formatTooltipY = t.tooltipOptions.formatTooltipY, this.config.valuesOverPoints = t.valuesOverPoints, this.config.legendRowHeight = 30 } }, { key: "prepareData", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.data; return Vt(t, this.type) } }, { key: "prepareFirstData", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.data; return Ut(t) } }, { key: "calc", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] && arguments[0]; this.calcXPositions(), t || this.calcYAxisParameters(this.getAllYValues(), "line" === this.type), this.makeDataByIndex() } }, { key: "calcXPositions", value: function () { var t = this.state, e = this.data.labels; t.datasetLength = e.length, t.unitWidth = this.width / t.datasetLength, t.xOffset = t.unitWidth / 2, t.xAxis = { labels: e, positions: e.map((function (e, n) { return M(t.xOffset + n * t.unitWidth) })) } } }, { key: "calcYAxisParameters", value: function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : "false", n = Rt(t, e, this.config.yAxisRange), i = this.height / jt(n), a = Wt(n) * i, s = this.height - Ht(n) * a; this.state.yAxis = { labels: n, positions: n.map((function (t) { return s - t * i })), scaleMultiplier: i, zeroLine: s }, this.calcDatasetPoints(), this.calcYExtremes(), this.calcYRegions() } }, { key: "calcDatasetPoints", value: function () { var t = this.state, e = function (e) { return e.map((function (e) { return Bt(e, t.yAxis) })) }; t.datasets = this.data.datasets.map((function (t, n) { var i = t.values, a = t.cumulativeYs || []; return { name: t.name && t.name.replace(/<|>|&/g, (function (t) { return "&" == t ? "&amp;" : "<" == t ? "&lt;" : "&gt;" })), index: n, chartType: t.chartType, values: i, yPositions: e(i), cumulativeYs: a, cumulativeYPos: e(a) } })) } }, { key: "calcYExtremes", value: function () { var t = this.state; this.barOptions.stacked ? t.yExtremes = t.datasets[t.datasets.length - 1].cumulativeYPos : (t.yExtremes = new Array(t.datasetLength).fill(9999), t.datasets.map((function (e) { e.yPositions.map((function (e, n) { e < t.yExtremes[n] && (t.yExtremes[n] = e) })) }))) } }, { key: "calcYRegions", value: function () { var t = this.state; this.data.yMarkers && (this.state.yMarkers = this.data.yMarkers.map((function (e) { return e.position = Bt(e.value, t.yAxis), e.options || (e.options = {}), e }))), this.data.yRegions && (this.state.yRegions = this.data.yRegions.map((function (e) { return e.startPos = Bt(e.start, t.yAxis), e.endPos = Bt(e.end, t.yAxis), e.options || (e.options = {}), e }))) } }, { key: "getAllYValues", value: function () { var t, e = this, n = "values"; if (this.barOptions.stacked) { n = "cumulativeYs"; var i = new Array(this.state.datasetLength).fill(0); this.data.datasets.map((function (t, a) { var s = e.data.datasets[a].values; t[n] = i = i.map((function (t, e) { return t + s[e] })) })) } var a = this.data.datasets.map((function (t) { return t[n] })); return this.data.yMarkers && a.push(this.data.yMarkers.map((function (t) { return t.value }))), this.data.yRegions && this.data.yRegions.map((function (t) { a.push([t.end, t.start]) })), (t = []).concat.apply(t, h(a)) } }, { key: "setupComponents", value: function () { var t = this, e = [["yAxis", { mode: this.config.yAxisMode, width: this.width, shortenNumbers: this.config.shortenYAxisNumbers, numberFormatter: this.config.numberFormatter }, function () { return this.state.yAxis }.bind(this)], ["xAxis", { mode: this.config.xAxisMode, height: this.height }, function () { var t = this.state; return t.xAxis.calcLabels = function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : [], n = !(arguments.length > 2 && void 0 !== arguments[2]) || arguments[2], i = arguments.length > 3 ? arguments[3] : void 0, a = t / e.length * (i || .6); a <= 0 && (a = 1); var s, r = a / 7; if (n) { var o = Math.max.apply(Math, h(e.map((function (t) { return t.length })))); s = Math.ceil(o / r) } var l = e.map((function (t, i) { return (t += "").length > r && (n ? i % s != 0 ? i !== e.length - 1 && (t = "") : i > e.length - s / 2 && (t = "") : t = r - 3 > 0 ? t.slice(0, r - 3) + " ..." : t.slice(0, r) + ".."), t })); return l }(this.width, t.xAxis.labels, this.config.xIsSeries, this.config.seriesLabelSpaceRatio), t.xAxis }.bind(this)], ["yRegions", { width: this.width, pos: "right" }, function () { return this.state.yRegions }.bind(this)]], n = this.state.datasets.filter((function (t) { return "bar" === t.chartType })), i = this.state.datasets.filter((function (t) { return "line" === t.chartType })), a = n.map((function (e) { var i = e.index; return ["barGraph-" + e.index, { index: i, color: t.colors[i], stacked: t.barOptions.stacked, valuesOverPoints: t.config.valuesOverPoints, minHeight: 0 * t.height }, function () { var t = this.state, e = t.datasets[i], a = this.barOptions.stacked, s = this.barOptions.spaceRatio || .5, r = t.unitWidth * (1 - s), o = r / (a ? 1 : n.length), l = t.xAxis.positions.map((function (t) { return t - r / 2 })); a || (l = l.map((function (t) { return t + o * i }))); var c = new Array(t.datasetLength).fill(""); this.config.valuesOverPoints && (c = a && e.index === t.datasets.length - 1 ? e.cumulativeYs : e.values.map((function (t) { return H(t) }))); var u = new Array(t.datasetLength).fill(0); return a && (u = e.yPositions.map((function (t, n) { return t - e.cumulativeYPos[n] }))), { xPositions: l, yPositions: e.yPositions, offsets: u, labels: c, zeroLine: t.yAxis.zeroLine, barsWidth: r, barWidth: o } }.bind(t)] })), s = i.map((function (e) { var n = e.index; return ["lineGraph-" + e.index, { index: n, color: t.colors[n], svgDefs: t.svgDefs, heatline: t.lineOptions.heatline, regionFill: t.lineOptions.regionFill, spline: t.lineOptions.spline, showDots: t.lineOptions.showDots, trailingDot: t.lineOptions.trailingDot, hideDotBorder: t.lineOptions.hideDotBorder, hideLine: t.lineOptions.hideLine, valuesOverPoints: t.config.valuesOverPoints }, function () { var t = this.state, e = t.datasets[n], i = t.yAxis.positions[0] < t.yAxis.zeroLine ? t.yAxis.positions[0] : t.yAxis.zeroLine; return { xPositions: t.xAxis.positions, yPositions: e.yPositions, values: e.values, zeroLine: i, radius: this.lineOptions.dotSize || 4 } }.bind(t)] })), r = [["yMarkers", { width: this.width, pos: "right" }, function () { return this.state.yMarkers }.bind(this)]]; e = e.concat(a, s, r); var o = ["yMarkers", "yRegions"]; this.dataUnitComponents = [], this.components = new Map(e.filter((function (e) { return !o.includes(e[0]) || t.state[e[0]] })).map((function (e) { var n = Nt.apply(void 0, h(e)); return (e[0].includes("lineGraph") || e[0].includes("barGraph")) && t.dataUnitComponents.push(n), [e[0], n] }))) } }, { key: "makeDataByIndex", value: function () { var t = this; this.dataByIndex = {}; var e = this.state, n = this.config.formatTooltipX, i = this.config.formatTooltipY; e.xAxis.labels.map((function (a, s) { var r = t.state.datasets.map((function (e, n) { var a = e.values[s]; return { title: e.name, value: a, yPos: e.yPositions[s], color: t.colors[n], formatted: i ? i(a, { name: e.name, index: e.index, values: e.values }) : a } })); t.dataByIndex[s] = { label: a, formattedLabel: n ? n(a) : a, xPos: e.xAxis.positions[s], values: r, yExtreme: e.yExtremes[s] } })) } }, { key: "bindTooltip", value: function () { var t = this; this.container.addEventListener("mousemove", (function (e) { var n = t.measures, i = v(t.container), a = e.pageX - i.left - x(n), s = e.pageY - i.top; !t.config.valuesOverPoints && s < t.height + b(n) && s > b(n) ? t.mapTooltipXPosition(a) : t.config.valuesOverPoints && "data-point-value" == e.target.getAttribute("class") ? t.mapTooltipXPosition(a, -20) : t.tip.hideTip() })) } }, { key: "mapTooltipXPosition", value: function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 0, n = this.state; if (n.yExtremes) { var i = It(t, n.xAxis.positions, !0); if (i >= 0) { var a = this.dataByIndex[i]; this.tip.setValues(a.xPos + this.tip.offset.x, a.yExtreme + this.tip.offset.y + e, { name: a.formattedLabel, value: "" }, a.values, i), this.tip.showTip() } } } }, { key: "renderLegend", value: function () { var t = this.data; t.datasets.length > 1 && c(s(r.prototype), "renderLegend", this).call(this, t.datasets) } }, { key: "makeLegend", value: function (t, e, n, i) { return Z(n, i + 5, 12, 3, this.colors[e], t.name, null, 8.75, this.config.truncateLegends) } }, { key: "makeOverlay", value: function () { var t = this; this.init ? this.init = 0 : (this.overlayGuides && this.overlayGuides.forEach((function (t) { var e = t.overlay; e.parentNode.removeChild(e) })), this.overlayGuides = this.dataUnitComponents.map((function (t) { return { type: t.unitType, overlay: void 0, units: t.units } })), void 0 === this.state.currentIndex && (this.state.currentIndex = this.state.datasetLength - 1), this.overlayGuides.map((function (e) { var n = e.units[t.state.currentIndex]; e.overlay = at[e.type](n), t.drawArea.appendChild(e.overlay) }))) } }, { key: "updateOverlayGuides", value: function () { this.overlayGuides && this.overlayGuides.forEach((function (t) { var e = t.overlay; e.parentNode.removeChild(e) })) } }, { key: "bindOverlay", value: function () { var t = this; this.parent.addEventListener("data-select", (function () { t.updateOverlay() })) } }, { key: "bindUnits", value: function () { var t = this; this.dataUnitComponents.map((function (e) { e.units.map((function (e) { e.addEventListener("click", (function () { var n = e.getAttribute("data-point-index"); t.setCurrentDataPoint(n) })) })) })), this.tip.container.addEventListener("click", (function () { var e = t.tip.container.getAttribute("data-point-index"); t.setCurrentDataPoint(e) })) } }, { key: "updateOverlay", value: function () { var t = this; this.overlayGuides.map((function (e) { var n = e.units[t.state.currentIndex]; st[e.type](n, e.overlay) })) } }, { key: "onLeftArrow", value: function () { this.setCurrentDataPoint(this.state.currentIndex - 1) } }, { key: "onRightArrow", value: function () { this.setCurrentDataPoint(this.state.currentIndex + 1) } }, { key: "getDataPoint", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.state.currentIndex, e = this.state, n = { index: t, label: e.xAxis.labels[t], values: e.datasets.map((function (e) { return e.values[t] })) }; return n } }, { key: "setCurrentDataPoint", value: function (t) { var e = this.state; (t = parseInt(t)) < 0 && (t = 0), t >= e.xAxis.labels.length && (t = e.xAxis.labels.length - 1), t !== e.currentIndex && (e.currentIndex = t, function (t, e, n) { var i = document.createEvent("HTMLEvents"); for (var a in i.initEvent(e, !0, !0), n) i[a] = n[a]; t.dispatchEvent(i) }(this.parent, "data-select", this.getDataPoint())) } }, { key: "addDataPoint", value: function (t, e) { var n = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : this.state.datasetLength; c(s(r.prototype), "addDataPoint", this).call(this, t, e, n), this.data.labels.splice(n, 0, t), this.data.datasets.map((function (t, i) { t.values.splice(n, 0, e[i]) })), this.update(this.data) } }, { key: "removeDataPoint", value: function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.state.datasetLength - 1; this.data.labels.length <= 1 || (c(s(r.prototype), "removeDataPoint", this).call(this, t), this.data.labels.splice(t, 1), this.data.datasets.map((function (e) { e.values.splice(t, 1) })), this.update(this.data)) } }, { key: "updateDataset", value: function (t) { var e = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 0; this.data.datasets[e].values = t, this.update(this.data) } }, { key: "updateDatasets", value: function (t) { this.data.datasets.map((function (e, n) { t[n] && (e.values = t[n]) })), this.update(this.data) } }]), r }(vt), qt = { bar: _t, line: _t, percentage: Ot, heatmap: Yt, pie: Et, donut: function (t) { a(r, t); var n = l(r); function r(t, i) { return e(this, r), n.call(this, t, i) } return i(r, [{ key: "configure", value: function (t) { c(s(r.prototype), "configure", this).call(this, t), this.type = "donut", this.sliceName = "donutSlices", this.arcFunc = G, this.shapeFunc = X, this.strokeWidth = t.strokeWidth || 30 } }, { key: "getRadius", value: function () { return this.height > this.width ? this.center.x - this.strokeWidth / 2 : this.center.y - this.strokeWidth / 2 } }, { key: "resetHover", value: function (t, e) { dt(t, "translate3d(0,0,0)"), this.tip.hideTip(), t.style.stroke = e } }, { key: "setupComponents", value: function () { var t = this.state, e = [[this.sliceName, {}, function () { return { sliceStrings: t.sliceStrings, colors: this.colors, strokeWidth: this.strokeWidth } }.bind(this)]]; this.components = new Map(e.map((function (t) { var e = Nt.apply(void 0, h(t)); return [t[0], e] }))) } }]), r }(Et) }; var Gt = Object.freeze({ __proto__: null, Chart: function t(n, i) { return e(this, t), function () { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : "line", e = arguments.length > 1 ? arguments[1] : void 0, n = arguments.length > 2 ? arguments[2] : void 0; return "axis-mixed" === t ? (n.type = "line", new _t(e, n)) : qt[t] ? new qt[t](e, n) : void console.error("Undefined chart type: " + t) }(i.type, n, i) }, PercentageChart: Ot, PieChart: Et, Heatmap: Yt, AxisChart: _t }), Xt = { NAME: "Frappe Charts", VERSION: "2.0.0-rc22" }; return Xt = Object.assign({}, Xt, Gt) }));
	//# sourceMappingURL=frappe-charts.umd.js.map

	// Fix Aliasing for frappe-charts UMD
	var frappe = window.frappe || {};
	window.frappe = frappe;

	// The UMD build assigns to window["frappe-charts"]
	var frappeCharts = window["frappe-charts"];

	if (frappeCharts) {
		// If it exports { Chart: ... }
		if (frappeCharts.Chart) {
			frappe.Chart = frappeCharts.Chart;
		}
		// Fallback/Safety
		else {
			frappe.Chart = frappeCharts;
		}
	} else if (window.Chart) {
		// Some older builds might do this
		frappe.Chart = window.Chart;
	}


</script>

<style>
	@import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700&display=swap");

	#page-client-portal .page-content-wrapper {
		margin: 0;
	}

	#page-client-portal .page-header-wrapper {
		display: none;
	}

	#page-client-portal .page_content {
		min-height: 100vh;
	}

	/* Full Width Override */
	.container {
		max-width: 100% !important;
		width: 100% !important;
		padding-left: 0 !important;
		padding-right: 0 !important;
		margin: 0 !important;
	}

	#cs-print-container {
		display: none;
	}

	@page {
		size: A4 portrait;
		margin: 1in;
	}

	@media print {

		/* Force background colors */
		* {
			-webkit-print-color-adjust: exact !important;
			print-color-adjust: exact !important;
		}

		/* Hide everything by default */
		body {
			margin: 0 !important;
			padding: 0 !important;
		}

		body>* {
			display: none !important;
		}

		/* Show only the print container */
		#cs-print-container,
		#cs-print-container * {
			display: block !important;
			visibility: visible !important;
		}

		#cs-print-container {
			display: block !important;
			width: 100%;
			background: white;
			padding: 0;
			margin: 0;
			/* Let @page handle margins */
		}

		/* Grid Overrides for Print */
		#cs-print-container .cs-kpi-grid {
			display: grid !important;
			grid-template-columns: repeat(3, 1fr) !important;
			gap: 1rem;
		}

		/* Sub-grids (Charts/Summaries) */
		#cs-print-container>div[style*="grid"] {
			display: grid !important;
			grid-template-columns: 1fr 1fr !important;
			gap: 1.5rem !important;
		}

		/* Card Styling for Print */
		#cs-print-container .cs-chart-card,
		#cs-print-container>div>div {
			break-inside: avoid;
			page-break-inside: avoid;
			box-shadow: none !important;
			border: 1px solid #eee !important;
		}
	}

	:root {
		--cs-bg-1: #f8fafc;
		--cs-bg-2: #f1f5f9;
		--cs-bg-3: #e2e8f0;
		--cs-surface: #ffffff;
		--cs-surface-glass: rgba(255, 255, 255, 0.85);
		--cs-border: #e2e8f0;
		--cs-border-hover: #cbd5e1;
		--cs-headline: #0f172a;
		--cs-copy: #334155;
		--cs-muted: #64748b;

		--cs-accent: #0d9488;
		--cs-accent-hover: #0f766e;
		--cs-accent-subtle: #ccfbf1;
		--cs-accent-strong: #065f46;

		--cs-success: #10b981;
		--cs-warning: #f59e0b;
		--cs-error: #ef4444;

		--cs-dark: #0f172a;
		--cs-dark-2: #1e293b;
		--cs-dark-3: #334155;

		--cs-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
		--cs-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
		--cs-shadow-lg: 0 12px 28px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04);
		--cs-shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.04);

		--cs-radius-sm: 0.5rem;
		--cs-radius-md: 0.75rem;
		--cs-radius-lg: 1rem;
		--cs-radius-xl: 1.25rem;
	}

	.client-portal {
		--cs-bg-1: #f8fafc;
		--cs-bg-2: #f1f5f9;
		--cs-bg-3: #e2e8f0;
		--cs-surface: #ffffff;
		--cs-surface-glass: rgba(255, 255, 255, 0.85);
		--cs-border: #e2e8f0;
		--cs-border-hover: #cbd5e1;
		--cs-headline: #0f172a;
		--cs-copy: #334155;
		--cs-muted: #64748b;

		--cs-accent: #0d9488;
		--cs-accent-hover: #0f766e;
		--cs-accent-subtle: #ccfbf1;
		--cs-accent-strong: #065f46;

		--cs-success: #10b981;
		--cs-warning: #f59e0b;
		--cs-error: #ef4444;

		--cs-dark: #0f172a;
		--cs-dark-2: #1e293b;
		--cs-dark-3: #334155;

		--cs-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
		--cs-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
		--cs-shadow-lg: 0 12px 28px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04);
		--cs-shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.04);

		--cs-radius-sm: 0.5rem;
		--cs-radius-md: 0.75rem;
		--cs-radius-lg: 1rem;
		--cs-radius-xl: 1.25rem;

		position: relative;
		width: 100%;
		padding: 0;
		background: var(--cs-bg-1);
		font-family: 'Inter', system-ui, -apple-system, sans-serif;
		color: var(--cs-copy);
		-webkit-font-smoothing: antialiased;
		min-height: 100vh;
	}

	.client-portal::before,
	.client-portal::after {
		display: none;
	}

	.cs-shell {
		position: relative;
		z-index: 1;
		width: 100%;
		max-width: none;
		display: grid;
		gap: 0;
	}

	.cs-topbar {
		display: grid;
		grid-template-columns: 1.25fr auto;
		gap: 1.5rem;
		padding: 1.75rem 2rem;
		border-radius: 0;
		border: none;
		background: linear-gradient(135deg, var(--cs-dark) 0%, var(--cs-dark-2) 60%, #0f3a33 100%);
		box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
		backdrop-filter: none;
		position: relative;
		overflow: hidden;
	}

	.cs-topbar::before {
		content: "";
		position: absolute;
		top: -50%;
		right: -10%;
		width: 500px;
		height: 500px;
		background: radial-gradient(circle, rgba(13, 148, 136, 0.15) 0%, transparent 70%);
		pointer-events: none;
	}

	.cs-topbar::after {
		content: "";
		position: absolute;
		bottom: -60%;
		left: 10%;
		width: 400px;
		height: 400px;
		background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
		pointer-events: none;
	}

	.cs-brand {
		display: flex;
		flex-direction: column;
		gap: 0.4rem;
	}

	.cs-eyebrow {
		font-size: 0.7rem;
		font-weight: 700;
		letter-spacing: 0.14em;
		text-transform: uppercase;
		color: #5eead4;
	}

	.cs-title {
		margin: 0;
		font-family: "Sora", "Manrope", sans-serif;
		font-size: clamp(1.4rem, 2.8vw, 2rem);
		font-weight: 700;
		letter-spacing: -0.02em;
		color: #ffffff;
	}

	.cs-subtitle {
		margin: 0;
		max-width: 72ch;
		font-size: 0.85rem;
		font-weight: 400;
		color: #94a3b8;
	}

	.cs-system-state {
		display: inline-flex;
		align-items: center;
		gap: 0.45rem;
		padding: 0.3rem 0.6rem;
		width: fit-content;
		border-radius: 999px;
		font-size: 0.72rem;
		font-weight: 600;
		color: #94a3b8;
		border: 1px solid rgba(148, 163, 184, 0.2);
		background: rgba(255, 255, 255, 0.06);
	}

	.cs-system-dot {
		width: 0.42rem;
		height: 0.42rem;
		border-radius: 999px;
		background: #64748b;
		box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.2);
	}

	.cs-system-state.is-loading .cs-system-dot {
		background: #f59e0b;
		box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
	}

	.cs-system-state.is-live .cs-system-dot {
		background: #34d399;
		box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.25);
		animation: csPulse 2s ease infinite;
	}

	.cs-system-state.is-error .cs-system-dot {
		background: #f87171;
		box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.25);
	}

	@keyframes csPulse {

		0%,
		100% {
			opacity: 1;
		}

		50% {
			opacity: 0.5;
		}
	}

	.cs-controls {
		display: grid;
		grid-template-columns: repeat(3, minmax(180px, 1fr));
		gap: 0.6rem;
		align-content: center;
		position: relative;
		z-index: 1;
	}

	.cs-field {
		display: flex;
		flex-direction: column;
		gap: 0.3rem;
	}

	.cs-label {
		font-size: 0.65rem;
		font-weight: 600;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		color: #94a3b8;
	}

	.cs-select,
	.cs-input,
	.cs-btn {
		border-radius: var(--cs-radius-sm);
		border: 1px solid rgba(148, 163, 184, 0.25);
		padding: 0.5rem 0.7rem;
		font-size: 0.82rem;
		font-weight: 500;
		transition: all 0.2s ease;
	}

	.cs-topbar .cs-select,
	.cs-topbar .cs-input {
		background: rgba(255, 255, 255, 0.08);
		color: #e2e8f0;
		border-color: rgba(148, 163, 184, 0.2);
	}

	.cs-topbar .cs-select:focus,
	.cs-topbar .cs-input:focus {
		outline: none;
		border-color: #5eead4;
		box-shadow: 0 0 0 3px rgba(94, 234, 212, 0.15);
		background: rgba(255, 255, 255, 0.12);
	}

	.cs-select,
	.cs-input {
		background: #ffffff;
		color: var(--cs-headline);
	}

	.cs-select:focus,
	.cs-input:focus {
		outline: none;
		border-color: var(--cs-accent);
		box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
	}

	.cs-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 0.4rem;
		background: #ffffff;
		border-color: var(--cs-border);
		color: var(--cs-copy);
		text-decoration: none;
		transition: all 0.2s ease;
		font-weight: 500;
		cursor: pointer;
	}

	.cs-btn:hover {
		background: var(--cs-bg-2);
		border-color: var(--cs-border-hover);
		color: var(--cs-headline);
	}

	.cs-topbar .cs-btn {
		background: rgba(255, 255, 255, 0.1);
		border-color: rgba(148, 163, 184, 0.2);
		color: #e2e8f0;
	}

	.cs-topbar .cs-btn:hover {
		background: rgba(255, 255, 255, 0.18);
		border-color: rgba(148, 163, 184, 0.35);
		color: #ffffff;
	}

	.cs-btn:disabled {
		opacity: 0.58;
		cursor: not-allowed;
	}

	.cs-btn-dot {
		width: 0.38rem;
		height: 0.38rem;
		border-radius: 999px;
		background: currentColor;
		opacity: 0.85;
	}

	.cs-refresh-meta {
		padding: 0.46rem 0.62rem;
		font-size: 0.74rem;
		font-weight: 500;
		color: #94a3b8;
		border: 1px solid rgba(148, 163, 184, 0.15);
		border-radius: var(--cs-radius-sm);
		background: rgba(255, 255, 255, 0.06);
	}

	.cs-nav {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		padding: 0.6rem 1.5rem;
		border-radius: 0;
		border: none;
		border-bottom: 1px solid var(--cs-border);
		background: rgba(255, 255, 255, 0.92);
		box-shadow: none;
		backdrop-filter: blur(16px);
		position: sticky;
		top: 0;
		z-index: 9;
	}

	.cs-chip {
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		border: none;
		background: transparent;
		color: var(--cs-muted);
		border-radius: var(--cs-radius-sm);
		padding: 0.4rem 0.75rem;
		font-size: 0.8rem;
		font-weight: 600;
		transition: all 0.2s ease;
		cursor: pointer;
	}

	.cs-chip::before {
		display: none;
	}

	.cs-chip:hover {
		background: var(--cs-bg-2);
		color: var(--cs-headline);
		transform: none;
	}

	.cs-chip-active {
		background: rgba(13, 148, 136, 0.08);
		color: var(--cs-accent);
		box-shadow: none;
		border: none;
	}

	.cs-chip-active::before {
		display: none;
	}

	.cs-chip-main {
		margin-left: auto;
		background: transparent;
		color: var(--cs-accent);
		border: none;
	}

	.cs-chip-main::before {
		display: none;
	}

	.cs-chip-count {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		min-width: 1.25rem;
		height: 1.25rem;
		padding: 0 0.3rem;
		border-radius: 999px;
		font-size: 0.68rem;
		font-weight: 700;
		color: var(--cs-muted);
		background: var(--cs-bg-2);
	}

	.cs-chip-active .cs-chip-count {
		color: var(--cs-accent);
		background: rgba(13, 148, 136, 0.12);
	}

	.cs-kpi-grid {
		display: grid;
		grid-template-columns: repeat(6, minmax(0, 1fr));
		gap: 0.75rem;
		padding: 1.25rem 1.5rem;
	}

	.cs-kpi {
		position: relative;
		overflow: hidden;
		display: grid;
		gap: 0.35rem;
		padding: 1rem 1rem 1rem 1.15rem;
		border-radius: var(--cs-radius-lg);
		border: 1px solid var(--cs-border);
		background: #ffffff;
		box-shadow: var(--cs-shadow-sm);
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		cursor: default;
	}

	.cs-kpi:hover {
		transform: translateY(-2px);
		box-shadow: var(--cs-shadow-md);
		border-color: var(--cs-border-hover);
	}

	.cs-kpi::before {
		content: "";
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 3.5px;
		border-radius: 0 4px 4px 0;
		background: linear-gradient(180deg, var(--cs-accent) 0%, #14b8a6 100%);
	}

	.cs-kpi::after {
		content: attr(data-icon);
		position: absolute;
		right: 0.8rem;
		bottom: 0.6rem;
		font-size: 1.75rem;
		opacity: 0.08;
		pointer-events: none;
		transition: opacity 0.3s ease;
	}

	.cs-kpi:hover::after {
		opacity: 0.15;
	}

	.cs-kpi-label {
		font-size: 0.66rem;
		font-weight: 600;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		color: var(--cs-muted);
	}

	.cs-kpi-value {
		font-family: "Sora", "Manrope", sans-serif;
		font-size: clamp(1.15rem, 2vw, 1.5rem);
		font-weight: 700;
		color: var(--cs-headline);
		letter-spacing: -0.02em;
	}

	.cs-banner {
		display: block;
		padding: 0.7rem 1.5rem;
		border-radius: 0;
		font-size: 0.82rem;
		font-weight: 500;
		border: none;
		border-bottom: 1px solid var(--cs-border);
		box-shadow: none;
	}

	.cs-banner-info {
		background: rgba(13, 148, 136, 0.04);
		color: var(--cs-accent);
		border-bottom-color: rgba(13, 148, 136, 0.1);
	}

	.cs-banner-warn {
		background: rgba(245, 158, 11, 0.04);
		color: #b45309;
		border-bottom-color: rgba(245, 158, 11, 0.1);
	}

	.cs-layout {
		display: grid;
		grid-template-columns: repeat(12, minmax(0, 1fr));
		gap: 0.75rem;
		padding: 0 1.5rem 1.5rem;
	}

	.cs-board {
		grid-column: span 12;
		height: 100%;
		border: 1px solid var(--cs-border);
		border-radius: var(--cs-radius-xl);
		overflow: hidden;
		background: #ffffff;
		box-shadow: var(--cs-shadow-sm);
		backdrop-filter: none;
		transition: all 0.3s ease;
	}

	.cs-board:hover {
		box-shadow: var(--cs-shadow-md);
		border-color: var(--cs-border-hover);
	}

	.cs-board[data-span="6"] {
		grid-column: span 6;
	}

	.cs-board-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.7rem;
		padding: 1rem 1.25rem;
		border-bottom: 1px solid var(--cs-border);
		background: #ffffff;
	}

	.cs-board-head-main {
		display: flex;
		flex-direction: column;
		gap: 0.2rem;
	}

	.cs-board-title {
		margin: 0;
		font-family: "Sora", "Manrope", sans-serif;
		font-size: 0.95rem;
		font-weight: 700;
		color: var(--cs-headline);
		padding-left: 0;
		border-left: none;
	}

	.cs-board-meta {
		font-size: 0.72rem;
		font-weight: 500;
		color: var(--cs-muted);
	}

	.cs-board-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.45rem;
	}

	.cs-tools {
		padding: 0.65rem 1.25rem;
		border-bottom: 1px solid var(--cs-border);
		background: var(--cs-bg-1);
	}

	.cs-section-search {
		width: 100%;
	}

	.cs-table-wrap {
		overflow: auto;
		max-height: 28rem;
	}

	.cs-table {
		margin: 0;
		min-width: 680px;
		font-size: 0.84rem;
	}

	.cs-table thead th {
		position: sticky;
		top: 0;
		z-index: 2;
		padding: 0.65rem 0.85rem;
		font-size: 0.68rem;
		font-weight: 600;
		letter-spacing: 0.08em;
		text-transform: uppercase;
		color: var(--cs-muted);
		background: var(--cs-bg-1);
		border-bottom: 1px solid var(--cs-border);
		white-space: nowrap;
	}

	.cs-table tbody td {
		padding: 0.6rem 0.85rem;
		vertical-align: middle;
		color: var(--cs-copy);
		border-top: 1px solid var(--cs-border);
		transition: background 0.15s ease;
	}

	.cs-table tbody tr:nth-child(even) td {
		background: var(--cs-bg-1);
	}

	.cs-table tbody tr:hover td {
		background: rgba(13, 148, 136, 0.04);
	}

	.cs-table tbody tr:hover td:first-child {
		box-shadow: inset 3px 0 0 var(--cs-accent);
	}

	.cs-link {
		color: var(--cs-accent-strong);
		font-weight: 700;
		text-decoration: none;
		text-underline-offset: 0.2em;
		text-decoration-thickness: 1px;
	}

	.cs-link:hover {
		text-decoration: underline;
	}

	.cs-pill {
		display: inline-flex;
		align-items: center;
		padding: 0.16rem 0.48rem;
		border-radius: 999px;
		font-size: 0.71rem;
		font-weight: 700;
		line-height: 1.2;
		border: 1px solid transparent;
	}

	.cs-pill--ok {
		background: rgba(35, 154, 111, 0.14);
		color: #166247;
		border-color: rgba(35, 154, 111, 0.3);
	}

	.cs-pill--warn {
		background: rgba(191, 127, 43, 0.16);
		color: #8a5a1e;
		border-color: rgba(191, 127, 43, 0.34);
	}

	.cs-pill--danger {
		background: rgba(191, 76, 76, 0.16);
		color: #8b3232;
		border-color: rgba(191, 76, 76, 0.34);
	}

	.cs-pill--neutral {
		background: rgba(48, 100, 90, 0.12);
		color: #215048;
		border-color: rgba(48, 100, 90, 0.3);
	}

	.cs-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.38rem;
		justify-content: flex-end;
		flex-wrap: wrap;
	}

	.cs-empty-cell {
		padding: 0.95rem 0.72rem;
		text-align: center;
		color: var(--cs-muted);
		font-weight: 600;
	}

	.cs-btn[aria-disabled="true"] {
		opacity: 0.56;
		pointer-events: none;
	}

	.cs-section {
		scroll-margin-top: 6.5rem;
	}

	.cs-animate {
		opacity: 0;
		transform: translateY(12px);
	}

	.cs-loaded .cs-animate {
		animation: csFadeUp 0.52s ease forwards;
	}

	.cs-loaded .cs-animate[data-delay="1"] {
		animation-delay: 80ms;
	}

	.cs-loaded .cs-animate[data-delay="2"] {
		animation-delay: 160ms;
	}

	.cs-loaded .cs-animate[data-delay="3"] {
		animation-delay: 240ms;
	}

	@keyframes csFadeUp {
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* Skeleton Loading State */
	.is-loading-data .cs-kpi-value,
	.is-loading-data .cs-board-title,
	.is-loading-data .cs-chart-card,
	.is-loading-data td {
		position: relative;
		color: transparent !important;
		background: rgba(19, 84, 70, 0.06);
		border-radius: 4px;
		overflow: hidden;
	}

	.is-loading-data .cs-kpi-value::after,
	.is-loading-data .cs-board-title::after,
	.is-loading-data .cs-chart-card::after,
	.is-loading-data td::after {
		content: "";
		position: absolute;
		inset: 0;
		transform: translateX(-100%);
		background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
		animation: csSkeleton 1.5s infinite;
	}

	@keyframes csSkeleton {
		100% {
			transform: translateX(100%);
		}
	}

	@media (max-width: 1280px) {
		.cs-controls {
			grid-template-columns: repeat(2, minmax(180px, 1fr));
		}

		.cs-kpi-grid {
			grid-template-columns: repeat(3, minmax(0, 1fr));
		}
	}

	@media (max-width: 1040px) {
		.cs-topbar {
			grid-template-columns: 1fr;
		}

		.cs-controls {
			grid-template-columns: 1fr;
		}

		.cs-board[data-span="6"] {
			grid-column: span 12;
		}
	}

	@media (max-width: 760px) {
		.cs-topbar {
			padding: 1.25rem 1rem;
		}

		.cs-nav {
			top: 0;
			padding: 0.4rem 1rem;
		}

		.cs-chip {
			font-size: 0.73rem;
			padding: 0.32rem 0.62rem;
		}

		.cs-chip-main {
			margin-left: 0;
		}

		.cs-kpi-grid {
			grid-template-columns: repeat(2, minmax(0, 1fr));
			padding: 0.75rem 1rem;
		}

		.cs-layout {
			padding: 0 1rem 1rem;
		}

		.cs-charts-grid {
			padding: 0 1rem;
		}

		.cs-req-item-row {
			grid-template-columns: 1fr;
			gap: 0.42rem;
		}

		.cs-req-item-row .remove-row {
			width: 100%;
		}
	}

	@media (max-width: 520px) {
		.cs-kpi-grid {
			grid-template-columns: 1fr;
		}
	}

	@media (prefers-reduced-motion: reduce) {

		.cs-btn,
		.cs-chip,
		.cs-select,
		.cs-input,
		.cs-board {
			transition: none;
		}
	}

	/* Chart Grid */
	.cs-charts-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
		gap: 1rem;
		padding: 0 1.5rem;
		margin-bottom: 0.75rem;
	}

	.cs-chart-card {
		background: #ffffff;
		border-radius: var(--cs-radius-xl);
		padding: 1.5rem;
		border: 1px solid var(--cs-border);
		box-shadow: var(--cs-shadow-sm);
		overflow: visible !important;
		transition: all 0.3s ease;
	}

	.cs-chart-card:hover {
		box-shadow: var(--cs-shadow-md);
		border-color: var(--cs-border-hover);
	}

	.cs-chart-title {
		margin: 0 0 1rem 0;
		font-size: 0.9rem;
		font-weight: 600;
		color: var(--cs-headline);
	}

	/* Board Card Overrides */
	.cs-board {
		background: #ffffff;
		border: 1px solid var(--cs-border);
		border-radius: var(--cs-radius-xl);
		box-shadow: var(--cs-shadow-sm);
		overflow: hidden;
	}

	.cs-board-head {
		background: #ffffff;
		border-bottom: 1px solid var(--cs-border);
		padding: 1rem 1.25rem;
	}

	.cs-btn-primary {
		background: linear-gradient(135deg, var(--cs-accent), var(--cs-accent-hover));
		color: #ffffff;
		border-color: transparent;
		box-shadow: 0 2px 8px rgba(13, 148, 136, 0.25);
	}

	.cs-btn-primary:hover {
		background: linear-gradient(135deg, var(--cs-accent-hover), #065f46);
		color: #ffffff;
		box-shadow: 0 4px 14px rgba(13, 148, 136, 0.35);
		transform: translateY(-1px);
	}

	.cs-btn-primary .cs-btn-dot {
		background: #ffffff;
	}

	.cs-modal-overlay {
		position: fixed;
		inset: 0;
		background: rgba(15, 23, 42, 0.5);
		backdrop-filter: blur(6px);
		z-index: 100;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1rem;
		animation: csOverlayIn 0.2s ease;
	}

	@keyframes csOverlayIn {
		from {
			opacity: 0;
		}

		to {
			opacity: 1;
		}
	}

	.cs-modal {
		background: #ffffff;
		border-radius: var(--cs-radius-xl);
		box-shadow: var(--cs-shadow-xl);
		width: 100%;
		max-width: 550px;
		display: flex;
		flex-direction: column;
		gap: 1.2rem;
		padding: 2rem;
		max-height: 90vh;
		overflow-y: auto;
		animation: csModalIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
	}

	@keyframes csModalIn {
		from {
			opacity: 0;
			transform: scale(0.96) translateY(8px);
		}

		to {
			opacity: 1;
			transform: scale(1) translateY(0);
		}
	}

	.cs-modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}

	.cs-modal-title {
		margin: 0;
		font-size: 1.25rem;
		font-weight: 700;
		color: var(--cs-headline);
	}

	.cs-req-item-row {
		display: grid;
		grid-template-columns: 2fr 1.3fr 1.3fr 1fr auto;
		gap: 0.5rem;
		align-items: end;
		margin-bottom: 0.5rem;
	}

	.cs-modal-footer {
		display: flex;
		justify-content: flex-end;
		padding-top: 1.5rem;
		border-top: 1px solid var(--cs-border);
	}

	/* Toast Notifications */
	.cs-toast-container {
		position: fixed;
		bottom: 2rem;
		right: 2rem;
		display: flex;
		flex-direction: column;
		gap: 0.8rem;
		z-index: 200;
		pointer-events: none;
	}

	.cs-toast {
		background: var(--cs-surface);
		color: var(--cs-headline);
		padding: 1rem 1.25rem;
		border-radius: var(--cs-radius-md);
		border-left: 4px solid var(--cs-accent);
		box-shadow: var(--cs-shadow-lg);
		font-size: 0.9rem;
		font-weight: 500;
		display: flex;
		align-items: center;
		gap: 0.75rem;
		min-width: 300px;
		pointer-events: auto;
		animation: toastSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
	}

	.cs-toast.is-error {
		border-left-color: var(--cs-error);
	}

	.cs-toast.is-success {
		border-left-color: var(--cs-success);
	}

	@keyframes toastSlideIn {
		from {
			transform: translateX(100%);
			opacity: 0;
		}

		to {
			transform: translateX(0);
			opacity: 1;
		}
	}

	@keyframes toastSlideOut {
		to {
			transform: translateX(100%);
			opacity: 0;
		}
	}

	/* Quick Action Card */
	.cs-action-card {
		background: linear-gradient(135deg, var(--cs-accent), var(--cs-accent-hover));
		color: white;
		border-radius: var(--cs-radius-xl);
		padding: 1.5rem;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		box-shadow: var(--cs-shadow-md);
		cursor: pointer;
		transition: transform 0.2s;
		border: 1px solid rgba(255, 255, 255, 0.1);
	}

	.cs-action-card:hover {
		transform: translateY(-2px);
		box-shadow: var(--cs-shadow-lg);
	}

	.cs-action-card h3 {
		margin: 0;
		font-size: 1.1rem;
		font-weight: 700;
		color: white;
	}

	.cs-action-card p {
		margin: 0.5rem 0 1.5rem;
		font-size: 0.85rem;
		opacity: 0.9;
		color: rgba(255, 255, 255, 0.9);
	}

	.cs-action-btn {
		background: white;
		color: var(--cs-accent-strong);
		border: none;
		border-radius: var(--cs-radius-md);
		padding: 0.6rem 1rem;
		font-weight: 700;
		font-size: 0.85rem;
		width: fit-content;
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
	}

	/* Hide built-in legend for stock chart as we have a custom one */
	#cs-chart-stock .chart-legend {
		display: none !important;
	}

	#cs-chart-stock .graph-svg-tip {
		z-index: 9999;
		/* Ensure tooltip is above custom legend */
	}

	/* Movement chart spacing and axis labels */
	#cs-chart-movements,
	#cs-chart-movements .chart-container,
	#cs-chart-movements svg,
	#cs-chart-movements svg * {
		overflow: visible !important;
	}

	#cs-chart-movements {
		padding-bottom: 0 !important;
		margin-bottom: 0 !important;
	}

	/* Hide built-in legend for movements chart */
	#cs-chart-movements .chart-legend {
		display: none !important;
	}

	#cs-chart-movements .x.axis text {
		transform: rotate(90deg) translateX(7px) translateY(-2px) !important;
		transform-box: fill-box !important;
		transform-origin: center left !important;
		text-anchor: start !important;
		dominant-baseline: middle !important;
		font-size: 0.64rem !important;
		font-weight: 600;
		letter-spacing: 0;
		white-space: nowrap;
	}

	#cs-chart-movements-legend {
		display: flex;
		justify-content: center;
		gap: 1rem;
		margin-top: 0.2rem;
	}

	/* Hide default Frappe footer on the portal */
	footer,
	.web-footer {
		display: none !important;
	}

	/* Smooth scroll for nav jumps */
	html {
		scroll-behavior: smooth;
	}
</style>

<section class="client-portal">
	<div class="cs-shell" id="cs-shell">
		<header class="cs-topbar cs-animate" data-delay="1">
			<div class="cs-brand">
				<span class="cs-eyebrow">Cold Storage Network</span>
				<h1 class="cs-title">Client Operations Portal</h1>
				<p class="cs-subtitle">
					A full-width workspace for stock visibility, movement tracking, billing insight, and report access.
				</p>
				<div class="cs-system-state is-loading" id="cs-system-state">
					<span class="cs-system-dot" aria-hidden="true"></span>
					<span id="cs-system-state-text">Initializing live snapshot...</span>
				</div>
			</div>
			<div class="cs-controls">
				<div class="cs-field d-none" id="cs-customer-filter-wrap">
					<label class="cs-label" for="cs-customer-filter">Customer Scope</label>
					<select class="cs-select" id="cs-customer-filter"></select>
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-global-search">Global Search</label>
					<input class="cs-input" id="cs-global-search" type="search"
						placeholder="Search across all portal sections" />
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-new-request-btn">Actions</label>
					<button class="cs-btn cs-btn-primary" id="cs-new-request-btn" type="button">
						<span class="cs-btn-dot" aria-hidden="true"></span>
						New Request
					</button>
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-refresh-btn">Data Controls</label>
					<div class="d-flex gap-2">
						<button class="cs-btn flex-grow-1" id="cs-refresh-btn" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Refresh
						</button>
						<div class="cs-refresh-meta flex-grow-1" id="cs-last-refresh">Loading...</div>
					</div>
				</div>
			</div>
		</header>

		<nav class="cs-nav cs-animate" data-delay="2" aria-label="Portal sections">
			<button class="cs-chip cs-chip-active" type="button" data-section="stock" data-jump="#cs-section-stock"
				aria-current="true">
				Stock
				<span class="cs-chip-count" id="cs-nav-stock-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="movements" data-jump="#cs-section-movements">
				Movements
				<span class="cs-chip-count" id="cs-nav-movement-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="invoices" data-jump="#cs-section-invoices">
				Invoices
				<span class="cs-chip-count" id="cs-nav-invoice-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="reports" data-jump="#cs-section-reports">
				Reports
				<span class="cs-chip-count" id="cs-nav-report-count">0</span>
			</button>
			<button class="cs-chip cs-chip-main" type="button" id="cs-focus-search-btn">Focus Search (/)</button>
			<button class="cs-chip cs-chip-secondary" type="button" id="cs-snapshot-btn" onclick="downloadSnapshot()"
				style="margin-left: 0.5rem; background: linear-gradient(135deg, var(--cs-accent), var(--cs-accent-hover)); color: white; border-color: var(--cs-accent-hover); box-shadow: 0 2px 8px rgba(13,148,136,0.25);">
				<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
					stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
					<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
					<polyline points="7 10 12 15 17 10"></polyline>
					<line x1="12" y1="15" x2="12" y2="3"></line>
				</svg>
				Download Snapshot
			</button>
			<button class="cs-chip cs-chip-secondary" type="button" id="cs-snapshot-ur-btn"
				onclick="downloadSnapshotUrdu()"
				style="margin-left: 0.25rem; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; border-color: #6d28d9; box-shadow: 0 2px 8px rgba(124,58,237,0.25);">
				<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
					stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
					<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
					<polyline points="7 10 12 15 17 10"></polyline>
					<line x1="12" y1="15" x2="12" y2="3"></line>
				</svg>
				 PDF
			</button>
		</nav>

		<section class="cs-kpi-grid cs-animate" data-delay="2">
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Stock Rows</div>
				<div class="cs-kpi-value" id="cs-kpi-stock-rows">0</div>
			</div>
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Total Quantity</div>
				<div class="cs-kpi-value" id="cs-kpi-total-qty">0</div>
			</div>
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Movements</div>
				<div class="cs-kpi-value" id="cs-kpi-movements">0</div>
			</div>
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Invoices</div>
				<div class="cs-kpi-value" id="cs-kpi-invoices">0</div>
			</div>
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Outstanding</div>
				<div class="cs-kpi-value" id="cs-kpi-outstanding">0</div>
			</div>
			<div class="cs-kpi" data-icon="">
				<div class="cs-kpi-label">Reports</div>
				<div class="cs-kpi-value" id="cs-kpi-reports">0</div>
			</div>
		</section>

		<div class="cs-banner cs-banner-info d-none cs-animate" data-delay="2" id="cs-customers"></div>
		<div class="cs-banner cs-banner-warn d-none cs-animate" data-delay="2" id="cs-empty-state">
			No customers found for this user scope.
		</div>

		<section class="cs-charts-grid cs-animate" data-delay="3" id="cs-dashboard-charts">
			<article class="cs-chart-card">
				<h3 class="cs-chart-title">Top Batches (Stock)</h3>
				<div class="cs-chart-wrapper" style="display: flex; align-items: center;">
					<div id="cs-chart-stock-legend" style="width: 35%; padding-right: 10px; font-size: 11px;"></div>
					<div id="cs-chart-stock" style="flex: 1;"></div>
				</div>
			</article>
			<article class="cs-chart-card">
				<h3 class="cs-chart-title">Movement Trends (30 Days)</h3>
				<div id="cs-chart-movements"></div>
				<div id="cs-chart-movements-legend"></div>
			</article>

		</section>

		<section class="cs-layout">
			<article class="cs-board cs-section cs-animate" data-delay="1" id="cs-section-stock" data-section="stock"
				data-span="6">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Current Stock</h2>
						<div class="cs-board-meta" id="cs-stock-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="stock" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools">
					<input class="cs-input cs-section-search" id="cs-stock-search" type="search"
						placeholder="Search customer, item, batch, warehouse" />
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-stock-table">
						<thead>
							<tr>
								<th>Customer</th>
								<th>Item</th>
								<th>Batch</th>
								<th>Warehouse</th>
								<th class="text-end">Qty</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="1" id="cs-section-movements"
				data-section="movements" data-span="6">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Recent Movements</h2>
						<div class="cs-board-meta" id="cs-movement-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="movements" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools d-flex gap-2 align-items-center flex-wrap">
					<input class="cs-input cs-section-search flex-grow-1" id="cs-movement-search" type="search"
						placeholder="Search movement type, document, customer..." />
					<div class="d-flex gap-2 align-items-center">
						<input class="cs-input" type="date" id="cs-mov-start" title="Start Date">
						<span class="cs-muted">-</span>
						<input class="cs-input" type="date" id="cs-mov-end" title="End Date">
					</div>
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-movement-table">
						<thead>
							<tr>
								<th>Date</th>
								<th>Type</th>
								<th>Document</th>
								<th>Customer</th>
								<th class="text-end">Qty</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="2" id="cs-section-invoices"
				data-section="invoices" data-span="12">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Invoices</h2>
						<div class="cs-board-meta" id="cs-invoice-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="invoices" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools d-flex flex-column gap-2">
					<input class="cs-input cs-section-search" id="cs-invoice-search" type="search"
						placeholder="Search invoice, customer, status, currency" />
					<div class="d-flex gap-2 flex-wrap" id="cs-invoice-filters">
						<button class="cs-chip cs-chip-active" type="button" data-status="">All</button>
						<button class="cs-chip" type="button" data-status="paid">Paid</button>
						<button class="cs-chip" type="button" data-status="pending">Pending</button>
						<button class="cs-chip" type="button" data-status="overdue">Overdue</button>
					</div>
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-invoice-table">
						<thead>
							<tr>
								<th>Invoice</th>
								<th>Date</th>
								<th>Due Date</th>
								<th>Customer</th>
								<th>Currency</th>
								<th class="text-end">Grand Total</th>
								<th class="text-end">Outstanding</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="3" id="cs-section-reports"
				data-section="reports" data-span="12">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Reports</h2>
						<div class="cs-board-meta" id="cs-report-count">0 rows</div>
					</div>
				</header>
				<div class="cs-tools">
					<input class="cs-input cs-section-search" id="cs-report-search" type="search"
						placeholder="Search report name or description" />
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-report-table">
						<thead>
							<tr>
								<th>Report</th>
								<th>Description</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>
		</section>

		<div class="cs-modal-overlay d-none" id="cs-request-modal">
			<div class="cs-modal">
				<div class="cs-modal-header">
					<h3 class="cs-modal-title">New Service Request</h3>
					<button class="cs-btn cs-btn-sm" id="cs-modal-close" type="button">Close</button>
				</div>
				<div class="cs-modal-body">
					<div class="cs-field">
						<label class="cs-label">Customer</label>
						<select class="cs-select" id="cs-req-customer">
							<option value="">-- Select Customer --</option>
						</select>
					</div>
					<div class="cs-field">
						<label class="cs-label">Request Type</label>
						<select class="cs-select" id="cs-req-type">
							<option value="Inward">Inward (Receipt)</option>
							<option value="Outward">Outward (Dispatch)</option>
						</select>
					</div>
					<div class="cs-field">
						<label class="cs-label">Required Date</label>
						<input class="cs-input" type="date" id="cs-req-date">
					</div>
					<div class="cs-field">
						<label class="cs-label">Items</label>
						<div class="cs-req-items" id="cs-req-items">
							<!-- Items will be added here -->
						</div>
						<button class="cs-btn cs-btn-sm mt-2" id="cs-add-item-btn" type="button">+ Add Item</button>
					</div>
				</div>
				<div class="cs-modal-footer">
					<button class="cs-btn cs-btn-primary" id="cs-submit-request-btn" type="button">Submit
						Request</button>
				</div>
				<datalist id="item-list"></datalist>
			</div>
		</div>
	</div>
	<!-- Details Modal -->
	<div class="cs-modal-overlay d-none" id="cs-details-modal">
		<div class="cs-modal">
			<div class="cs-modal-header">
				<h2 class="cs-modal-title" id="cs-details-title">Document Details</h2>
				<button class="cs-btn cs-btn-sm" onclick="toggleDetailsModal(false)">&times;</button>
			</div>
			<div class="cs-modal-body" id="cs-details-body">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<div>
						<h4 class="m-0" id="cs-details-name"></h4>
						<div class="cs-text-muted" id="cs-details-date"></div>
					</div>
					<span class="cs-pill" id="cs-details-status"></span>
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table">
						<thead>
							<tr>
								<th>Item</th>
								<th>Qty</th>
								<th>Batch</th>
							</tr>
						</thead>
						<tbody id="cs-details-items"></tbody>
					</table>
				</div>
			</div>
			<div class="cs-modal-footer justify-content-between">
				<button class="cs-btn" id="cs-details-print">
					<span class="cs-btn-dot"></span> Print / Download
				</button>
				<button class="cs-btn" onclick="toggleDetailsModal(false)">Close</button>
			</div>
		</div>
	</div>

	<div class="cs-toast-container" id="cs-toast-container"></div>
</section>

<script>
	(() => {
		const snapshotMethod = "cold_storage.api.client_portal.get_snapshot";


		const downloadMethods = {
			stock: "/api/method/cold_storage.api.client_portal.download_stock_csv",
			movements: "/api/method/cold_storage.api.client_portal.download_movements_csv",
			invoices: "/api/method/cold_storage.api.client_portal.download_invoices_csv",
		};

		let selectedCustomer = "";
		const state = {
			customers: [],
			stock: [],
			movements: [],
			invoices: [],
			reports: [],
		};

		const searchTerms = {
			global: "",
			stock: "",
			movements: "",
			invoices: "",
			reports: "",
		};

		const shell = document.getElementById("cs-shell");
		const stockBody = document.querySelector("#cs-stock-table tbody");
		const movementBody = document.querySelector("#cs-movement-table tbody");
		const invoiceBody = document.querySelector("#cs-invoice-table tbody");
		const reportBody = document.querySelector("#cs-report-table tbody");

		const stockCount = document.getElementById("cs-stock-count");
		const movementCount = document.getElementById("cs-movement-count");
		const invoiceCount = document.getElementById("cs-invoice-count");
		const reportCount = document.getElementById("cs-report-count");

		const navStockCount = document.getElementById("cs-nav-stock-count");
		const navMovementCount = document.getElementById("cs-nav-movement-count");
		const navInvoiceCount = document.getElementById("cs-nav-invoice-count");
		const navReportCount = document.getElementById("cs-nav-report-count");

		const customersBanner = document.getElementById("cs-customers");
		const emptyState = document.getElementById("cs-empty-state");
		const systemState = document.getElementById("cs-system-state");
		const systemStateText = document.getElementById("cs-system-state-text");
		const refreshLabel = document.getElementById("cs-last-refresh");
		const refreshButton = document.getElementById("cs-refresh-btn");
		const focusSearchButton = document.getElementById("cs-focus-search-btn");
		const customerFilterWrap = document.getElementById("cs-customer-filter-wrap");
		const customerFilter = document.getElementById("cs-customer-filter");
		const globalSearchInput = document.getElementById("cs-global-search");

		const sectionButtons = Array.from(document.querySelectorAll(".cs-chip[data-jump]"));
		const sections = Array.from(document.querySelectorAll(".cs-section[data-section]"));

		const searchInputs = {
			stock: document.getElementById("cs-stock-search"),
			movements: document.getElementById("cs-movement-search"),
			invoices: document.getElementById("cs-invoice-search"),
			reports: document.getElementById("cs-report-search"),
		};

		const sectionSearchInputs = {
			stock: searchInputs.stock,
			movements: searchInputs.movements,
			invoices: searchInputs.invoices,
			reports: searchInputs.reports,
		};

		const kpiStockRows = document.getElementById("cs-kpi-stock-rows");
		const kpiTotalQty = document.getElementById("cs-kpi-total-qty");
		const kpiMovements = document.getElementById("cs-kpi-movements");
		const kpiInvoices = document.getElementById("cs-kpi-invoices");
		const kpiOutstanding = document.getElementById("cs-kpi-outstanding");
		const kpiReports = document.getElementById("cs-kpi-reports");

		const escapeHtml = (value) => {
			const text = String(value ?? "");
			return text
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#39;");
		};

		const toSearch = (value) => String(value ?? "").trim().toLowerCase();

		const formatDate = (value) => {
			if (!value) return "";
			const date = new Date(value);
			return Number.isNaN(date.getTime()) ? value : date.toLocaleDateString();
		};

		const formatNumber = (value) => {
			const num = Number(value || 0);
			return Number.isFinite(num)
				? num.toLocaleString(undefined, { maximumFractionDigits: 3 })
				: "0";
		};

		const formatMoney = (value) => {
			const num = Number(value || 0);
			if (!Number.isFinite(num)) return "0.00";
			return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
		};

		const setSystemState = (text, stateClass) => {
			if (systemStateText) {
				systemStateText.textContent = text;
			}
			if (!systemState) return;
			systemState.classList.remove("is-loading", "is-live", "is-error");
			if (stateClass) {
				systemState.classList.add(stateClass);
			}
		};

		const setRefreshButton = (label, isLoading) => {
			if (!refreshButton) return;
			refreshButton.disabled = Boolean(isLoading);
			refreshButton.innerHTML = `<span class="cs-btn-dot" aria-hidden="true"></span>${escapeHtml(label)}`;
		};

		const setPanelCount = (element, visibleRows, totalRows) => {
			if (!element) return;
			if (!totalRows) {
				element.textContent = "0 rows";
				return;
			}
			if (visibleRows === totalRows) {
				element.textContent = `${formatNumber(totalRows)} rows`;
				return;
			}
			element.textContent = `${formatNumber(visibleRows)} of ${formatNumber(totalRows)} rows`;
		};

		const setNavCount = (element, value) => {
			if (!element) return;
			element.textContent = formatNumber(value || 0);
		};

		const setActiveSection = (key) => {
			sectionButtons.forEach((button) => {
				const isActive = (button.getAttribute("data-section") || "") === key;
				button.classList.toggle("cs-chip-active", isActive);
				button.setAttribute("aria-current", isActive ? "true" : "false");
			});
		};

		const observeSections = () => {
			if (!sections.length || typeof IntersectionObserver === "undefined") return;
			const observer = new IntersectionObserver(
				(entries) => {
					const visible = entries
						.filter((entry) => entry.isIntersecting)
						.sort((a, b) => b.intersectionRatio - a.intersectionRatio);
					if (!visible.length) return;
					const key = visible[0].target.getAttribute("data-section") || "";
					if (key) setActiveSection(key);
				},
				{
					rootMargin: "-30% 0px -55% 0px",
					threshold: [0.2, 0.4, 0.6],
				}
			);
			sections.forEach((section) => observer.observe(section));
		};

		const isTypingContext = (element) => {
			if (!element) return false;
			const tagName = element.tagName || "";
			return (
				element.isContentEditable
				|| tagName === "INPUT"
				|| tagName === "TEXTAREA"
				|| tagName === "SELECT"
			);
		};

		const nearestSectionKey = () => {
			if (!sections.length) return "stock";
			const anchor = 150;
			let currentKey = sections[0].getAttribute("data-section") || "stock";
			let smallestGap = Number.POSITIVE_INFINITY;
			sections.forEach((section) => {
				const rect = section.getBoundingClientRect();
				const gap = Math.abs(rect.top - anchor);
				if (gap < smallestGap) {
					smallestGap = gap;
					currentKey = section.getAttribute("data-section") || currentKey;
				}
			});
			return currentKey;
		};

		const focusSectionSearch = (sectionKey) => {
			const input = sectionSearchInputs[sectionKey] || globalSearchInput;
			if (!input) return;
			input.focus({ preventScroll: true });
			input.select();
		};

		const linkCell = (value, route) => {
			if (!value) return "";
			if (!route) return escapeHtml(value);
			return `<a class="cs-link" href="${encodeURI(route)}" target="_blank" rel="noopener">${escapeHtml(value)}</a>`;
		};

		const emptyRow = (columns, label = "No records") =>
			`<tr><td colspan="${columns}" class="cs-empty-cell">${label}</td></tr>`;

		const getStatusClass = (value) => {
			const status = toSearch(value);
			if (!status) return "cs-pill--neutral";
			if (
				status.includes("paid")
				|| status.includes("completed")
				|| status.includes("success")
				|| status.includes("active")
			) {
				return "cs-pill--ok";
			}
			if (
				status.includes("overdue")
				|| status.includes("failed")
				|| status.includes("cancel")
				|| status.includes("rejected")
			) {
				return "cs-pill--danger";
			}
			if (
				status.includes("draft")
				|| status.includes("pending")
				|| status.includes("unpaid")
				|| status.includes("partly")
			) {
				return "cs-pill--warn";
			}
			return "cs-pill--neutral";
		};

		const statusPill = (value) => {
			const text = value || "Unknown";
			return `<span class="cs-pill ${getStatusClass(text)}">${escapeHtml(text)}</span>`;
		};

		const movementTypePill = (value) => {
			const type = value || "Movement";
			const search = toSearch(type);
			let className = "cs-pill--neutral";
			if (search.includes("inward")) className = "cs-pill--ok";
			if (search.includes("outward")) className = "cs-pill--warn";
			return `<span class="cs-pill ${className}">${escapeHtml(type)}</span>`;
		};

		const matches = (row, fields, term) => {
			if (!term) return true;
			return fields.some((field) => toSearch(row[field]).includes(term));
		};

		const filterRows = (rows, term, fields) => rows.filter((row) => (
			matches(row, fields, term)
			&& matches(row, fields, searchTerms.global)
		));

		const updateCustomerFilter = (customers, selected) => {
			if (!customerFilterWrap || !customerFilter) return;
			if (!customers.length || customers.length === 1) {
				customerFilterWrap.classList.add("d-none");
				customerFilter.innerHTML = "";
				return;
			}

			customerFilterWrap.classList.remove("d-none");
			customerFilter.innerHTML = "";

			const allOption = document.createElement("option");
			allOption.value = "";
			allOption.textContent = "All Customers";
			customerFilter.appendChild(allOption);

			customers.forEach((customer) => {
				const option = document.createElement("option");
				option.value = customer;
				option.textContent = customer;
				customerFilter.appendChild(option);
			});

			const target = customers.includes(selected) ? selected : "";
			customerFilter.value = target;
		};

		const updateKpis = (stock, movements, invoices, reports, totalOutstanding) => {
			const totalQty = stock.reduce((sum, row) => sum + Number(row.qty || 0), 0);
			// const totalOutstanding = invoices.reduce((sum, row) => sum + Number(row.outstanding_amount || 0), 0); // Deprecated

			kpiStockRows.textContent = formatNumber(stock.length);
			kpiTotalQty.textContent = formatNumber(totalQty);
			kpiMovements.textContent = formatNumber(movements.length);
			kpiInvoices.textContent = formatNumber(invoices.length);
			kpiOutstanding.textContent = formatMoney(totalOutstanding);
			kpiReports.textContent = formatNumber(reports.length);

			setNavCount(navStockCount, stock.length);
			setNavCount(navMovementCount, movements.length);
			setNavCount(navInvoiceCount, invoices.length);
			setNavCount(navReportCount, reports.length);
		};

		const renderStock = (rows, totalRows) => {
			setPanelCount(stockCount, rows.length, totalRows);
			if (!rows.length) {
				stockBody.innerHTML = emptyRow(5, totalRows ? "No records match your search" : "No records");
				return;
			}
			stockBody.innerHTML = rows
				.map(
					(row) => `
				<tr>
					<td>${escapeHtml(row.customer || "")}</td>
					<td>${escapeHtml(row.item_name || row.item_code || "")}</td>
					<td>${escapeHtml(row.batch_no || "")}</td>
					<td>${escapeHtml(row.warehouse || "")}</td>
					<td class="text-end">${formatNumber(row.qty)}</td>
				</tr>`
				)
				.join("");
		};

		const renderMovements = (rows, totalRows) => {
			setPanelCount(movementCount, rows.length, totalRows);
			if (!rows.length) {
				movementBody.innerHTML = emptyRow(5, totalRows ? "No records match your search" : "No records");
				return;
			}
			movementBody.innerHTML = rows
				.map(
					(row) => {
						return `
				<tr>
					<td>${formatDate(row.posting_date)}</td>
					<td>${movementTypePill(row.movement_type)}</td>
					<td>${escapeHtml(row.document_name || "")}</td>
					<td>${escapeHtml(row.customer || "")}</td>
					<td class="text-end fw-bold">${formatNumber(row.qty)}</td>
				</tr>
			`;
					}
				)
				.join("");
		};

		const renderInvoices = (rows, totalRows) => {
			setPanelCount(invoiceCount, rows.length, totalRows);
			if (!rows.length) {
				invoiceBody.innerHTML = emptyRow(8, totalRows ? "No records match your search" : "No records");
				return;
			}
			invoiceBody.innerHTML = rows
				.map(
					(row) => `
				<tr>
					<td>${linkCell(row.name, row.route)}</td>
					<td>${formatDate(row.posting_date)}</td>
					<td>${formatDate(row.due_date)}</td>
					<td>${escapeHtml(row.customer || "")}</td>
					<td>${escapeHtml(row.currency || "")}</td>
					<td class="text-end">${formatMoney(row.grand_total)}</td>
					<td class="text-end">${formatMoney(row.outstanding_amount)}</td>
					<td>${statusPill(row.status || "")}</td>
				</tr>`
				)
				.join("");
		};

		const buildMovementTrendData = (rows = [], dayWindow = 30) => {
			if (!Array.isArray(rows) || !rows.length) {
				return { labels: [], datasets: [] };
			}

			const pad2 = (value) => String(value).padStart(2, "0");
			const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
			const toIsoDate = (dateObj) =>
				`${dateObj.getFullYear()}-${pad2(dateObj.getMonth() + 1)}-${pad2(dateObj.getDate())}`;
			const formatLabel = (dateObj) => `${pad2(dateObj.getDate())} ${monthNames[dateObj.getMonth()]}`;

			const parsePostingDate = (value) => {
				const raw = String(value || "").trim();
				if (!raw) return null;

				const isoMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
				if (isoMatch) {
					const year = Number(isoMatch[1]);
					const month = Number(isoMatch[2]);
					const day = Number(isoMatch[3]);
					return new Date(year, month - 1, day);
				}

				const parsed = new Date(raw);
				if (Number.isNaN(parsed.getTime())) return null;
				return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
			};

			const cutoffDate = new Date();
			cutoffDate.setHours(0, 0, 0, 0);
			cutoffDate.setDate(cutoffDate.getDate() - dayWindow);

			const dateMap = {};

			rows.forEach((row) => {
				const movementType = String(row.movement_type || "").trim();
				if (movementType !== "Inward" && movementType !== "Outward") return;

				const postingDate = parsePostingDate(row.posting_date);
				if (!postingDate || postingDate < cutoffDate) return;

				const isoDate = toIsoDate(postingDate);
				if (!dateMap[isoDate]) {
					dateMap[isoDate] = { dateObj: postingDate, inward: 0, outward: 0 };
				}

				const qty = Number(row.qty) || 0;
				if (movementType === "Inward") {
					dateMap[isoDate].inward += qty;
				} else {
					dateMap[isoDate].outward += qty;
				}
			});

			const sortedIsoDates = Object.keys(dateMap).sort((a, b) => a.localeCompare(b));
			return {
				labels: sortedIsoDates.map((isoDate) => formatLabel(dateMap[isoDate].dateObj)),
				datasets: [
					{ name: "Inward", values: sortedIsoDates.map((isoDate) => dateMap[isoDate].inward) },
					{ name: "Outward", values: sortedIsoDates.map((isoDate) => dateMap[isoDate].outward) },
				],
			};
		};

		const renderCharts = (analytics) => {

			const stockChartEl = document.getElementById("cs-chart-stock");
			const trendChartEl = document.getElementById("cs-chart-movements");

			if (!window.frappe || !window.frappe.Chart) {
				const errMsg = "<div class='text-muted text-center p-4 small'>Chart library failed to load</div>";
				if (stockChartEl) stockChartEl.innerHTML = errMsg;
				if (trendChartEl) trendChartEl.innerHTML = errMsg;
				return;
			}

			if (!analytics) return;

			// Stock Composition
			if (stockChartEl) {
				// Clear previous
				stockChartEl.innerHTML = "";

				if (analytics.stock_composition && analytics.stock_composition.length > 0) {
					const colors = ['#0f766e', '#0d9488', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4', '#ccfbf1', '#f0fdfa', '#065f46', '#047857'];
					const legendEl = document.getElementById("cs-chart-stock-legend");
					if (legendEl) {
						const total = analytics.stock_composition.reduce((sum, d) => sum + d.value, 0);
						legendEl.innerHTML = analytics.stock_composition.map((d, i) => {
							const color = colors[i % colors.length];
							const pct = total > 0 ? ((d.value / total) * 100).toFixed(1) : 0;
							const name = d.name.length > 18 ? d.name.substring(0, 18) + '' : d.name;
							return `
								<div style="display: flex; align-items: center; margin-bottom: 6px; color: #555;">
									<span style="display: inline-block; width: 10px; height: 10px; background-color: ${color}; margin-right: 6px; border-radius: 2px; flex-shrink: 0;"></span>
									<div style="display: flex; flex-direction: column; line-height: 1.2;">
										<span title="${escapeHtml(d.name)}" style="font-weight: 500;">${escapeHtml(name)}</span>
										<span style="font-size: 10px; color: #777;">${formatNumber(d.value)} (${pct}%)</span>
									</div>
								</div>
							`;
						}).join("");
					}

					new frappe.Chart(stockChartEl, {
						data: {
							labels: analytics.stock_composition.map(d => d.name),
							datasets: [{ values: analytics.stock_composition.map(d => d.value) }]
						},
						type: 'donut',
						height: 450,
						colors: colors,
						strokeWidth: 80,
						tooltipOptions: {
							formatTooltipY: d => formatNumber(d)
						}
					});

				} else {
					stockChartEl.innerHTML = "<div class='text-muted text-center p-4'>No stock data</div>";
				}
			} else {
				console.error("[DEBUG] Stock chart element not found");
			}

			// Movement Trends
			// const trendChartEl = document.getElementById("cs-chart-movements"); // Already declared above
			if (trendChartEl) {
				// Clear previous
				trendChartEl.innerHTML = "";
				const trendLegendEl = document.getElementById("cs-chart-movements-legend");
				if (trendLegendEl) trendLegendEl.innerHTML = "";

				const normalizedTrendData = buildMovementTrendData(state.movements, 30);
				const trendData =
					normalizedTrendData && normalizedTrendData.labels && normalizedTrendData.labels.length > 0
						? normalizedTrendData
						: (analytics.movement_trends || { labels: [], datasets: [] });

				if (trendData && trendData.labels && trendData.labels.length > 0) {

					// Custom Legend
					if (trendLegendEl) {
						trendLegendEl.innerHTML = `
							<div style="display: flex; align-items: center; gap: 6px;">
								<span style="width: 8px; height: 8px; border-radius: 50%; background-color: #0f766e;"></span>
								<span style="font-size: 12px; font-weight: 600; color: #333;">Inward</span>
							</div>
							<div style="display: flex; align-items: center; gap: 6px;">
								<span style="width: 8px; height: 8px; border-radius: 50%; background-color: #f59e0b;"></span>
								<span style="font-size: 12px; font-weight: 600; color: #333;">Outward</span>
							</div>
						`;
					}

					new frappe.Chart(trendChartEl, {
						data: trendData,
						type: 'bar',
						height: 280,
						colors: ['#0f766e', '#f59e0b'],
						axisOptions: {
							xIsSeries: true,
							seriesLabelSpaceRatio: 2.8
						}
					});
				} else {
					trendChartEl.innerHTML = "<div class='text-muted text-center p-4'>No movement data</div>";
				}
			} else {
				console.error("[DEBUG] Trend chart element not found: cs-chart-movements");
			}
		};

		const renderReports = (rows, totalRows) => {
			setPanelCount(reportCount, rows.length, totalRows);
			if (!rows.length) {
				reportBody.innerHTML = emptyRow(
					3,
					totalRows ? "No reports match your search" : "No reports available for this user"
				);
				return;
			}
			reportBody.innerHTML = rows
				.map((row) => {
					const openRoute = row.route || "";
					const pdfRoute = row.pdf_route || _getReportPdfRoute(row.report_name || "", selectedCustomer);
					return `
					<tr>
						<td>${linkCell(row.label || row.report_name || "", openRoute)}</td>
						<td>${escapeHtml(row.description || "")}</td>
						<td class="text-end">
							<span class="cs-actions">
								<a
									class="cs-btn"
									href="${encodeURI(openRoute || "#")}"
									target="_blank"
									rel="noopener"
									aria-disabled="${openRoute ? "false" : "true"}"
								>
									<span class="cs-btn-dot" aria-hidden="true"></span>
									Open
								</a>
								<a
									class="cs-btn"
									href="${encodeURI(pdfRoute || "#")}"
									target="_blank"
									rel="noopener"
									aria-disabled="${pdfRoute ? "false" : "true"}"
								>
									<span class="cs-btn-dot" aria-hidden="true"></span>
									PDF
								</a>
							</span>
						</td>
					</tr>`;
				})
				.join("");
		};

		const movStartInput = document.getElementById("cs-mov-start");
		const movEndInput = document.getElementById("cs-mov-end");

		const filterMovementsByDate = (rows) => {
			const start = movStartInput.value ? new Date(movStartInput.value) : null;
			const end = movEndInput.value ? new Date(movEndInput.value) : null;

			if (!start && !end) return rows;

			return rows.filter(row => {
				const date = new Date(row.posting_date);
				if (start && date < start) return false;
				if (end && date > end) return false;
				return true;
			});
		};

		const invoiceFilters = document.getElementById("cs-invoice-filters");
		let activeInvoiceFilter = "";

		const filterInvoicesByStatus = (rows) => {
			if (!activeInvoiceFilter) return rows;
			return rows.filter(row => {
				const status = toSearch(row.status);
				return status.includes(activeInvoiceFilter);
			});
		};

		const renderAll = () => {
			const stockRows = filterRows(state.stock, searchTerms.stock, [
				"customer", "item_name", "item_code", "batch_no", "warehouse"
			]);

			let movementRows = filterRows(state.movements, searchTerms.movements, [
				"movement_type", "document_name", "customer", "reference"
			]);
			movementRows = filterMovementsByDate(movementRows);

			let invoiceRows = filterRows(state.invoices, searchTerms.invoices, [
				"name", "posting_date", "due_date", "customer", "currency", "status"
			]);
			invoiceRows = filterInvoicesByStatus(invoiceRows);

			// ... existing rendering ...
			// ... existing rendering ...
			updateKpis(stockRows, movementRows, invoiceRows, state.reports, state.total_outstanding || 0); // Use filtered rows for KPIs? Maybe total is better.
			// Let's use total for KPIs to show "Overview", but filtered for table
			// Actually KPIs usually reflect view. Let's keep it simple for now.

			renderStock(stockRows, state.stock.length);
			renderMovements(movementRows, state.movements.length);
			renderInvoices(invoiceRows, state.invoices.length);
			renderReports(filterRows(state.reports, searchTerms.reports, ["label", "report_name", "description"]), state.reports.length);
		};

		if (movStartInput) movStartInput.addEventListener("change", renderAll);
		if (movEndInput) movEndInput.addEventListener("change", renderAll);

		if (invoiceFilters) {
			invoiceFilters.addEventListener("click", (e) => {
				const btn = e.target.closest(".cs-chip");
				if (!btn) return;

				// Update active state
				invoiceFilters.querySelectorAll(".cs-chip").forEach(b => b.classList.remove("cs-chip-active"));
				btn.classList.add("cs-chip-active");

				activeInvoiceFilter = btn.getAttribute("data-status") || "";
				renderAll();
			});
		}

		const getDownloadEndpoint = (key) => {
			const endpoint = downloadMethods[key];
			if (!endpoint) return "";
			if (!selectedCustomer) return endpoint;
			const query = new URLSearchParams({ customer: selectedCustomer }).toString();
			return `${endpoint}?${query}`;
		};

		const _getReportPdfRoute = (reportName, customer = "") => {
			const cleanReportName = String(reportName || "").trim();
			if (!cleanReportName) return "";
			const queryArgs = new URLSearchParams({ report_name: cleanReportName });
			if (customer) {
				queryArgs.set("customer", customer);
			}
			return `/api/method/cold_storage.api.client_portal.download_report_pdf?${queryArgs.toString()}`;
		};

		const callApi = async (method, args = {}) => {
			if (typeof frappe !== "undefined" && frappe.call) {
				return frappe.call({ method, args });
			}

			const query = new URLSearchParams(args).toString();
			const response = await fetch(`/api/method/${method}${query ? `?${query}` : ""}`, {
				method: "GET",
				credentials: "include",
			});
			if (!response.ok) {
				throw new Error("Request failed");
			}
			return response.json();
		};



		const setLoading = (loading) => {
			if (loading) {
				shell.classList.add("is-loading-data");
				setSystemState("Syncing...", "is-loading");
			} else {
				shell.classList.remove("is-loading-data");
				setSystemState("Live snapshot synced", "is-live");
			}
		};

		const loadSnapshot = async () => {
			setLoading(true);
			try {
				const res = await callApi(snapshotMethod, {
					limit: 1000,
					customer: selectedCustomer // Pass scope
				});
				const data = res.message || {};

				const availableCustomers = data.available_customers || data.customers || [];
				selectedCustomer = data.selected_customer || "";
				updateCustomerFilter(availableCustomers, selectedCustomer);

				state.customers = data.customers || [];
				state.stock = data.stock || [];
				state.movements = data.movements || [];
				state.invoices = data.invoices || [];
				state.reports = data.reports || [];
				state.analytics = data.analytics || {};
				state.total_outstanding = data.total_outstanding || 0;

				if (state.customers.length) {
					customersBanner.classList.remove("d-none");
					if (selectedCustomer) {
						customersBanner.textContent = `Customer Scope: ${selectedCustomer}`;
					} else {
						const preview = state.customers.length > 10
							? `${state.customers.slice(0, 10).join(", ")} (+${state.customers.length - 10} more)`
							: state.customers.join(", ");
						customersBanner.textContent = `Customer Scope: ${preview}`;
					}
					emptyState.classList.add("d-none");
				} else {
					customersBanner.classList.add("d-none");
					emptyState.classList.remove("d-none");
				}

				updateCustomerFilter(availableCustomers, selectedCustomer);
				updateItemList(); // Refresh Item Datalist

				if (window.updateAnnouncement) updateAnnouncement(data.announcement);

				// Set company name in eyebrow
				if (data.company_name) {
					const eyebrow = document.querySelector(".cs-eyebrow");
					if (eyebrow) eyebrow.textContent = data.company_name;
				}


				renderAll();
				renderCharts(state.analytics);

				refreshLabel.textContent = `Last refresh: ${new Date().toLocaleString()}`;
				setLoading(false);
				shell.classList.add("cs-loaded");
			} catch (error) {
				refreshLabel.textContent = "Unable to load data.";
				setSystemState("Snapshot unavailable", "is-error");
				if (typeof frappe !== "undefined" && frappe.msgprint) {
					frappe.msgprint({
						title: "Client Portal",
						indicator: "red",
						message: "Could not load client portal data.",
					});
				}
			} finally {
				setRefreshButton("Refresh", false);
			}
		};

		if (customerFilter) {
			customerFilter.addEventListener("change", () => {
				selectedCustomer = customerFilter.value || "";
				loadSnapshot();
			});
		}

		if (globalSearchInput) {
			globalSearchInput.addEventListener("input", () => {
				searchTerms.global = toSearch(globalSearchInput.value);
				renderAll();
			});
		}

		Object.entries(searchInputs).forEach(([key, input]) => {
			if (!input) return;
			input.addEventListener("input", () => {
				searchTerms[key] = toSearch(input.value);
				renderAll();
			});
		});

		sectionButtons.forEach((button) => {
			button.addEventListener("click", () => {
				const selector = button.getAttribute("data-jump") || "";
				const target = selector ? document.querySelector(selector) : null;
				setActiveSection(button.getAttribute("data-section") || "");
				if (!target) return;
				target.scrollIntoView({ behavior: "smooth", block: "start" });
			});
		});

		document.addEventListener("keydown", (event) => {
			if (isTypingContext(event.target)) return;
			if (event.key !== "/") return;
			event.preventDefault();
			focusSectionSearch(nearestSectionKey());
		});

		if (focusSearchButton) {
			focusSearchButton.addEventListener("click", () => {
				focusSectionSearch(nearestSectionKey());
			});
		}

		if (refreshButton) {
			refreshButton.addEventListener("click", () => {
				loadSnapshot();
			});
		}

		document.querySelectorAll("[data-download]").forEach((button) => {
			button.addEventListener("click", () => {
				const key = button.getAttribute("data-download") || "";
				const endpoint = getDownloadEndpoint(key);
				if (!endpoint) return;
				window.open(endpoint, "_blank", "noopener");
			});
		});



		// Request Modal Logic
		const requestModal = document.getElementById("cs-request-modal");
		const newRequestBtn = document.getElementById("cs-new-request-btn");
		const closeModalBtn = document.getElementById("cs-modal-close");
		const reqTypeInput = document.getElementById("cs-req-type");
		const reqDateInput = document.getElementById("cs-req-date");
		const reqItemsContainer = document.getElementById("cs-req-items");
		const addItemBtn = document.getElementById("cs-add-item-btn");
		const submitRequestBtn = document.getElementById("cs-submit-request-btn");
		const itemList = document.getElementById("item-list");

		const reqCustomerInput = document.getElementById("cs-req-customer");

		let availableItems = []; // Cache for current available items

		const getModalCustomer = () => {
			// Use modal customer dropdown first, then selectedCustomer, then first available
			return (reqCustomerInput && reqCustomerInput.value)
				|| selectedCustomer
				|| (state.customers && state.customers.length > 0 ? state.customers[0] : "");
		};

		const updateItemList = async () => {
			const customer = getModalCustomer();

			if (!customer) {
				availableItems = [];
				// Update any existing dropdowns to show no items
				document.querySelectorAll(".cs-req-item-row .item-code-select").forEach(sel => {
					sel.innerHTML = '<option value="">-- Select Customer First --</option>';
				});
				return;
			}

			const type = reqTypeInput.value;
			itemList.innerHTML = ""; // Clear datalist

			try {
				const res = await callApi("cold_storage.api.client_portal.get_available_items", {
					customer: customer,
					request_type: type
				});
				availableItems = res.message || [];

				// Update datalist for any text inputs
				availableItems.forEach(code => {
					const option = document.createElement("option");
					option.value = code;
					itemList.appendChild(option);
				});

				// Update all existing select dropdowns in item rows
				document.querySelectorAll(".cs-req-item-row .item-code-select").forEach(sel => {
					const currentVal = sel.value;
					sel.innerHTML = '<option value="">-- Select Item --</option>' +
						availableItems.map(code =>
							`<option value="${escapeHtml(code)}"${code === currentVal ? ' selected' : ''}>${escapeHtml(code)}</option>`
						).join("");
				});
			} catch (err) {
				console.error("Failed to load items:", err);
				availableItems = [];
			}
		};

		const populateModalCustomers = () => {
			if (!reqCustomerInput) return;
			const customers = state.customers || [];
			reqCustomerInput.innerHTML = '';

			if (customers.length <= 1) {
				// Single customer - auto select and hide
				if (customers.length === 1) {
					reqCustomerInput.innerHTML = `<option value="${escapeHtml(customers[0])}">${escapeHtml(customers[0])}</option>`;
					reqCustomerInput.value = customers[0];
				}
				reqCustomerInput.closest('.cs-field').style.display = customers.length === 0 ? 'none' : '';
			} else {
				// Multiple customers - show selection
				reqCustomerInput.innerHTML = '<option value="">-- Select Customer --</option>' +
					customers.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
				// Pre-select if a customer is already selected in the main dropdown
				if (selectedCustomer && customers.includes(selectedCustomer)) {
					reqCustomerInput.value = selectedCustomer;
				}
				reqCustomerInput.closest('.cs-field').style.display = '';
			}
		};

		const toggleModal = (show) => {
			if (!requestModal) return;
			requestModal.classList.toggle("d-none", !show);
			if (show) {
				// Reset form
				reqTypeInput.value = "Inward"; // Always start with Inward
				reqDateInput.value = new Date().toISOString().split("T")[0];
				reqItemsContainer.innerHTML = "";
				populateModalCustomers();
				updateItemList().then(() => addRequestItemRow()); // Fetch items first, then add row
			}
		};

		if (reqTypeInput) {
			reqTypeInput.addEventListener("change", () => {
				// Clear existing rows and refresh items for new type
				reqItemsContainer.innerHTML = "";
				updateItemList().then(() => addRequestItemRow());
			});
		}

		if (reqCustomerInput) {
			reqCustomerInput.addEventListener("change", () => {
				// Clear existing rows and refresh items for new customer
				reqItemsContainer.innerHTML = "";
				updateItemList().then(() => addRequestItemRow());
			});
		}

		const addRequestItemRow = () => {
			const row = document.createElement("div");
			row.className = "cs-req-item-row";
			row.innerHTML = `
				<div class="cs-field">
					<select class="cs-select item-code-select">
						<option value="">-- Select Item --</option>
						${availableItems.map(code =>
				`<option value="${escapeHtml(code)}">${escapeHtml(code)}</option>`
			).join("")}
					</select>
				</div>
				<div class="cs-field">
					<select class="cs-select item-batch-select">
						<option value="">-- Select Batch --</option>
					</select>
				</div>
				<div class="cs-field">
					<input class="cs-input item-qty" type="number" placeholder="Qty" step="0.01">
				</div>
				<button class="cs-btn cs-btn-sm remove-row" type="button">&times;</button>
			`;

			row.querySelector(".remove-row").addEventListener("click", () => {
				row.remove();
			});

			// When item changes, fetch batches for that item
			const itemSelect = row.querySelector(".item-code-select");
			const batchSelect = row.querySelector(".item-batch-select");
			itemSelect.addEventListener("change", async () => {
				const itemCode = itemSelect.value;
				const customer = getModalCustomer();
				const type = reqTypeInput.value;
				batchSelect.innerHTML = '<option value="">Loading...</option>';

				if (!itemCode || !customer) {
					batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
					return;
				}

				try {
					const res = await callApi("cold_storage.api.client_portal.get_available_batches", {
						customer: customer,
						item_code: itemCode,
						request_type: type
					});
					const batches = res.message || [];
					batchSelect.innerHTML = '<option value="">-- Select Batch --</option>' +
						batches.map(b =>
							`<option value="${escapeHtml(b.batch_no)}">${escapeHtml(b.batch_no)} (Qty: ${formatNumber(b.qty)})</option>`
						).join("");
				} catch (err) {
					console.error("Failed to load batches:", err);
					batchSelect.innerHTML = '<option value="">-- No Batches --</option>';
				}
			});

			reqItemsContainer.appendChild(row);
		};

		// Toast Logic
		const showToast = (message, type = 'info') => {
			const container = document.getElementById('cs-toast-container');
			if (!container) return;

			const toast = document.createElement('div');
			toast.className = `cs-toast is-${type}`;
			toast.innerHTML = `
			<span class="cs-toast-icon">${type === 'success' ? '' : (type === 'error' ? '' : '')}</span>
			<span>${escapeHtml(message)}</span>
		`;

			container.appendChild(toast);

			// Auto remove
			setTimeout(() => {
				toast.style.animation = 'toastSlideOut 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards';
				setTimeout(() => toast.remove(), 300);
			}, 4000);
		};

		// Quick Action Card Listener
		const quickActionCard = document.getElementById("cs-quick-action-request");
		if (quickActionCard) {
			quickActionCard.addEventListener("click", () => toggleModal(true));
		}

		const submitServiceRequest = async () => {
			const type = reqTypeInput.value;
			const date = reqDateInput.value;
			const items = [];

			document.querySelectorAll(".cs-req-item-row").forEach(row => {
				const codeEl = row.querySelector(".item-code-select") || row.querySelector(".item-code");
				const code = codeEl ? codeEl.value : "";
				const batchEl = row.querySelector(".item-batch-select");
				const batch_no = batchEl ? batchEl.value : "";
				const qty = row.querySelector(".item-qty").value;
				if (code && qty > 0) {
					const item = { item_code: code, qty: qty };
					if (batch_no) item.batch_no = batch_no;
					items.push(item);
				}
			});

			if (!items.length) {
				showToast("Please add at least one item.", "error");
				return;
			}

			if (!getModalCustomer()) {
				showToast("No customer selected.", "error");
				return;
			}

			submitRequestBtn.disabled = true;
			submitRequestBtn.textContent = "Submitting...";

			try {
				const res = await callApi("cold_storage.api.client_portal.create_service_request", {
					request_type: type,
					customer: getModalCustomer(),
					items: items,
					required_date: date
				});

				showToast(res.message || "Request created successfully!", "success");
				toggleModal(false);
				loadSnapshot(); // Refresh data
			} catch (error) {
				console.error(error);
				showToast("Failed to submit request: " + error.message, "error");
			} finally {
				submitRequestBtn.disabled = false;
				submitRequestBtn.textContent = "Submit Request";
			}
		};

		if (newRequestBtn) newRequestBtn.addEventListener("click", () => toggleModal(true));
		if (closeModalBtn) closeModalBtn.addEventListener("click", () => toggleModal(false));
		if (addItemBtn) addItemBtn.addEventListener("click", addRequestItemRow);
		if (submitRequestBtn) submitRequestBtn.addEventListener("click", submitServiceRequest);

		setActiveSection("stock");
		observeSections();
		loadSnapshot();
		// Details Modal Logic
		const detailsModal = document.getElementById("cs-details-modal");
		const detailsTitle = document.getElementById("cs-details-title");
		const detailsName = document.getElementById("cs-details-name");
		const detailsDate = document.getElementById("cs-details-date");
		const detailsStatus = document.getElementById("cs-details-status");
		const detailsItems = document.getElementById("cs-details-items");
		const detailsPrint = document.getElementById("cs-details-print");

		let currentDoc = null;

		window.toggleDetailsModal = (show) => {
			if (detailsModal) detailsModal.classList.toggle("d-none", !show);
		}

		window.openDetails = async (doctype, docname) => {
			setLoading(true);
			try {
				const res = await callApi("cold_storage.api.client_portal.get_document_details", {
					doctype: doctype,
					docname: docname
				});
				const doc = res.message;
				currentDoc = doc;

				detailsName.textContent = doc.name;
				detailsDate.textContent = doc.posting_date;
				detailsStatus.innerHTML = statusPill(doc.status); // Use existing helper

				detailsItems.innerHTML = doc.items.map(item => `
				<tr>
					<td>
						<div class="fw-bold">${escapeHtml(item.item_code)}</div>
						<div class="small text-muted">${escapeHtml(item.item_name || "")}</div>
					</td>
					<td>${formatNumber(item.qty)} ${escapeHtml(item.uom || "")}</td>
					<td>${escapeHtml(item.batch_no || "-")}</td>
				</tr>
			`).join("");

				toggleDetailsModal(true);
			} catch (e) {
				showToast("Failed to load details: " + e.message, "error");
			} finally {
				setLoading(false);
			}
		}

		if (detailsPrint) {
			detailsPrint.addEventListener("click", () => {
				if (!currentDoc) return;
				// Open standard print view in new tab
				const url = `/api/method/frappe.www.printview.get_pdf?doctype=${encodeURIComponent(currentDoc.doctype)}&name=${encodeURIComponent(currentDoc.name)}&format=Standard&no_letterhead=0`;
				window.open(url, '_blank');
			});
		}

		// Update Announcement
		const updateAnnouncement = (text) => {
			const banner = document.getElementById("cs-announcement-banner");
			const content = document.getElementById("cs-announcement-text");
			if (banner && content) {
				if (text) {
					content.textContent = text;
					banner.classList.remove("d-none");
				} else {
					banner.classList.add("d-none");
				}
			}
		}


		// PDF Report Download
		window.downloadSnapshot = () => {
			showToast("Generating Executive Report...", "info");
			// Trigger PDF download from new API endpoint
			let url = "/api/method/cold_storage.api.client_portal.download_dashboard_report";
			if (selectedCustomer) {
				url += `?customer=${encodeURIComponent(selectedCustomer)}`;
			}
			// Use window.open to trigger download in new tab/window without navigating away
			window.open(url, '_blank');
		};

		// Urdu PDF Report Download
		window.downloadSnapshotUrdu = () => {
			showToast("     ...", "info");
			let url = "/api/method/cold_storage.api.client_portal.download_dashboard_report";
			let params = new URLSearchParams();
			params.set("lang", "ur");
			if (selectedCustomer) {
				params.set("customer", selectedCustomer);
			}
			window.open(`${url}?${params.toString()}`, '_blank');
		};
	})();
</script>
{% endblock %}