{% extends "templates/web.html" %}

{% block page_content %}
<style>
	@import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700&display=swap");

	#page-client-portal .page-content-wrapper {
		margin: 0;
	}

	#page-client-portal .page-header-wrapper {
		display: none;
	}

	#page-client-portal .page_content {
		min-height: 100vh;
	}

	.client-portal {
		/* Deep Navy & Teal Professional Palette */
		--cs-bg-1: #f4f7f6;
		--cs-bg-2: #e6eeeb;
		--cs-bg-3: #d5e4df;
		--cs-surface: #ffffff;
		--cs-surface-glass: rgba(255, 255, 255, 0.92);
		--cs-border: #e0e6e4;
		--cs-border-hover: #c8d6d2;
		--cs-headline: #111827;
		/* Gray 900 */
		--cs-copy: #374151;
		/* Gray 700 */
		--cs-muted: #6b7280;
		/* Gray 500 */

		--cs-accent: #0d9488;
		/* Teal 600 */
		--cs-accent-hover: #0f766e;
		/* Teal 700 */
		--cs-accent-subtle: #ccfbf1;
		/* Teal 100 */

		--cs-success: #10b981;
		--cs-warning: #f59e0b;
		--cs-error: #ef4444;

		--cs-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
		--cs-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
		--cs-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

		--cs-radius-sm: 0.375rem;
		--cs-radius-md: 0.5rem;
		--cs-radius-lg: 0.75rem;
		--cs-radius-xl: 1rem;

		position: relative;
		width: 100%;
		padding: 1.5rem;
		background: #f3f4f6;
		font-family: 'Inter', system-ui, -apple-system, sans-serif;
		color: var(--cs-copy);
		-webkit-font-smoothing: antialiased;
	}

	.client-portal::before,
	.client-portal::after {
		content: "";
		position: absolute;
		z-index: 0;
		pointer-events: none;
		border-radius: 999px;
		filter: blur(1px);
	}

	.client-portal::before {
		width: 34rem;
		height: 34rem;
		right: -13rem;
		top: -16rem;
		background: radial-gradient(circle, rgba(23, 136, 106, 0.2), rgba(23, 136, 106, 0));
	}

	.client-portal::after {
		width: 30rem;
		height: 30rem;
		left: -8rem;
		bottom: -12rem;
		background: radial-gradient(circle, rgba(15, 106, 84, 0.17), rgba(15, 106, 84, 0));
	}

	.cs-shell {
		position: relative;
		z-index: 1;
		width: 100%;
		max-width: none;
		display: grid;
		gap: 0.95rem;
	}

	.cs-topbar {
		display: grid;
		grid-template-columns: 1.25fr auto;
		gap: 1rem;
		padding: 1.1rem 1.15rem;
		border-radius: 1.1rem;
		border: 1px solid var(--cs-border);
		background:
			linear-gradient(150deg, rgba(255, 255, 255, 0.95), rgba(237, 246, 242, 0.82)),
			linear-gradient(60deg, var(--cs-bg-1), var(--cs-bg-2));
		box-shadow: var(--cs-shadow-strong);
		backdrop-filter: blur(6px);
	}

	.cs-brand {
		display: flex;
		flex-direction: column;
		gap: 0.4rem;
	}

	.cs-eyebrow {
		font-size: 0.7rem;
		font-weight: 700;
		letter-spacing: 0.08em;
		text-transform: uppercase;
		color: var(--cs-accent);
	}

	.cs-title {
		margin: 0;
		font-family: "Sora", "Manrope", sans-serif;
		font-size: clamp(1.35rem, 2.8vw, 2rem);
		font-weight: 700;
		letter-spacing: -0.02em;
		color: var(--cs-headline);
	}

	.cs-subtitle {
		margin: 0;
		max-width: 72ch;
		font-size: 0.9rem;
		font-weight: 500;
		color: var(--cs-muted);
	}

	.cs-system-state {
		display: inline-flex;
		align-items: center;
		gap: 0.45rem;
		padding: 0.36rem 0.56rem;
		width: fit-content;
		border-radius: 999px;
		font-size: 0.75rem;
		font-weight: 700;
		color: var(--cs-muted);
		border: 1px solid rgba(93, 127, 120, 0.28);
		background: rgba(255, 255, 255, 0.74);
	}

	.cs-system-dot {
		width: 0.47rem;
		height: 0.47rem;
		border-radius: 999px;
		background: #90a8a1;
		box-shadow: 0 0 0 3px rgba(144, 168, 161, 0.22);
	}

	.cs-system-state.is-loading .cs-system-dot {
		background: var(--cs-warn);
		box-shadow: 0 0 0 3px rgba(191, 127, 43, 0.22);
	}

	.cs-system-state.is-live .cs-system-dot {
		background: var(--cs-ok);
		box-shadow: 0 0 0 3px rgba(35, 154, 111, 0.24);
	}

	.cs-system-state.is-error .cs-system-dot {
		background: var(--cs-danger);
		box-shadow: 0 0 0 3px rgba(191, 76, 76, 0.22);
	}

	.cs-controls {
		display: grid;
		grid-template-columns: repeat(3, minmax(180px, 1fr));
		gap: 0.55rem;
		align-content: center;
	}

	.cs-field {
		display: flex;
		flex-direction: column;
		gap: 0.3rem;
	}

	.cs-label {
		font-size: 0.7rem;
		font-weight: 700;
		letter-spacing: 0.08em;
		text-transform: uppercase;
		color: var(--cs-muted);
	}

	.cs-select,
	.cs-input,
	.cs-btn {
		border-radius: 0.66rem;
		border: 1px solid var(--cs-border);
		padding: 0.48rem 0.6rem;
		font-size: 0.83rem;
		font-weight: 600;
	}

	.cs-select,
	.cs-input {
		background: rgba(255, 255, 255, 0.94);
		color: var(--cs-headline);
	}

	.cs-select:focus,
	.cs-input:focus {
		outline: none;
		border-color: var(--cs-accent);
		box-shadow: 0 0 0 3px var(--cs-focus);
	}

	.cs-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 0.4rem;
		background: linear-gradient(135deg, rgba(23, 136, 106, 0.12), rgba(23, 136, 106, 0.04));
		border-color: rgba(23, 136, 106, 0.32);
		color: var(--cs-accent-strong);
		text-decoration: none;
		transition: 0.2s ease;
	}

	.cs-btn:hover {
		background: rgba(23, 136, 106, 0.18);
		border-color: rgba(23, 136, 106, 0.5);
	}

	.cs-btn:disabled {
		opacity: 0.58;
		cursor: not-allowed;
	}

	.cs-btn-dot {
		width: 0.38rem;
		height: 0.38rem;
		border-radius: 999px;
		background: currentColor;
		opacity: 0.85;
	}

	.cs-refresh-meta {
		padding: 0.46rem 0.62rem;
		font-size: 0.76rem;
		font-weight: 600;
		color: var(--cs-muted);
		border: 1px dashed rgba(23, 136, 106, 0.28);
		border-radius: 0.66rem;
		background: rgba(255, 255, 255, 0.7);
	}

	.cs-nav {
		display: flex;
		flex-wrap: wrap;
		gap: 0.55rem;
		padding: 0.52rem;
		border-radius: 0.92rem;
		border: 1px solid var(--cs-border);
		background: rgba(255, 255, 255, 0.76);
		box-shadow: var(--cs-shadow-soft);
		backdrop-filter: blur(8px);
		position: sticky;
		top: 0.5rem;
		z-index: 9;
	}

	.cs-chip {
		display: inline-flex;
		align-items: center;
		gap: 0.44rem;
		border: 1px solid rgba(23, 136, 106, 0.24);
		background: rgba(255, 255, 255, 0.92);
		color: var(--cs-headline);
		border-radius: 999px;
		padding: 0.35rem 0.72rem;
		font-size: 0.78rem;
		font-weight: 700;
		transition: 0.2s ease;
	}

	.cs-chip::before {
		content: "";
		width: 0.42rem;
		height: 0.42rem;
		border-radius: 999px;
		background: rgba(23, 136, 106, 0.38);
		box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.6);
	}

	.cs-chip:hover {
		border-color: rgba(23, 136, 106, 0.42);
		background: rgba(23, 136, 106, 0.12);
	}

	.cs-chip-active {
		background: linear-gradient(130deg, rgba(23, 136, 106, 0.2), rgba(23, 136, 106, 0.08));
		border-color: rgba(23, 136, 106, 0.52);
		color: var(--cs-accent-strong);
	}

	.cs-chip-active::before {
		background: var(--cs-accent-strong);
	}

	.cs-chip-main {
		margin-left: auto;
		background: linear-gradient(130deg, rgba(23, 136, 106, 0.22), rgba(15, 106, 84, 0.18));
		border-color: rgba(15, 106, 84, 0.5);
		color: var(--cs-accent-strong);
	}

	.cs-chip-main::before {
		background: rgba(15, 106, 84, 0.85);
	}

	.cs-chip-count {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		min-width: 1.3rem;
		height: 1.3rem;
		padding: 0 0.34rem;
		border-radius: 999px;
		font-size: 0.7rem;
		font-weight: 800;
		color: var(--cs-muted);
		background: rgba(23, 136, 106, 0.14);
	}

	.cs-chip-active .cs-chip-count {
		color: var(--cs-accent-strong);
		background: rgba(23, 136, 106, 0.22);
	}

	.cs-kpi-grid {
		display: grid;
		grid-template-columns: repeat(6, minmax(0, 1fr));
		gap: 0.65rem;
	}

	.cs-kpi {
		position: relative;
		overflow: hidden;
		display: grid;
		gap: 0.28rem;
		padding: 0.86rem 0.88rem;
		border-radius: 0.9rem;
		border: 1px solid var(--cs-border);
		background: var(--cs-surface);
		box-shadow: var(--cs-shadow-soft);
	}

	.cs-kpi::before {
		content: "";
		position: absolute;
		inset: 0 0 auto;
		height: 3px;
		background: linear-gradient(90deg, rgba(23, 136, 106, 0.92), rgba(23, 136, 106, 0.26));
	}

	.cs-kpi-label {
		font-size: 0.69rem;
		font-weight: 800;
		letter-spacing: 0.08em;
		text-transform: uppercase;
		color: var(--cs-muted);
	}

	.cs-kpi-value {
		font-family: "Sora", "Manrope", sans-serif;
		font-size: clamp(1.05rem, 1.9vw, 1.4rem);
		font-weight: 700;
		color: var(--cs-headline);
	}

	.cs-banner {
		display: block;
		padding: 0.7rem 0.88rem;
		border-radius: 0.82rem;
		font-size: 0.86rem;
		font-weight: 600;
		border: 1px solid transparent;
		box-shadow: 0 10px 22px rgba(11, 52, 44, 0.08);
	}

	.cs-banner-info {
		background: rgba(23, 136, 106, 0.08);
		color: var(--cs-accent-strong);
		border-color: rgba(23, 136, 106, 0.28);
	}

	.cs-banner-warn {
		background: rgba(191, 127, 43, 0.1);
		color: var(--cs-warn);
		border-color: rgba(191, 127, 43, 0.3);
	}

	.cs-layout {
		display: grid;
		grid-template-columns: repeat(12, minmax(0, 1fr));
		gap: 0.72rem;
	}

	.cs-board {
		grid-column: span 12;
		height: 100%;
		border: 1px solid var(--cs-border);
		border-radius: 1rem;
		overflow: hidden;
		background: var(--cs-surface);
		box-shadow: var(--cs-shadow-soft);
		backdrop-filter: blur(6px);
	}

	.cs-board[data-span="6"] {
		grid-column: span 6;
	}

	.cs-board-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.7rem;
		padding: 0.84rem 0.96rem;
		border-bottom: 1px solid rgba(19, 84, 70, 0.11);
		background: linear-gradient(180deg, rgba(255, 255, 255, 0.88), rgba(245, 251, 248, 0.78));
	}

	.cs-board-head-main {
		display: flex;
		flex-direction: column;
		gap: 0.14rem;
	}

	.cs-board-title {
		margin: 0;
		font-family: "Sora", "Manrope", sans-serif;
		font-size: 0.98rem;
		font-weight: 700;
		color: var(--cs-headline);
	}

	.cs-board-meta {
		font-size: 0.72rem;
		font-weight: 700;
		color: var(--cs-muted);
	}

	.cs-board-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.45rem;
	}

	.cs-tools {
		padding: 0.56rem 0.92rem;
		border-bottom: 1px solid rgba(19, 84, 70, 0.1);
		background: rgba(248, 252, 250, 0.9);
	}

	.cs-section-search {
		width: 100%;
	}

	.cs-table-wrap {
		overflow: auto;
		max-height: 28rem;
	}

	.cs-table {
		margin: 0;
		min-width: 680px;
		font-size: 0.84rem;
	}

	.cs-table thead th {
		position: sticky;
		top: 0;
		z-index: 2;
		padding: 0.62rem 0.72rem;
		font-size: 0.69rem;
		font-weight: 800;
		letter-spacing: 0.07em;
		text-transform: uppercase;
		color: var(--cs-muted);
		background: rgba(235, 246, 242, 0.94);
		border-bottom: 1px solid rgba(19, 84, 70, 0.15);
		white-space: nowrap;
		backdrop-filter: blur(5px);
	}

	.cs-table tbody td {
		padding: 0.58rem 0.72rem;
		vertical-align: middle;
		color: #214239;
		border-top: 1px solid rgba(19, 84, 70, 0.08);
	}

	.cs-table tbody tr:nth-child(even) td {
		background: rgba(244, 250, 248, 0.54);
	}

	.cs-table tbody tr:hover td {
		background: rgba(23, 136, 106, 0.1);
	}

	.cs-link {
		color: var(--cs-accent-strong);
		font-weight: 700;
		text-decoration: none;
		text-underline-offset: 0.2em;
		text-decoration-thickness: 1px;
	}

	.cs-link:hover {
		text-decoration: underline;
	}

	.cs-pill {
		display: inline-flex;
		align-items: center;
		padding: 0.16rem 0.48rem;
		border-radius: 999px;
		font-size: 0.71rem;
		font-weight: 700;
		line-height: 1.2;
		border: 1px solid transparent;
	}

	.cs-pill--ok {
		background: rgba(35, 154, 111, 0.14);
		color: #166247;
		border-color: rgba(35, 154, 111, 0.3);
	}

	.cs-pill--warn {
		background: rgba(191, 127, 43, 0.16);
		color: #8a5a1e;
		border-color: rgba(191, 127, 43, 0.34);
	}

	.cs-pill--danger {
		background: rgba(191, 76, 76, 0.16);
		color: #8b3232;
		border-color: rgba(191, 76, 76, 0.34);
	}

	.cs-pill--neutral {
		background: rgba(48, 100, 90, 0.12);
		color: #215048;
		border-color: rgba(48, 100, 90, 0.3);
	}

	.cs-actions {
		display: inline-flex;
		align-items: center;
		gap: 0.38rem;
		justify-content: flex-end;
		flex-wrap: wrap;
	}

	.cs-empty-cell {
		padding: 0.95rem 0.72rem;
		text-align: center;
		color: var(--cs-muted);
		font-weight: 600;
	}

	.cs-btn[aria-disabled="true"] {
		opacity: 0.56;
		pointer-events: none;
	}

	.cs-section {
		scroll-margin-top: 6.5rem;
	}

	.cs-animate {
		opacity: 0;
		transform: translateY(12px);
	}

	.cs-loaded .cs-animate {
		animation: csFadeUp 0.52s ease forwards;
	}

	.cs-loaded .cs-animate[data-delay="1"] {
		animation-delay: 80ms;
	}

	.cs-loaded .cs-animate[data-delay="2"] {
		animation-delay: 160ms;
	}

	.cs-loaded .cs-animate[data-delay="3"] {
		animation-delay: 240ms;
	}

	@keyframes csFadeUp {
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@media (max-width: 1280px) {
		.cs-controls {
			grid-template-columns: repeat(2, minmax(180px, 1fr));
		}

		.cs-kpi-grid {
			grid-template-columns: repeat(3, minmax(0, 1fr));
		}
	}

	@media (max-width: 1040px) {
		.cs-topbar {
			grid-template-columns: 1fr;
		}

		.cs-controls {
			grid-template-columns: 1fr;
		}

		.cs-board[data-span="6"] {
			grid-column: span 12;
		}
	}

	@media (max-width: 760px) {
		.client-portal {
			padding: 0.7rem 0.55rem 1rem;
		}

		.cs-nav {
			top: 0.3rem;
			padding: 0.4rem;
		}

		.cs-chip {
			font-size: 0.73rem;
			padding: 0.32rem 0.62rem;
		}

		.cs-chip-main {
			margin-left: 0;
		}

		.cs-kpi-grid {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}

	@media (max-width: 520px) {
		.cs-kpi-grid {
			grid-template-columns: 1fr;
		}
	}

	@media (prefers-reduced-motion: reduce) {

		.cs-btn,
		.cs-chip,
		.cs-select,
		.cs-input,
		.cs-board {
			transition: none;
		}
	}

	/* Chart Grid */
	.cs-charts-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
		gap: 1.5rem;
		margin-bottom: 0.75rem;
	}

	.cs-chart-card {
		background: var(--cs-surface);
		border-radius: var(--cs-radius-xl);
		padding: 1.5rem;
		border: 1px solid var(--cs-border);
		box-shadow: var(--cs-shadow-sm);
	}

	.cs-chart-title {
		margin: 0 0 1rem 0;
		font-size: 0.95rem;
		font-weight: 600;
		color: var(--cs-headline);
	}

	/* Refined Board/Card Styles */
	.cs-board {
		background: var(--cs-surface);
		border: 1px solid var(--cs-border);
		border-radius: var(--cs-radius-xl);
		box-shadow: var(--cs-shadow-sm);
		overflow: hidden;
	}

	.cs-board-head {
		background: var(--cs-surface);
		border-bottom: 1px solid var(--cs-border);
		padding: 1.25rem 1.5rem;
	}

	.cs-btn-primary {
		background: var(--cs-accent);
		color: #ffffff;
		border-color: var(--cs-accent);
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}

	.cs-btn-primary:hover {
		background: var(--cs-accent-hover);
		color: #ffffff;
	}

	.cs-btn-primary .cs-btn-dot {
		background: #ffffff;
	}

	.cs-modal-overlay {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.4);
		backdrop-filter: blur(4px);
		z-index: 100;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1rem;
	}

	.cs-modal {
		background: var(--cs-surface);
		border-radius: var(--cs-radius-xl);
		box-shadow: var(--cs-shadow-lg);
		width: 100%;
		max-width: 550px;
		display: flex;
		flex-direction: column;
		gap: 1.2rem;
		padding: 2rem;
		max-height: 90vh;
		overflow-y: auto;
	}

	.cs-modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}

	.cs-modal-title {
		margin: 0;
		font-size: 1.25rem;
		font-weight: 700;
		color: var(--cs-headline);
	}

	.cs-req-item-row {
		display: grid;
		grid-template-columns: 2fr 1fr auto;
		gap: 0.5rem;
		align-items: end;
		margin-bottom: 0.5rem;
	}

	.cs-modal-footer {
		display: flex;
		justify-content: flex-end;
		padding-top: 1.5rem;
		border-top: 1px solid var(--cs-border);
	}
</style>

<section class="client-portal">
	<div class="cs-shell" id="cs-shell">
		<header class="cs-topbar cs-animate" data-delay="1">
			<div class="cs-brand">
				<span class="cs-eyebrow">Cold Storage Network</span>
				<h1 class="cs-title">Client Operations Portal</h1>
				<p class="cs-subtitle">
					A full-width workspace for stock visibility, movement tracking, billing insight, and report access.
				</p>
				<div class="cs-system-state is-loading" id="cs-system-state">
					<span class="cs-system-dot" aria-hidden="true"></span>
					<span id="cs-system-state-text">Initializing live snapshot...</span>
				</div>
			</div>
			<div class="cs-controls">
				<div class="cs-field d-none" id="cs-customer-filter-wrap">
					<label class="cs-label" for="cs-customer-filter">Customer Scope</label>
					<select class="cs-select" id="cs-customer-filter"></select>
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-global-search">Global Search</label>
					<input class="cs-input" id="cs-global-search" type="search"
						placeholder="Search across all portal sections" />
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-new-request-btn">Actions</label>
					<button class="cs-btn cs-btn-primary" id="cs-new-request-btn" type="button">
						<span class="cs-btn-dot" aria-hidden="true"></span>
						New Request
					</button>
				</div>
				<div class="cs-field">
					<label class="cs-label" for="cs-refresh-btn">Data Controls</label>
					<div class="d-flex gap-2">
						<button class="cs-btn flex-grow-1" id="cs-refresh-btn" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Refresh
						</button>
						<div class="cs-refresh-meta flex-grow-1" id="cs-last-refresh">Loading...</div>
					</div>
				</div>
			</div>
		</header>

		<nav class="cs-nav cs-animate" data-delay="2" aria-label="Portal sections">
			<button class="cs-chip cs-chip-active" type="button" data-section="stock" data-jump="#cs-section-stock"
				aria-current="true">
				Stock
				<span class="cs-chip-count" id="cs-nav-stock-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="movements" data-jump="#cs-section-movements">
				Movements
				<span class="cs-chip-count" id="cs-nav-movement-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="invoices" data-jump="#cs-section-invoices">
				Invoices
				<span class="cs-chip-count" id="cs-nav-invoice-count">0</span>
			</button>
			<button class="cs-chip" type="button" data-section="reports" data-jump="#cs-section-reports">
				Reports
				<span class="cs-chip-count" id="cs-nav-report-count">0</span>
			</button>
			<button class="cs-chip cs-chip-main" type="button" id="cs-focus-search-btn">Focus Search (/)</button>
		</nav>

		<section class="cs-kpi-grid cs-animate" data-delay="2">
			<div class="cs-kpi">
				<div class="cs-kpi-label">Stock Rows</div>
				<div class="cs-kpi-value" id="cs-kpi-stock-rows">0</div>
			</div>
			<div class="cs-kpi">
				<div class="cs-kpi-label">Total Quantity</div>
				<div class="cs-kpi-value" id="cs-kpi-total-qty">0</div>
			</div>
			<div class="cs-kpi">
				<div class="cs-kpi-label">Movements</div>
				<div class="cs-kpi-value" id="cs-kpi-movements">0</div>
			</div>
			<div class="cs-kpi">
				<div class="cs-kpi-label">Invoices</div>
				<div class="cs-kpi-value" id="cs-kpi-invoices">0</div>
			</div>
			<div class="cs-kpi">
				<div class="cs-kpi-label">Outstanding</div>
				<div class="cs-kpi-value" id="cs-kpi-outstanding">0</div>
			</div>
			<div class="cs-kpi">
				<div class="cs-kpi-label">Reports</div>
				<div class="cs-kpi-value" id="cs-kpi-reports">0</div>
			</div>
		</section>

		<div class="cs-banner cs-banner-info d-none cs-animate" data-delay="2" id="cs-customers"></div>
		<div class="cs-banner cs-banner-warn d-none cs-animate" data-delay="2" id="cs-empty-state">
			No customers found for this user scope.
		</div>

		<section class="cs-charts-grid cs-animate" data-delay="3" id="cs-dashboard-charts">
			<article class="cs-chart-card">
				<h3 class="cs-chart-title">Stock Composition</h3>
				<div id="cs-chart-stock"></div>
			</article>
			<article class="cs-chart-card">
				<h3 class="cs-chart-title">Movement Trends (30 Days)</h3>
				<div id="cs-chart-movements"></div>
			</article>
		</section>

		<section class="cs-layout">
			<article class="cs-board cs-section cs-animate" data-delay="1" id="cs-section-stock" data-section="stock"
				data-span="6">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Current Stock</h2>
						<div class="cs-board-meta" id="cs-stock-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="stock" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools">
					<input class="cs-input cs-section-search" id="cs-stock-search" type="search"
						placeholder="Search customer, item, batch, warehouse" />
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-stock-table">
						<thead>
							<tr>
								<th>Customer</th>
								<th>Item</th>
								<th>Batch</th>
								<th>Warehouse</th>
								<th class="text-end">Qty</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="1" id="cs-section-movements"
				data-section="movements" data-span="6">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Recent Movements</h2>
						<div class="cs-board-meta" id="cs-movement-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="movements" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools d-flex gap-2 align-items-center flex-wrap">
					<input class="cs-input cs-section-search flex-grow-1" id="cs-movement-search" type="search"
						placeholder="Search movement type, document, customer..." />
					<div class="d-flex gap-2 align-items-center">
						<input class="cs-input" type="date" id="cs-mov-start" title="Start Date">
						<span class="cs-muted">-</span>
						<input class="cs-input" type="date" id="cs-mov-end" title="End Date">
					</div>
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-movement-table">
						<thead>
							<tr>
								<th>Date</th>
								<th>Type</th>
								<th>Document</th>
								<th>Customer</th>
								<th class="text-end">Qty</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="2" id="cs-section-invoices"
				data-section="invoices" data-span="12">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Invoices</h2>
						<div class="cs-board-meta" id="cs-invoice-count">0 rows</div>
					</div>
					<div class="cs-board-actions">
						<button class="cs-btn" data-download="invoices" type="button">
							<span class="cs-btn-dot" aria-hidden="true"></span>
							Download CSV
						</button>
					</div>
				</header>
				<div class="cs-tools d-flex flex-column gap-2">
					<input class="cs-input cs-section-search" id="cs-invoice-search" type="search"
						placeholder="Search invoice, customer, status, currency" />
					<div class="d-flex gap-2 flex-wrap" id="cs-invoice-filters">
						<button class="cs-chip cs-chip-active" type="button" data-status="">All</button>
						<button class="cs-chip" type="button" data-status="paid">Paid</button>
						<button class="cs-chip" type="button" data-status="pending">Pending</button>
						<button class="cs-chip" type="button" data-status="overdue">Overdue</button>
					</div>
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-invoice-table">
						<thead>
							<tr>
								<th>Invoice</th>
								<th>Date</th>
								<th>Due Date</th>
								<th>Customer</th>
								<th>Currency</th>
								<th class="text-end">Grand Total</th>
								<th class="text-end">Outstanding</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>

			<article class="cs-board cs-section cs-animate" data-delay="3" id="cs-section-reports"
				data-section="reports" data-span="12">
				<header class="cs-board-head">
					<div class="cs-board-head-main">
						<h2 class="cs-board-title">Reports</h2>
						<div class="cs-board-meta" id="cs-report-count">0 rows</div>
					</div>
				</header>
				<div class="cs-tools">
					<input class="cs-input cs-section-search" id="cs-report-search" type="search"
						placeholder="Search report name or description" />
				</div>
				<div class="cs-table-wrap">
					<table class="table cs-table" id="cs-report-table">
						<thead>
							<tr>
								<th>Report</th>
								<th>Description</th>
								<th class="text-end">Actions</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</article>
		</section>

		<div class="cs-modal-overlay d-none" id="cs-request-modal">
			<div class="cs-modal">
				<div class="cs-modal-header">
					<h3 class="cs-modal-title">New Service Request</h3>
					<button class="cs-btn cs-btn-sm" id="cs-modal-close" type="button">Close</button>
				</div>
				<div class="cs-modal-body">
					<div class="cs-field">
						<label class="cs-label">Request Type</label>
						<select class="cs-select" id="cs-req-type">
							<option value="Inward">Inward (Receipt)</option>
							<option value="Outward">Outward (Dispatch)</option>
						</select>
					</div>
					<div class="cs-field">
						<label class="cs-label">Required Date</label>
						<input class="cs-input" type="date" id="cs-req-date">
					</div>
					<div class="cs-field">
						<label class="cs-label">Items</label>
						<div class="cs-req-items" id="cs-req-items">
							<!-- Items will be added here -->
						</div>
						<button class="cs-btn cs-btn-sm mt-2" id="cs-add-item-btn" type="button">+ Add Item</button>
					</div>
				</div>
				<div class="cs-modal-footer">
					<button class="cs-btn cs-btn-primary" id="cs-submit-request-btn" type="button">Submit
						Request</button>
				</div>
				<datalist id="item-list"></datalist>
			</div>
		</div>
	</div>
</section>

<script>
	(() => {
		const snapshotMethod = "cold_storage.api.client_portal.get_portal_snapshot";
		const downloadMethods = {
			stock: "/api/method/cold_storage.api.client_portal.download_stock_csv",
			movements: "/api/method/cold_storage.api.client_portal.download_movements_csv",
			invoices: "/api/method/cold_storage.api.client_portal.download_invoices_csv",
		};

		let selectedCustomer = "";
		const state = {
			customers: [],
			stock: [],
			movements: [],
			invoices: [],
			reports: [],
		};

		const searchTerms = {
			global: "",
			stock: "",
			movements: "",
			invoices: "",
			reports: "",
		};

		const shell = document.getElementById("cs-shell");
		const stockBody = document.querySelector("#cs-stock-table tbody");
		const movementBody = document.querySelector("#cs-movement-table tbody");
		const invoiceBody = document.querySelector("#cs-invoice-table tbody");
		const reportBody = document.querySelector("#cs-report-table tbody");

		const stockCount = document.getElementById("cs-stock-count");
		const movementCount = document.getElementById("cs-movement-count");
		const invoiceCount = document.getElementById("cs-invoice-count");
		const reportCount = document.getElementById("cs-report-count");

		const navStockCount = document.getElementById("cs-nav-stock-count");
		const navMovementCount = document.getElementById("cs-nav-movement-count");
		const navInvoiceCount = document.getElementById("cs-nav-invoice-count");
		const navReportCount = document.getElementById("cs-nav-report-count");

		const customersBanner = document.getElementById("cs-customers");
		const emptyState = document.getElementById("cs-empty-state");
		const systemState = document.getElementById("cs-system-state");
		const systemStateText = document.getElementById("cs-system-state-text");
		const refreshLabel = document.getElementById("cs-last-refresh");
		const refreshButton = document.getElementById("cs-refresh-btn");
		const focusSearchButton = document.getElementById("cs-focus-search-btn");
		const customerFilterWrap = document.getElementById("cs-customer-filter-wrap");
		const customerFilter = document.getElementById("cs-customer-filter");
		const globalSearchInput = document.getElementById("cs-global-search");

		const sectionButtons = Array.from(document.querySelectorAll(".cs-chip[data-jump]"));
		const sections = Array.from(document.querySelectorAll(".cs-section[data-section]"));

		const searchInputs = {
			stock: document.getElementById("cs-stock-search"),
			movements: document.getElementById("cs-movement-search"),
			invoices: document.getElementById("cs-invoice-search"),
			reports: document.getElementById("cs-report-search"),
		};

		const sectionSearchInputs = {
			stock: searchInputs.stock,
			movements: searchInputs.movements,
			invoices: searchInputs.invoices,
			reports: searchInputs.reports,
		};

		const kpiStockRows = document.getElementById("cs-kpi-stock-rows");
		const kpiTotalQty = document.getElementById("cs-kpi-total-qty");
		const kpiMovements = document.getElementById("cs-kpi-movements");
		const kpiInvoices = document.getElementById("cs-kpi-invoices");
		const kpiOutstanding = document.getElementById("cs-kpi-outstanding");
		const kpiReports = document.getElementById("cs-kpi-reports");

		const escapeHtml = (value) => {
			const text = String(value ?? "");
			return text
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#39;");
		};

		const toSearch = (value) => String(value ?? "").trim().toLowerCase();

		const formatDate = (value) => {
			if (!value) return "";
			const date = new Date(value);
			return Number.isNaN(date.getTime()) ? value : date.toLocaleDateString();
		};

		const formatNumber = (value) => {
			const num = Number(value || 0);
			return Number.isFinite(num)
				? num.toLocaleString(undefined, { maximumFractionDigits: 3 })
				: "0";
		};

		const formatMoney = (value) => {
			const num = Number(value || 0);
			if (!Number.isFinite(num)) return "0";
			return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
		};

		const setSystemState = (text, stateClass) => {
			if (systemStateText) {
				systemStateText.textContent = text;
			}
			if (!systemState) return;
			systemState.classList.remove("is-loading", "is-live", "is-error");
			if (stateClass) {
				systemState.classList.add(stateClass);
			}
		};

		const setRefreshButton = (label, isLoading) => {
			if (!refreshButton) return;
			refreshButton.disabled = Boolean(isLoading);
			refreshButton.innerHTML = `<span class="cs-btn-dot" aria-hidden="true"></span>${escapeHtml(label)}`;
		};

		const setPanelCount = (element, visibleRows, totalRows) => {
			if (!element) return;
			if (!totalRows) {
				element.textContent = "0 rows";
				return;
			}
			if (visibleRows === totalRows) {
				element.textContent = `${formatNumber(totalRows)} rows`;
				return;
			}
			element.textContent = `${formatNumber(visibleRows)} of ${formatNumber(totalRows)} rows`;
		};

		const setNavCount = (element, value) => {
			if (!element) return;
			element.textContent = formatNumber(value || 0);
		};

		const setActiveSection = (key) => {
			sectionButtons.forEach((button) => {
				const isActive = (button.getAttribute("data-section") || "") === key;
				button.classList.toggle("cs-chip-active", isActive);
				button.setAttribute("aria-current", isActive ? "true" : "false");
			});
		};

		const observeSections = () => {
			if (!sections.length || typeof IntersectionObserver === "undefined") return;
			const observer = new IntersectionObserver(
				(entries) => {
					const visible = entries
						.filter((entry) => entry.isIntersecting)
						.sort((a, b) => b.intersectionRatio - a.intersectionRatio);
					if (!visible.length) return;
					const key = visible[0].target.getAttribute("data-section") || "";
					if (key) setActiveSection(key);
				},
				{
					rootMargin: "-30% 0px -55% 0px",
					threshold: [0.2, 0.4, 0.6],
				}
			);
			sections.forEach((section) => observer.observe(section));
		};

		const isTypingContext = (element) => {
			if (!element) return false;
			const tagName = element.tagName || "";
			return (
				element.isContentEditable
				|| tagName === "INPUT"
				|| tagName === "TEXTAREA"
				|| tagName === "SELECT"
			);
		};

		const nearestSectionKey = () => {
			if (!sections.length) return "stock";
			const anchor = 150;
			let currentKey = sections[0].getAttribute("data-section") || "stock";
			let smallestGap = Number.POSITIVE_INFINITY;
			sections.forEach((section) => {
				const rect = section.getBoundingClientRect();
				const gap = Math.abs(rect.top - anchor);
				if (gap < smallestGap) {
					smallestGap = gap;
					currentKey = section.getAttribute("data-section") || currentKey;
				}
			});
			return currentKey;
		};

		const focusSectionSearch = (sectionKey) => {
			const input = sectionSearchInputs[sectionKey] || globalSearchInput;
			if (!input) return;
			input.focus({ preventScroll: true });
			input.select();
		};

		const linkCell = (value, route) => {
			if (!value) return "";
			if (!route) return escapeHtml(value);
			return `<a class="cs-link" href="${encodeURI(route)}" target="_blank" rel="noopener">${escapeHtml(value)}</a>`;
		};

		const emptyRow = (columns, label = "No records") =>
			`<tr><td colspan="${columns}" class="cs-empty-cell">${label}</td></tr>`;

		const getStatusClass = (value) => {
			const status = toSearch(value);
			if (!status) return "cs-pill--neutral";
			if (
				status.includes("paid")
				|| status.includes("completed")
				|| status.includes("success")
				|| status.includes("active")
			) {
				return "cs-pill--ok";
			}
			if (
				status.includes("overdue")
				|| status.includes("failed")
				|| status.includes("cancel")
				|| status.includes("rejected")
			) {
				return "cs-pill--danger";
			}
			if (
				status.includes("draft")
				|| status.includes("pending")
				|| status.includes("unpaid")
				|| status.includes("partly")
			) {
				return "cs-pill--warn";
			}
			return "cs-pill--neutral";
		};

		const statusPill = (value) => {
			const text = value || "Unknown";
			return `<span class="cs-pill ${getStatusClass(text)}">${escapeHtml(text)}</span>`;
		};

		const movementTypePill = (value) => {
			const type = value || "Movement";
			const search = toSearch(type);
			let className = "cs-pill--neutral";
			if (search.includes("inward")) className = "cs-pill--ok";
			if (search.includes("outward")) className = "cs-pill--warn";
			return `<span class="cs-pill ${className}">${escapeHtml(type)}</span>`;
		};

		const matches = (row, fields, term) => {
			if (!term) return true;
			return fields.some((field) => toSearch(row[field]).includes(term));
		};

		const filterRows = (rows, term, fields) => rows.filter((row) => (
			matches(row, fields, term)
			&& matches(row, fields, searchTerms.global)
		));

		const updateCustomerFilter = (customers, selected) => {
			if (!customerFilterWrap || !customerFilter) return;
			if (!customers.length || customers.length === 1) {
				customerFilterWrap.classList.add("d-none");
				customerFilter.innerHTML = "";
				return;
			}

			customerFilterWrap.classList.remove("d-none");
			customerFilter.innerHTML = "";

			const allOption = document.createElement("option");
			allOption.value = "";
			allOption.textContent = "All Customers";
			customerFilter.appendChild(allOption);

			customers.forEach((customer) => {
				const option = document.createElement("option");
				option.value = customer;
				option.textContent = customer;
				customerFilter.appendChild(option);
			});

			const target = customers.includes(selected) ? selected : "";
			customerFilter.value = target;
		};

		const updateKpis = (stock, movements, invoices, reports) => {
			const totalQty = stock.reduce((sum, row) => sum + Number(row.qty || 0), 0);
			const totalOutstanding = invoices.reduce((sum, row) => sum + Number(row.outstanding_amount || 0), 0);

			kpiStockRows.textContent = formatNumber(stock.length);
			kpiTotalQty.textContent = formatNumber(totalQty);
			kpiMovements.textContent = formatNumber(movements.length);
			kpiInvoices.textContent = formatNumber(invoices.length);
			kpiOutstanding.textContent = formatMoney(totalOutstanding);
			kpiReports.textContent = formatNumber(reports.length);

			setNavCount(navStockCount, stock.length);
			setNavCount(navMovementCount, movements.length);
			setNavCount(navInvoiceCount, invoices.length);
			setNavCount(navReportCount, reports.length);
		};

		const renderStock = (rows, totalRows) => {
			setPanelCount(stockCount, rows.length, totalRows);
			if (!rows.length) {
				stockBody.innerHTML = emptyRow(5, totalRows ? "No records match your search" : "No records");
				return;
			}
			stockBody.innerHTML = rows
				.map(
					(row) => `
				<tr>
					<td>${escapeHtml(row.customer || "")}</td>
					<td>${escapeHtml(row.item_name || row.item_code || "")}</td>
					<td>${escapeHtml(row.batch_no || "")}</td>
					<td>${escapeHtml(row.warehouse || "")}</td>
					<td class="text-end">${formatNumber(row.qty)}</td>
				</tr>`
				)
				.join("");
		};

		const renderMovements = (rows, totalRows) => {
			setPanelCount(movementCount, rows.length, totalRows);
			if (!rows.length) {
				movementBody.innerHTML = emptyRow(5, totalRows ? "No records match your search" : "No records");
				return;
			}
			movementBody.innerHTML = rows
				.map(
					(row) => `
				<tr>
					<td>${formatDate(row.posting_date)}</td>
					<td>${movementTypePill(row.movement_type || "")}</td>
					<td>${escapeHtml(row.document_name || "")}</td>
					<td>${escapeHtml(row.customer || "")}</td>
					<td class="text-end">${formatNumber(row.qty)}</td>
				</tr>`
				)
				.join("");
		};

		const renderInvoices = (rows, totalRows) => {
			setPanelCount(invoiceCount, rows.length, totalRows);
			if (!rows.length) {
				invoiceBody.innerHTML = emptyRow(8, totalRows ? "No records match your search" : "No records");
				return;
			}
			invoiceBody.innerHTML = rows
				.map(
					(row) => `
				<tr>
					<td>${linkCell(row.name, row.route)}</td>
					<td>${formatDate(row.posting_date)}</td>
					<td>${formatDate(row.due_date)}</td>
					<td>${escapeHtml(row.customer || "")}</td>
					<td>${escapeHtml(row.currency || "")}</td>
					<td class="text-end">${formatMoney(row.grand_total)}</td>
					<td class="text-end">${formatMoney(row.outstanding_amount)}</td>
					<td>${statusPill(row.status || "")}</td>
				</tr>`
				)
				.join("");
		};

		const renderReports = (rows, totalRows) => {
			setPanelCount(reportCount, rows.length, totalRows);
			if (!rows.length) {
				reportBody.innerHTML = emptyRow(
					3,
					totalRows ? "No reports match your search" : "No reports available for this user"
				);
				return;
			}
			reportBody.innerHTML = rows
				.map((row) => {
					const openRoute = row.route || "";
					const pdfRoute = row.pdf_route || _getReportPdfRoute(row.report_name || "", selectedCustomer);
					return `
					<tr>
						<td>${linkCell(row.label || row.report_name || "", openRoute)}</td>
						<td>${escapeHtml(row.description || "")}</td>
						<td class="text-end">
							<span class="cs-actions">
								<a
									class="cs-btn"
									href="${encodeURI(openRoute || "#")}"
									target="_blank"
									rel="noopener"
									aria-disabled="${openRoute ? "false" : "true"}"
								>
									<span class="cs-btn-dot" aria-hidden="true"></span>
									Open
								</a>
								<a
									class="cs-btn"
									href="${encodeURI(pdfRoute || "#")}"
									target="_blank"
									rel="noopener"
									aria-disabled="${pdfRoute ? "false" : "true"}"
								>
									<span class="cs-btn-dot" aria-hidden="true"></span>
									PDF
								</a>
							</span>
						</td>
					</tr>`;
				})
				.join("");
		};

		const movStartInput = document.getElementById("cs-mov-start");
		const movEndInput = document.getElementById("cs-mov-end");

		const filterMovementsByDate = (rows) => {
			const start = movStartInput.value ? new Date(movStartInput.value) : null;
			const end = movEndInput.value ? new Date(movEndInput.value) : null;

			if (!start && !end) return rows;

			return rows.filter(row => {
				const date = new Date(row.posting_date);
				if (start && date < start) return false;
				if (end && date > end) return false;
				return true;
			});
		};

		const invoiceFilters = document.getElementById("cs-invoice-filters");
		let activeInvoiceFilter = "";

		const filterInvoicesByStatus = (rows) => {
			if (!activeInvoiceFilter) return rows;
			return rows.filter(row => {
				const status = toSearch(row.status);
				return status.includes(activeInvoiceFilter);
			});
		};

		const renderAll = () => {
			const stockRows = filterRows(state.stock, searchTerms.stock, [
				"customer", "item_name", "item_code", "batch_no", "warehouse"
			]);

			let movementRows = filterRows(state.movements, searchTerms.movements, [
				"movement_type", "document_name", "customer", "reference"
			]);
			movementRows = filterMovementsByDate(movementRows);

			let invoiceRows = filterRows(state.invoices, searchTerms.invoices, [
				"name", "posting_date", "due_date", "customer", "currency", "status"
			]);
			invoiceRows = filterInvoicesByStatus(invoiceRows);

			// ... existing rendering ...
			updateKpis(stockRows, movementRows, invoiceRows, state.reports); // Use filtered rows for KPIs? Maybe total is better.
			// Let's use total for KPIs to show "Overview", but filtered for table
			// Actually KPIs usually reflect view. Let's keep it simple for now.

			renderStock(stockRows, state.stock.length);
			renderMovements(movementRows, state.movements.length);
			renderInvoices(invoiceRows, state.invoices.length);
			renderReports(filterRows(state.reports, searchTerms.reports, ["label", "report_name", "description"]), state.reports.length);
		};

		if (movStartInput) movStartInput.addEventListener("change", renderAll);
		if (movEndInput) movEndInput.addEventListener("change", renderAll);

		if (invoiceFilters) {
			invoiceFilters.addEventListener("click", (e) => {
				const btn = e.target.closest(".cs-chip");
				if (!btn) return;

				// Update active state
				invoiceFilters.querySelectorAll(".cs-chip").forEach(b => b.classList.remove("cs-chip-active"));
				btn.classList.add("cs-chip-active");

				activeInvoiceFilter = btn.getAttribute("data-status") || "";
				renderAll();
			});
		}

		const getDownloadEndpoint = (key) => {
			const endpoint = downloadMethods[key];
			if (!endpoint) return "";
			if (!selectedCustomer) return endpoint;
			const query = new URLSearchParams({ customer: selectedCustomer }).toString();
			return `${endpoint}?${query}`;
		};

		const _getReportPdfRoute = (reportName, customer = "") => {
			const cleanReportName = String(reportName || "").trim();
			if (!cleanReportName) return "";
			const queryArgs = new URLSearchParams({ report_name: cleanReportName });
			if (customer) {
				queryArgs.set("customer", customer);
			}
			return `/api/method/cold_storage.api.client_portal.download_report_pdf?${queryArgs.toString()}`;
		};

		const callApi = async (method, args = {}) => {
			if (typeof frappe !== "undefined" && frappe.call) {
				return frappe.call({ method, args });
			}

			const query = new URLSearchParams(args).toString();
			const response = await fetch(`/api/method/${method}${query ? `?${query}` : ""}`, {
				method: "GET",
				credentials: "include",
			});
			if (!response.ok) {
				throw new Error("Request failed");
			}
			return response.json();
		};

		const loadSnapshot = async () => {
			setRefreshButton("Refreshing...", true);
			setSystemState("Refreshing live snapshot...", "is-loading");

			try {
				const response = await callApi(snapshotMethod, {
					limit: 25,
					customer: selectedCustomer,
				});

				const data = response.message || {};
				const availableCustomers = data.available_customers || data.customers || [];
				selectedCustomer = data.selected_customer || "";
				updateCustomerFilter(availableCustomers, selectedCustomer);

				state.customers = data.customers || [];
				state.stock = data.stock || [];
				state.movements = data.movements || [];
				state.invoices = data.invoices || [];
				state.reports = data.reports || [];
				state.analytics = data.analytics || {};

				if (state.customers.length) {
					customersBanner.classList.remove("d-none");
					if (selectedCustomer) {
						customersBanner.textContent = `Customer Scope: ${selectedCustomer}`;
					} else {
						const preview = state.customers.length > 10
							? `${state.customers.slice(0, 10).join(", ")} (+${state.customers.length - 10} more)`
							: state.customers.join(", ");
						customersBanner.textContent = `Customer Scope: ${preview}`;
					}
					emptyState.classList.add("d-none");
				} else {
					customersBanner.classList.add("d-none");
					emptyState.classList.remove("d-none");
				}

				renderAll();
				renderCharts(state.analytics);
				refreshLabel.textContent = `Last refresh: ${new Date().toLocaleString()}`;
				setSystemState("Live snapshot synced", "is-live");
				shell.classList.add("cs-loaded");
			} catch (error) {
				refreshLabel.textContent = "Unable to load data.";
				setSystemState("Snapshot unavailable", "is-error");
				if (typeof frappe !== "undefined" && frappe.msgprint) {
					frappe.msgprint({
						title: "Client Portal",
						indicator: "red",
						message: "Could not load client portal data.",
					});
				}
			} finally {
				setRefreshButton("Refresh", false);
			}
		};

		if (customerFilter) {
			customerFilter.addEventListener("change", () => {
				selectedCustomer = customerFilter.value || "";
				loadSnapshot();
			});
		}

		if (globalSearchInput) {
			globalSearchInput.addEventListener("input", () => {
				searchTerms.global = toSearch(globalSearchInput.value);
				renderAll();
			});
		}

		Object.entries(searchInputs).forEach(([key, input]) => {
			if (!input) return;
			input.addEventListener("input", () => {
				searchTerms[key] = toSearch(input.value);
				renderAll();
			});
		});

		sectionButtons.forEach((button) => {
			button.addEventListener("click", () => {
				const selector = button.getAttribute("data-jump") || "";
				const target = selector ? document.querySelector(selector) : null;
				setActiveSection(button.getAttribute("data-section") || "");
				if (!target) return;
				target.scrollIntoView({ behavior: "smooth", block: "start" });
			});
		});

		document.addEventListener("keydown", (event) => {
			if (isTypingContext(event.target)) return;
			if (event.key !== "/") return;
			event.preventDefault();
			focusSectionSearch(nearestSectionKey());
		});

		if (focusSearchButton) {
			focusSearchButton.addEventListener("click", () => {
				focusSectionSearch(nearestSectionKey());
			});
		}

		if (refreshButton) {
			refreshButton.addEventListener("click", () => {
				loadSnapshot();
			});
		}

		document.querySelectorAll("[data-download]").forEach((button) => {
			button.addEventListener("click", () => {
				const key = button.getAttribute("data-download") || "";
				const endpoint = getDownloadEndpoint(key);
				if (!endpoint) return;
				window.open(endpoint, "_blank", "noopener");
			});
		});

		/* Chart Rendering Logic */
		const renderCharts = (analytics) => {
			if (!analytics || !window.frappe || !window.frappe.Chart) return;

			// Stock Composition Chart
			new frappe.Chart("#cs-chart-stock", {
				data: {
					labels: analytics.stock_composition.map(i => i.name),
					datasets: [{ values: analytics.stock_composition.map(i => i.value) }]
				},
				type: 'donut',
				height: 250,
				colors: ['#0d9488', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4']
			});

			// Movement Trends Chart
			new frappe.Chart("#cs-chart-movements", {
				data: analytics.movement_trends,
				type: 'bar',
				height: 250,
				colors: ['#0d9488', '#f59e0b']
			});
		};

		// Initialize with data
		renderCharts(state.analytics);

		// Request Modal Logic
		const requestModal = document.getElementById("cs-request-modal");
		const newRequestBtn = document.getElementById("cs-new-request-btn");
		const closeModalBtn = document.getElementById("cs-modal-close");
		const reqTypeInput = document.getElementById("cs-req-type");
		const reqDateInput = document.getElementById("cs-req-date");
		const reqItemsContainer = document.getElementById("cs-req-items");
		const addItemBtn = document.getElementById("cs-add-item-btn");
		const submitRequestBtn = document.getElementById("cs-submit-request-btn");
		const itemList = document.getElementById("item-list");

		const updateItemList = async () => {
			if (!selectedCustomer) return;
			const type = reqTypeInput.value;
			itemList.innerHTML = ""; // Clear existing options

			try {
				const res = await callApi("cold_storage.api.client_portal.get_available_items", {
					customer: selectedCustomer,
					request_type: type
				});
				const items = res.message || [];
				items.forEach(code => {
					const option = document.createElement("option");
					option.value = code;
					itemList.appendChild(option);
				});
			} catch (e) {
				console.error("Failed to fetch available items", e);
			}
		};

		const toggleModal = (show) => {
			if (!requestModal) return;
			requestModal.classList.toggle("d-none", !show);
			if (show) {
				// Reset form
				reqDateInput.value = new Date().toISOString().split("T")[0];
				reqItemsContainer.innerHTML = "";
				addRequestItemRow();
				updateItemList(); // Fetch items
			}
		};

		if (reqTypeInput) {
			reqTypeInput.addEventListener("change", updateItemList);
		}

		const addRequestItemRow = () => {
			const row = document.createElement("div");
			row.className = "cs-req-item-row";
			row.innerHTML = `
				<div class="cs-field">
					<input class="cs-input item-code" placeholder="Item Code" list="item-list">
				</div>
				<div class="cs-field">
					<input class="cs-input item-qty" type="number" placeholder="Qty" step="0.01">
				</div>
				<button class="cs-btn cs-btn-sm remove-row" type="button">&times;</button>
			`;

			row.querySelector(".remove-row").addEventListener("click", () => {
				row.remove();
			});

			// Simple item details fetch on blur
			const itemInput = row.querySelector(".item-code");
			itemInput.addEventListener("change", async () => {
				if (!itemInput.value) return;
				try {
					const res = await callApi("cold_storage.api.client_portal.get_item_details", { item_code: itemInput.value });
					if (res.message) {
						itemInput.title = res.message.item_name || "";
					}
				} catch (e) { console.error(e); }
			});

			reqItemsContainer.appendChild(row);
		};

		const submitServiceRequest = async () => {
			const type = reqTypeInput.value;
			const date = reqDateInput.value;
			const items = [];

			document.querySelectorAll(".cs-req-item-row").forEach(row => {
				const code = row.querySelector(".item-code").value;
				const qty = row.querySelector(".item-qty").value;
				if (code && qty > 0) {
					items.push({ item_code: code, qty: qty });
				}
			});

			if (!items.length) {
				alert("Please add at least one item.");
				return;
			}

			if (!selectedCustomer) {
				alert("No customer selected.");
				return;
			}

			submitRequestBtn.disabled = true;
			submitRequestBtn.textContent = "Submitting...";

			try {
				const res = await callApi("cold_storage.api.client_portal.create_service_request", {
					request_type: type,
					customer: selectedCustomer,
					items: items,
					required_date: date
				});

				alert(res.message || "Request created!");
				toggleModal(false);
				loadSnapshot(); // Refresh data
			} catch (error) {
				console.error(error);
				alert("Failed to submit request: " + error.message);
			} finally {
				submitRequestBtn.disabled = false;
				submitRequestBtn.textContent = "Submit Request";
			}
		};

		if (newRequestBtn) newRequestBtn.addEventListener("click", () => toggleModal(true));
		if (closeModalBtn) closeModalBtn.addEventListener("click", () => toggleModal(false));
		if (addItemBtn) addItemBtn.addEventListener("click", addRequestItemRow);
		if (submitRequestBtn) submitRequestBtn.addEventListener("click", submitServiceRequest);

		setActiveSection("stock");
		observeSections();
		loadSnapshot();
	})();
</script>
{% endblock %}